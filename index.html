<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é«˜å¾·åœ°å›¾å‘¨è¾¹æœç´¢</title>
    <meta property="og:title" content="é«˜å¾·åœ°å›¾å‘¨è¾¹æœç´¢" />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://qinlang699.cn/" />
    <meta property="og:image" content="https://img.icons8.com/color/480/map-marker.png" />
    <meta property="og:description" content="ä¸€ä¸ªå¿«é€Ÿã€å¼ºå¤§çš„é«˜å¾·åœ°å›¾å‘¨è¾¹ä¿¡æ¯æœç´¢å·¥å…·ï¼Œå¸®æ‚¨è½»æ¾æ‰¾åˆ°ç›®çš„åœ°ã€‚" />
    
    <script src="https://webapi.amap.com/maps?v=2.0&key=dcfb48c0f9cb749e59c5031e83cb6e95&plugin=AMap.Geolocation"></script>

    <style>
        /* ===============================================
           å…¨å±€æ ·å¼è®¾ç½®
           =============================================== */
        ::-webkit-scrollbar {
            width: 12px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #a9a9a9;
            border-radius: 6px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        html {
            scrollbar-width: auto;
            scrollbar-color: #a9a9a9 #f1f1f1;
            overflow-y: scroll;
            -webkit-overflow-scrolling: touch;
        }
        
        * {
            -webkit-tap-highlight-color: transparent !important;
            outline: none !important;
        }
        
        :root {
            --lightbox-edge-area-size: 80px;
        }
        
        /* ===============================================
           åŸºç¡€å¸ƒå±€æ ·å¼
           =============================================== */
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            min-height: 100vh;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
        }
        
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-width: 1200px;
            margin: 0 auto;
            flex: 1;
            display: flex;
            flex-direction: column;
            width: 100%;
            box-sizing: border-box;
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        
        /* ===============================================
           æœç´¢è¡¨å•æ ·å¼
           =============================================== */
        .search-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.08);
            transition: box-shadow 0.3s ease;
        }
        
        /* ç§»åŠ¨ç«¯ä¸‰è¡Œå¸ƒå±€æ ·å¼ */
        .mobile-triple-layout {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        /* ç¬¬ä¸€è¡Œï¼šæ ‡ç­¾è¡Œ */
        .mobile-labels-row {
            display: flex;
            justify-content: space-evenly;
            margin: 0;
            padding: 0;
            gap: 25%;
        }
        
        .mobile-label-left {
            text-align: center;
            margin: 0;
            padding: 0;
            white-space: nowrap;
        }
        
        .mobile-label-right {
            text-align: center;
            margin: 0;
            padding: 0;
            white-space: nowrap;
        }
        
        /* ç¬¬äºŒè¡Œï¼šè¾“å…¥æ¡†è¡Œ */
        .mobile-input-row {
            width: 100%;
            margin: 0;
            padding: 0;
        }
        
        .mobile-input-row input {
            width: 100%;
            box-sizing: border-box;
            margin: 0;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        /* ç¬¬ä¸‰è¡Œï¼šæŒ‰é’®è¡Œ */
        .mobile-buttons-row {
            display: flex;
            justify-content: space-around;
            margin: 0;
            padding: 0;
        }
        
        .mobile-button-left {
            width: 30%;
            margin: 0;
            padding: 0;
        }
        
        .mobile-button-right {
            width: 30%;
            margin: 0;
            padding: 0;
        }
        
        .mobile-buttons-row button {
            width: 100%;
            padding: 12px 8px;
            font-size: 14px;
            white-space: nowrap;
            text-align: center;
        }
        
        .mobile-triple-layout label {
            margin: 0;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: bold;
            color: #555;
            display: block;
        }
        
        .search-form:hover {
            box-shadow: 0 6px 12px rgba(0,0,0,0.12);
        }
        
        #locationStatus {
            text-align: left;
        }
        
        .form-group {
            margin-bottom: 15px;
            text-align: left;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        
        input[type="text"], input[type="number"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }
        
        #radius, .input-stepper {
            max-width: 120%;
        }

        #radius, #totalCount {
            padding-top: 14px;
            padding-bottom: 14px;
        }
        
        .form-row {
            display: flex;
            gap: 15px;
        }
        
        .form-row.form-row-tight {
            justify-content: center;
            gap: 20px;
        }

        .form-row.form-row-tight .form-group {
            flex: none;
        }

        .form-row .form-group {
            flex: 1;
        }
        
        /* ===============================================
           æŒ‰é’®æ ·å¼
           =============================================== */
        button {
            background: #1890ff;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
            transition: background-color 0.2s, transform 0.05s ease-out;
        }
        
        button:hover {
            background: #40a9ff;
        }
        
        button:active {
            background: #096dd9;
            transform: translateY(1px);
            transition: none;
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            border-color: #096dd9;
        }
        
        /* ===============================================
           ç»“æœæ˜¾ç¤ºåŒºåŸŸ
           =============================================== */
        .results {
            margin-top: 20px;
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .result-section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #e8e8e8;
            border-radius: 6px;
        }
        
        .result-section h3 {
            margin-top: 0;
            color: #1890ff;
        }
        
        /* ===============================================
           POIåˆ—è¡¨é¡¹æ ·å¼
           =============================================== */
        .poi-item {
            background: #fafafa;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 4px;
            border-left: 4px solid #1890ff;
            box-shadow: 0 3px 10px rgba(0,0,0,0.15), 0 1px 3px rgba(0,0,0,0.1);
            transition: box-shadow 0.3s ease;
            position: relative;
            min-height: 175px;
        }
        
        .poi-item:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.2), 0 3px 5px rgba(0,0,0,0.1);
        }
        
        .poi-name {
            display: flex;
            align-items: baseline;
            font-size: 16px;
            font-weight: bold;
            text-decoration: none;
            position: absolute;
            top: 15px;
            left: 15px;
            right: 175px;
            white-space: nowrap;
            z-index: 2;
        }
        
        .poi-number {
            color: #444;
            margin-right: 0.25em;
        }
        
        .poi-name-content {
            position: relative;
            color: #444;
            text-shadow: 
                1px 1px 0px #b0b0b0,
                2px 2px 1px rgba(59, 59, 59, 0.3);
            transition: transform 0.1s ease-out, text-shadow 0.1s ease-out;
            display: inline-block;
        }

        .poi-name-content::after {
            content: none;
            display: none;
        }

        .poi-name:hover .poi-name-content {
            color: #1890ff;
        }
        
        .poi-name-wrapper {
            position: relative;
        }

        .poi-name-wrapper::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            height: 2px;
            background: #444;
            box-shadow: 
                1px 1px 0px #b0b0b0,
                2px 2px 1px rgba(59, 59, 59, 0.3);
            z-index: 1;
        }

        .poi-name-content.selected {
            color: #1890ff;
        }
        
        .poi-name-content.pressed {
            transform: translate(0, 2px);
            text-shadow: 
                1px 1px 0px #f5f5f5,
                1px 1px 2px rgba(0,0,0,0.4);
        }
        
        .poi-info {
            color: #666;
            font-size: 14px;
            padding-right: 165px;
            margin-top: 25px;
            line-height: 1.6;
        }
        
        .poi-info-line {
            display: flex;
            align-items: flex-start;
            margin-bottom: 2px;
        }
        
        /* ===============================================
           åœ°å€æŒ‰é’®ä¸å¼¹çª—
           =============================================== */
        .address-btn {
            background: #1890ff;
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            text-decoration: none;
            font-size: 13px;
            line-height: 1.3;
            position: relative;
            top: -6px;
            left: 10px;
            transition: background-color 0.2s, transform 0.05s ease-out;
        }
        .address-btn:hover {
            background: #40a9ff;
            color: white;
        }
        .address-btn:active {
            background: #096dd9;
            transform: translateY(1px);
            transition: none;
        }
        .address-popover {
            position: fixed;
            background-color: #333;
            color: white;
            border-radius: 6px;
            padding: 10px 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 1010;
            max-width: 80vw;
            font-size: 14px;
            line-height: 1.5;
            user-select: all;
            -webkit-user-select: all;
            touch-action: none;
        }
        
        .copy-toast {
            position: fixed;
            bottom: 10%;
            left: 50%;
            transform: translateX(-50%);
            background-color: transparent;
            color: black;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 16px;
            font-weight: bold;
            z-index: 1020;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            pointer-events: none;
            text-shadow: 0 0 5px rgba(255,255,255,0.7);
        }
        
        .copy-toast.show {
            opacity: 1;
        }

        .poi-info-label {
            flex-shrink: 0;
            white-space: nowrap;
            margin-right: 8px;
        }
        
        .poi-info code {
            word-break: break-all;
            white-space: pre-wrap;
            background-color: #f6f8fa;
            padding: 2px 4px;
            border-radius: 4px;
            font-size: 12px;
        }

        /* ===============================================
           çŠ¶æ€æ ·å¼ä¸æç¤º
           =============================================== */
        .location-choice {
            border: 1px solid #ddd;
            padding: 10px;
            margin-top: 10px;
            border-radius: 4px;
            cursor: pointer;
            background: #f9f9f9;
        }
        .location-choice:hover {
            background: #e9e9e9;
            border-color: #ccc;
        }
        
        .raw-data {
            background: #f6f8fa;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }
        
        .loading {
            text-align: center;
            color: #1890ff;
            font-size: 16px;
        }
        
        .error {
            color: #ff4d4f;
            background: #fff2f0;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #ffccc7;
        }
        
        .success {
            color: #52c41a;
            background: #f6ffed;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #b7eb8f;
        }
        
        .info-prompt {
            color: #1890ff;
            background: #e6f7ff;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #91d5ff;
        }

        .recommend-grid {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 2px 8px;
            align-items: center;
        }
        .recommend-grid .recommend-emoji {
            grid-row: 1 / span 2;
            font-size: 1.5em;
            align-self: center;
        }
        .recommend-grid .recommend-line-1,
        .recommend-grid .recommend-text {
            grid-column: 2;
        }
        
        /* ===============================================
           åˆ†ç±»å’Œæ’åºæŒ‰é’®
           =============================================== */
        .sort-buttons button.active {
            background-color: #096dd9;
            border-color: #096dd9;
        }
        
        .category-buttons {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 3px;
            margin-bottom: 15px;
        }

        .category-buttons button {
            background-color: #e6f7ff;
            color: #1890ff;
            border: 1px solid #91d5ff;
            margin: 0;
            padding: 4px 10px;
            font-size: 14px;
        }
        .category-buttons button:hover {
            background-color: #bae7ff;
        }

        /* ===============================================
           æ»šåŠ¨é¡¶éƒ¨æŒ‰é’®
           =============================================== */
        #scrollTopBtn {
            display: none;
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 99;
            border: none;
            outline: none;
            background-color: rgba(24, 144, 255, 0.7);
            color: white;
            cursor: pointer;
            padding: 15px;
            border-radius: 50%;
            font-size: 18px;
            line-height: 1;
            transition: background-color 0.3s, opacity 0.3s;
        }

        #scrollTopBtn:hover {
            background-color: rgba(24, 144, 255, 1);
        }

        /* ===============================================
           ç§»åŠ¨ç«¯å“åº”å¼æ ·å¼
           =============================================== */
        @media (max-width: 768px) {
            body {
                padding: 0;
            }

            .container {
                padding: 15px 0;
                border-radius: 0;
                box-shadow: none;
            }

            h1 {
                font-size: 24px;
                margin-bottom: 20px;
            }

            .form-row {
                flex-direction: row;
                gap: 10px;
                align-items: flex-start;
            }
            
            .form-row .form-group {
                flex: 1;
                min-width: 0;
                margin-bottom: 15px; 
            }
            
            .form-row label {
                font-size: 13px;
                white-space: nowrap;
            }
            .form-row input[type="number"] {
                padding: 8px 6px;
            }

            #searchLocationBtn, #searchBtn {
                width: auto;
                box-sizing: border-box;
            }

            .category-buttons {
                gap: 8px;
            }
            
            .category-row {
                display: contents;
            }
            
            .category-buttons button {
                margin: 0;
                padding: 8px 12px;
                font-size: 14px;
            }

            .results .result-section > div[style*="display: flex"] {
                flex-direction: column;
                gap: 15px;
            }
            
            .sort-buttons {
                justify-content: center;
                flex-wrap: wrap;
                gap: 10px;
            }

            .sort-buttons button {
                width: auto;
                margin-left: 0 !important;
            }
            
            .poi-item {
                padding: 15px;
                min-height: 175px;
            }

            .poi-name {
                font-size: 15px;
                padding-right: 145px;
            }
            
            .poi-info {
                font-size: 13px;
                padding-right: 160px;
            }
            
            .poi-item-photo {
                width: 120px;
                height: 120px;
                bottom: 15px;
                right: 15px;
                z-index: 5;
            }
            
            #scrollTopBtn {
                bottom: 20px;
                right: 20px;
                padding: 12px;
                font-size: 16px;
            }
        }

        @media (min-width: 769px) {
            .category-buttons {
                display: block; /* åœ¨ç”µè„‘ç«¯ï¼Œå®¹å™¨æœ¬èº«ä¸æ˜¯gridæˆ–flex */
                gap: 0;
            }

            .category-row {
                display: grid;
                gap: 10px;
                margin-bottom: 10px;
            }

            .category-row:last-child {
                margin-bottom: 0;
            }

            .category-row:nth-child(1) {
                grid-template-columns: repeat(9, 1fr); /* ç¬¬ä¸€è¡Œ9åˆ— */
            }

            .category-row:nth-child(2) {
                grid-template-columns: repeat(9, 1fr); /* ç¬¬äºŒè¡Œ9åˆ— */
            }

            /* Reposition lightbox close areas for desktop/landscape */
            .lightbox-close {
                top: 0;
                right: 0;
                left: auto;
                width: var(--lightbox-edge-area-size);
                height: 100%;
                padding: 20px 0; /* Adjust padding for vertical alignment */
                /* Use flexbox to better control the 'x' position */
                display: flex;
                align-items: flex-start;
                justify-content: center;
            }

            .lightbox-bottom-close {
                top: 0;
                left: 0;
                bottom: auto; /* Unset bottom positioning */
                width: var(--lightbox-edge-area-size);
                height: 100%;
            }
        }

        /* Styles for stepper buttons */
        .input-stepper {
            display: flex;
        }
        .input-stepper input[type="number"] {
            border-right: none;
            border-radius: 4px 0 0 4px;
            position: relative;
            /* Hide ugly default arrows */
            -moz-appearance: textfield;
        }
        .input-stepper input[type="number"]::-webkit-outer-spin-button,
        .input-stepper input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .stepper-buttons {
            display: flex;
            flex-direction: column;
            width: 40px; /* Width of the buttons area, increased from 30px */
            border: 1px solid #ddd;
            border-left: none;
            border-radius: 0 4px 4px 0;
        }
        
        .stepper-btn {
            background-color: #1890ff;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 10px;
            padding: 0;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            flex: 1; /* Each button takes half the available height */
            line-height: 0;
            transition: background-color 0.2s, transform 0.05s ease-out;
        }
        .stepper-btn:hover {
            background-color: #40a9ff;
        }
        
        .stepper-btn:active {
            background-color: #096dd9;
            transform: translateY(1px);
            transition: none;
        }
        
        #increaseBtn {
            border-bottom: 1px solid #40a9ff; /* Lighter separator for contrast */
            border-radius: 0;
        }
        
        #decreaseBtn {
            border-top: none;
            border-radius: 0;
        }

        /* Styles for the new photo gallery */
        .photo-gallery-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }

        .photo-gallery-container h2 {
            margin-top: 0;
            margin-bottom: 20px;
            color: #333;
            font-size: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        .photo-gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
        }

        .gallery-item {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            background-color: #f0f0f0;
            aspect-ratio: 1 / 1;
        }
        
        .gallery-item a {
            display: block;
            width: 100%;
            height: 100%;
        }

        .gallery-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
            transition: transform 0.3s ease;
        }
        
        .gallery-item:hover img {
            transform: scale(1.05);
        }

        .gallery-item .poi-name-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
            color: white;
            padding: 20px 8px 8px 8px;
            font-size: 13px;
            text-align: left;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            transition: opacity 0.3s ease;
        }

        .poi-item-photo {
            position: absolute;
            bottom: 15px;
            right: 15px;
            height: 150px; /* è°ƒæ•´é«˜åº¦ä»¥åŒ¹é…ç”»å»Š */
            width: 150px;  /* è°ƒæ•´å®½åº¦ä»¥åŒ¹é…ç”»å»Šï¼Œä½¿å…¶ä¸ºæ­£æ–¹å½¢ */
            border-radius: 8px; /* ä¸ç”»å»Šæ ·å¼åŒæ­¥ */
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); /* ä¸ç”»å»Šæ ·å¼åŒæ­¥ */
            object-fit: cover; /* ç¡®ä¿å›¾ç‰‡ä¸å˜å½¢ */
            z-index: 5;
            cursor: pointer;
            transition: none; /* ç§»é™¤è¿‡æ¸¡æ•ˆæœ */
        }
        .poi-item-photo:hover {
            transform: none; /* ç§»é™¤æ‚¬æµ®æ”¾å¤§æ•ˆæœ */
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); /* ä¿æŒé˜´å½±ä¸å˜ */
            z-index: 5;
        }

        .poi-item-photo-placeholder {
            background-color: #f0f2f5; /* Light grey background to match theme */
            color: #b0b0b0; /* Softer text color */
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 26px;
            font-weight: 500;
        }

        /* Lightbox Styles */
        .lightbox-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            -webkit-user-select: none;
            user-select: none;
            touch-action: none;
        }

        .lightbox-content {
            position: relative;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: 1010; /* Base layer for the image */
        }

        .lightbox-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 5px;
            transform: translateZ(0);
        }
        
        /* Shared styles for close areas */
        .lightbox-close, .lightbox-bottom-close {
            position: absolute;
            cursor: pointer;
            display: flex;
        }

        .lightbox-close {
            box-sizing: border-box;
            color: #fff;
            font-size: 40px;
            font-weight: bold;
            transition: 0.3s;
            z-index: 1020; /* Action layer, below arrows */
        }
        
        .lightbox-bottom-close {
            z-index: 1020; /* Action layer, same as top close */
        }

        .lightbox-close:hover,
        .lightbox-close:focus {
            color: #bbb;
            text-decoration: none;
        }

        .lightbox-prev, .lightbox-next {
            cursor: pointer;
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            padding: 16px;
            color: white;
            font-weight: bold;
            font-size: 20px;
            transition: 0.6s ease;
            border-radius: 0 3px 3px 0;
            background-color: rgba(0,0,0,0.3);
            z-index: 1030; /* Top-most interactive layer */
        }

        .lightbox-prev:hover, .lightbox-next:hover {
            background-color: rgba(0,0,0,0.8);
        }
        
        .lightbox-prev {
            left: 15px;
        }

        .lightbox-next {
            right: 15px;
        }

        .lightbox-caption {
            text-align: center;
            color: #ccc;
            padding: 10px 0;
            position: absolute;
            bottom: 15px;
            width: 100%;
            font-size: 16px;
            z-index: 1035; /* Info layer, above image, below actions. Increased to be on top of everything. */
            pointer-events: none; /* Make caption unclickable, clicks pass through */
        }

        /* Mobile-first layout: Top and bottom bars */
        @media (max-width: 768px) {
            .lightbox-close {
                top: 0;
                left: 0;
                width: 100%;
                height: var(--lightbox-edge-area-size);
                padding: 0 35px;
                align-items: center;
                justify-content: flex-end;
            }
            .lightbox-bottom-close {
                bottom: 0;
                left: 0;
                width: 100%;
                height: var(--lightbox-edge-area-size);
            }
            .lightbox-prev, .lightbox-next {
                display: none;
            }
        }

        /* Desktop/landscape layout: Left and right bars */
        @media (min-width: 769px) {
            .lightbox-close {
                top: 0;
                right: 0;
                left: auto;
                width: var(--lightbox-edge-area-size);
                height: 100%;
                padding: 20px 0;
                align-items: flex-start;
                justify-content: center;
            }
            .lightbox-bottom-close {
                top: 0;
                left: 0;
                bottom: auto;
                width: var(--lightbox-edge-area-size);
                height: 100%;
            }
        }
    
        @keyframes slide-in-from-right {
            from { transform: translateX(110%); }
            to { transform: translateX(0); }
        }
        @keyframes slide-out-to-left {
            from { transform: translateX(0); }
            to { transform: translateX(-110%); }
        }
        @keyframes slide-in-from-left {
            from { transform: translateX(-110%); }
            to { transform: translateX(0); }
        }
        @keyframes slide-out-to-right {
            from { transform: translateX(0); }
            to { transform: translateX(110%); }
        }
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }

        /* Styles for the WX guide mask */
        #wx-guide-mask {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.75);
            z-index: 2000;
            flex-direction: column;
            align-items: flex-end;
            padding: 20px 25px;
            box-sizing: border-box;
            color: white;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            cursor: pointer;
        }
        #wx-guide-mask .arrow {
            width: 80px;
            height: 80px;
            /* New, clearer, hand-drawn style arrow */
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100' fill='none' stroke='%231890ff' stroke-width='8' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M30,70 C50,30 70,20 90,20 M75,5 L90,20 L75,35'/%3E%3C/svg%3E");
            background-size: contain;
            background-repeat: no-repeat;
            margin-right: 15px; /* Move it slightly left for better alignment */
        }
        #wx-guide-mask .mask-text {
            font-size: 20px;
            font-weight: bold;
            text-align: right;
            line-height: 1.5;
            margin-top: 50px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        #restore-loader-overlay {
            display: none; /* Hidden by default */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.9);
            z-index: 3000;
            justify-content: center;
            align-items: center;
            text-align: center;
            flex-direction: column;
            color: #333;
            font-size: 18px;
        }
        #restore-loader-overlay::before {
            content: 'âš™ï¸';
            font-size: 48px;
            margin-bottom: 20px;
            display: block;
            animation: spin 1.5s linear infinite;
        }

        /* Pointing arrow for restore-from-link */
        #arrow-container {
            display: none; /* Initially hidden */
            position: absolute;
            z-index: 4000;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.4s ease-in-out;
            /* Use flex to align children */
            align-items: center;
            gap: 8px; /* Space between arrow and text */
            animation: bounce-arrow 1s infinite;
        }

        #pointing-arrow-visual {
            width: 60px;
            height: 60px;
            /* æ›´æ”¹ä¸ºç«‹ä½“çš„çº¢è‰²ç®­å¤´ */
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3ClinearGradient id='arrowGrad' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' stop-color='%23ff6b6b'/%3E%3Cstop offset='100%25' stop-color='%23cc0000'/%3E%3C/linearGradient%3E%3Cfilter id='shadow' x='-20%25' y='-20%25' width='140%25' height='140%25'%3E%3CfeDropShadow dx='2' dy='2' stdDeviation='3' flood-color='rgba(0,0,0,0.5)'/%3E%3C/filter%3E%3C/defs%3E%3Cpath d='M50,20 V80 M35,65 L50,80 L65,65' stroke='url(%23arrowGrad)' stroke-width='10' stroke-linecap='round' stroke-linejoin='round' filter='url(%23shadow)'/%3E%3C/svg%3E");
            background-size: contain;
            background-repeat: no-repeat;
            filter: drop-shadow(0px 3px 3px rgba(0,0,0,0.2)); /* é¢å¤–æ·»åŠ CSSé˜´å½±å¢å¼ºç«‹ä½“æ„Ÿ */
            flex-shrink: 0; /* Prevent arrow from shrinking */
        }

        #pointing-arrow-text {
            color: #333;
            font-size: 16px;
            font-weight: bold;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 5px 10px;
            border-radius: 5px;
            white-space: nowrap;
            text-shadow: 0 1px 1px rgba(0,0,0,0.1);
        }

        @keyframes bounce-arrow {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-15px);
            }
            60% {
                transform: translateY(-8px);
            }
        }
    </style>
</head>
<body>
    <div id="arrow-container">
        <div id="pointing-arrow-visual"></div>
        <span id="pointing-arrow-text">ç‚¹å‡»åœ°ç‚¹è·³è½¬é«˜å¾·app</span>
    </div>
    <div class="container">
        <h1>ğŸ—ºï¸ é«˜å¾·åœ°å›¾å‘¨è¾¹æœç´¢</h1>
        
        
        <div class="search-form">
            <!-- ç§»åŠ¨ç«¯ä¸‰è¡Œå¸ƒå±€å®¹å™¨ -->
            <div id="mobileLocationContainer" class="mobile-triple-layout" style="display: none;">
                <!-- ç¬¬ä¸€è¡Œï¼šæ ‡ç­¾ -->
                <div class="mobile-labels-row">
                    <div class="mobile-label-left">
                        <label>1.è·å–å½“å‰å®šä½:</label>
                    </div>
                    <div class="mobile-label-right">
                        <label for="locationKeyword">2.æ‰‹åŠ¨è¾“å…¥ä½ç½®:</label>
                    </div>
                </div>
                
                <!-- ç¬¬äºŒè¡Œï¼šè¾“å…¥æ¡† -->
                <div class="mobile-input-row">
                    <input type="text" id="locationKeyword" placeholder="ä¾‹å¦‚ï¼šæ­å·è¥¿æ¹–" value="" oninput="onLocationInputChange()">
                </div>
                
                <!-- ç¬¬ä¸‰è¡Œï¼šæŒ‰é’® -->
                <div class="mobile-buttons-row">
                    <div class="mobile-button-left">
                        <button id="currentLocationBtn" onclick="getCurrentLocation()">ğŸ“ é«˜å¾·å®šä½</button>
                    </div>
                    <div class="mobile-button-right">
                        <button onclick="searchLocationByKeyword()" id="searchLocationBtn">ğŸ“ è·å–è¯¥ä½ç½®</button>
                    </div>
                </div>
            </div>
            
            <!-- ç”µè„‘ç«¯å•åˆ—å¸ƒå±€å®¹å™¨ -->
            <div id="desktopLocationContainer" style="display: none;">
            <div class="form-group">
                    <label for="locationKeyword" id="manualLocationLabel">1.æ‰‹åŠ¨è¾“å…¥ä½ç½®:</label>
                    <input type="text" id="locationKeywordDesktop" placeholder="ä¾‹å¦‚ï¼šæ­å·è¥¿æ¹–" value="" oninput="onLocationInputChange()">
                    <div style="text-align: center; margin-top: 10px;">
                        <button onclick="searchLocationByKeyword()" id="searchLocationBtnDesktop">ğŸ“ è·å–è¯¥ä½ç½®</button>
            </div>
                </div>
            </div>
            <div id="locationStatus" style="margin-top: 15px;"></div>

            <div id="nearby-search-section" style="display: none;">
                <hr style="margin: 20px 0; border: 0; border-top: 1px dashed #ccc;">

                <div class="form-group">
                    <label for="keywords" id="categoryLabel">2.ç‚¹å‡»åˆ†ç±»æŒ‰é’®æˆ–æ‰‹åŠ¨è¾“å…¥å…³é”®å­—:</label>
                </div>

                <div class="category-buttons form-group">
                    <div class="category-row">
                        <button onclick="searchByCategory('ç¾é£Ÿ')">ç¾é£Ÿ</button>
                        <button onclick="searchByCategory('æ°´æœ')">æ°´æœ</button>
                        <button onclick="searchByCategory('å¿«é¤')">å¿«é¤</button>
                        <button onclick="searchByCategory('å°åƒ')">å°åƒ</button>
                        <button onclick="searchByCategory('è´­ç‰©ä¸­å¿ƒ')">è´­ç‰©ä¸­å¿ƒ/å•†åœº</button>
                        <button onclick="searchByCategory('ç¾å®¹ç¾å‘')">ç¾å®¹ç¾å‘</button>
                        <button onclick="searchByCategory('è¿åŠ¨åœºæ‰€')">è¿åŠ¨åœºæ‰€</button>
                        <button onclick="searchByCategory('ä¼‘é—²å¨±ä¹')">ä¼‘é—²å¨±ä¹</button>
                        <button onclick="searchByCategory('åˆé¤')">åˆé¤/æ™šé¤</button>
                    </div>
                    <div class="category-row">
                        <button onclick="searchByCategory('ç”µå½±å‰§é™¢')">ç”µå½±/å‰§é™¢</button>
                        <button onclick="searchByCategory('å†·é¥®')">å†·é¥®/é¥®å“</button>
                        <button onclick="searchByCategory('è¶…å¸‚')">è¶…å¸‚/ä¾¿åˆ©åº—</button>
                        <button onclick="searchByCategory('ä¹°è¯')">ä¹°è¯</button>
                        <button onclick="searchByCategory('è”¬èœ')">è”¬èœ</button>
                        <button onclick="searchByCategory('å®¾é¦†é…’åº—')">å®¾é¦†é…’åº—</button>
                        <button onclick="searchByCategory('æ™¯ç‚¹')">æ™¯ç‚¹</button>
                        <button onclick="searchByCategory('å’–å•¡')">å’–å•¡</button>
                        <button onclick="searchByCategory('å…¬å…±å•æ‰€')">å…¬å…±å•æ‰€</button>
                    </div>
                </div>
                
                <div class="form-row" style="display: none;">
                    <div class="form-group">
                        <label for="longitude">ç»åº¦ (è‡ªåŠ¨å¡«å……):</label>
                        <input type="text" id="longitude" placeholder="å¾…è‡ªåŠ¨å¡«å……" value="" readonly>
                    </div>
                    <div class="form-group">
                        <label for="latitude">çº¬åº¦ (è‡ªåŠ¨å¡«å……):</label>
                        <input type="text" id="latitude" placeholder="å¾…è‡ªåŠ¨å¡«å……" value="" readonly>
                    </div>
                </div>
                
                <div class="form-row form-row-tight">
                    <div class="form-group">
                        <label for="radius">æœç´¢åŠå¾„(ç±³):</label>
                        <input type="number" id="radius" value="5000" min="1" max="50000">
                    </div>
                    <div class="form-group">
                        <label for="totalCount">ç”Ÿæˆæ•°é‡:</label>
                        <div class="input-stepper">
                            <input type="number" id="totalCount" value="50" min="0" max="200" placeholder="è¦æ˜¾ç¤ºçš„ç»“æœæ•°é‡">
                            <div class="stepper-buttons">
                                <button id="increaseBtn" class="stepper-btn" aria-label="å¢åŠ æ•°é‡">â–²</button>
                                <button id="decreaseBtn" class="stepper-btn" aria-label="å‡å°‘æ•°é‡">â–¼</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <input type="text" id="keywords" placeholder="ä¾‹å¦‚ï¼šè¥¿é¤å…ã€ç«é”…ã€æ˜Ÿå·´å…‹ç­‰" value="ä¸­é¤å…">
                </div>
                
                <button onclick="searchNearby()" id="searchBtn">ğŸ” æœç´¢å‘¨è¾¹</button>
            </div>
        </div>
        
        <div class="results" id="results"></div>
    </div>

    <!-- Lightbox Structure -->
    <div id="lightbox" class="lightbox-overlay" style="display: none;">
        <span class="lightbox-close">&times;</span>
        <div class="lightbox-content">
            <!-- Images are injected by JavaScript -->
        </div>
        <a class="lightbox-prev">&#10094;</a>
        <a class="lightbox-next">&#10095;</a>
        <div class="lightbox-caption"></div>
        <div class="lightbox-bottom-close"></div>
    </div>

    <a id="scrollTopBtn" title="å›åˆ°é¡¶éƒ¨">â–²</a>

    <!-- WX Guide Mask -->
    <div id="wx-guide-mask">
        <div class="arrow"></div>
        <p class="mask-text">
            è¯·ç‚¹å‡»å³ä¸Šè§’èœå•<br>é€‰æ‹©"åœ¨æµè§ˆå™¨æ‰“å¼€"
        </p>
    </div>

    <!-- Loader for the restore-from-link functionality -->
    <div id="restore-loader-overlay">
        <p>æ­£åœ¨æ ¹æ®é“¾æ¥è‡ªåŠ¨è¿˜åŸæœç´¢...<br>è¯·ç¨å€™</p>
    </div>

    <script>
        /* ===============================================
           å…¨å±€å˜é‡ä¸é…ç½®
           =============================================== */
        let originalDistanceSortedPois = [];
        let currentDisplaySort = 'rating';
        let comprehensiveSortMode = 'cost_effective';
        let searchCache = {};
        let locationCache = {};
        let cachedSortedResults = {
            distance: [],
            rating: [],
            cost_effective: [],
            high_end: []
        };
        let locationChoices = [];
        let lastLocationKeyword = '';
        let lastUsedSearchParams = {};
        let isCurrentLocationSelection = false; // æ ‡è®°æ˜¯å¦æ¥è‡ªé«˜å¾·å®šä½é€‰æ‹©
        const CHINESE_CITIES = ['åŒ—äº¬å¸‚', 'å¤©æ´¥å¸‚', 'ä¸Šæµ·å¸‚', 'é‡åº†å¸‚', 'é¦™æ¸¯ç‰¹åˆ«è¡Œæ”¿åŒº', 'æ¾³é—¨ç‰¹åˆ«è¡Œæ”¿åŒº', 'å“ˆå°”æ»¨å¸‚', 'é½é½å“ˆå°”å¸‚', 'é¸¡è¥¿å¸‚', 'é¹¤å²—å¸‚', 'åŒé¸­å±±å¸‚', 'å¤§åº†å¸‚', 'ä¼Šæ˜¥å¸‚', 'ä½³æœ¨æ–¯å¸‚', 'ä¸ƒå°æ²³å¸‚', 'ç‰¡ä¸¹æ±Ÿå¸‚', 'é»‘æ²³å¸‚', 'ç»¥åŒ–å¸‚', 'å¤§å…´å®‰å²­åœ°åŒº', 'é•¿æ˜¥å¸‚', 'å‰æ—å¸‚', 'å››å¹³å¸‚', 'è¾½æºå¸‚', 'é€šåŒ–å¸‚', 'ç™½å±±å¸‚', 'æ¾åŸå¸‚', 'ç™½åŸå¸‚', 'å»¶è¾¹æœé²œæ—è‡ªæ²»å·', 'æ²ˆé˜³å¸‚', 'å¤§è¿å¸‚', 'éå±±å¸‚', 'æŠšé¡ºå¸‚', 'æœ¬æºªå¸‚', 'ä¸¹ä¸œå¸‚', 'é”¦å·å¸‚', 'è¥å£å¸‚', 'é˜œæ–°å¸‚', 'è¾½é˜³å¸‚', 'ç›˜é”¦å¸‚', 'é“å²­å¸‚', 'æœé˜³å¸‚', 'è‘«èŠ¦å²›å¸‚', 'çŸ³å®¶åº„å¸‚', 'å”å±±å¸‚', 'ç§¦çš‡å²›å¸‚', 'é‚¯éƒ¸å¸‚', 'é‚¢å°å¸‚', 'ä¿å®šå¸‚', 'å¼ å®¶å£å¸‚', 'æ‰¿å¾·å¸‚', 'æ²§å·å¸‚', 'å»ŠåŠå¸‚', 'è¡¡æ°´å¸‚', 'å¤ªåŸå¸‚', 'å¤§åŒå¸‚', 'é˜³æ³‰å¸‚', 'é•¿æ²»å¸‚', 'æ™‹åŸå¸‚', 'æœ”å·å¸‚', 'æ™‹ä¸­å¸‚', 'è¿åŸå¸‚', 'å¿»å·å¸‚', 'ä¸´æ±¾å¸‚', 'å•æ¢å¸‚', 'å‘¼å’Œæµ©ç‰¹å¸‚', 'åŒ…å¤´å¸‚', 'ä¹Œæµ·å¸‚', 'èµ¤å³°å¸‚', 'é€šè¾½å¸‚', 'é„‚å°”å¤šæ–¯å¸‚', 'å‘¼ä¼¦è´å°”å¸‚', 'å·´å½¦æ·–å°”å¸‚', 'ä¹Œå…°å¯Ÿå¸ƒå¸‚', 'å…´å®‰ç›Ÿ', 'é”¡æ—éƒ­å‹’ç›Ÿ', 'é˜¿æ‹‰å–„ç›Ÿ', 'å—äº¬å¸‚', 'æ— é”¡å¸‚', 'å¾å·å¸‚', 'å¸¸å·å¸‚', 'è‹å·å¸‚', 'å—é€šå¸‚', 'è¿äº‘æ¸¯å¸‚', 'æ·®å®‰å¸‚', 'ç›åŸå¸‚', 'æ‰¬å·å¸‚', 'é•‡æ±Ÿå¸‚', 'æ³°å·å¸‚', 'å®¿è¿å¸‚', 'æ­å·å¸‚', 'å®æ³¢å¸‚', 'æ¸©å·å¸‚', 'å˜‰å…´å¸‚', 'æ¹–å·å¸‚', 'ç»å…´å¸‚', 'é‡‘åå¸‚', 'è¡¢å·å¸‚', 'èˆŸå±±å¸‚', 'å°å·å¸‚', 'ä¸½æ°´å¸‚', 'åˆè‚¥å¸‚', 'èŠœæ¹–å¸‚', 'èšŒåŸ å¸‚', 'æ·®å—å¸‚', 'é©¬éå±±å¸‚', 'æ·®åŒ—å¸‚', 'é“œé™µå¸‚', 'å®‰åº†å¸‚', 'é»„å±±å¸‚', 'æ»å·å¸‚', 'é˜œé˜³å¸‚', 'å®¿å·å¸‚', 'å…­å®‰å¸‚', 'äº³å·å¸‚', 'æ± å·å¸‚', 'å®£åŸå¸‚', 'ç¦å·å¸‚', 'å¦é—¨å¸‚', 'è†ç”°å¸‚', 'ä¸‰æ˜å¸‚', 'æ³‰å·å¸‚', 'æ¼³å·å¸‚', 'å—å¹³å¸‚', 'é¾™å²©å¸‚', 'å®å¾·å¸‚', 'å—æ˜Œå¸‚', 'æ™¯å¾·é•‡å¸‚', 'èä¹¡å¸‚', 'ä¹æ±Ÿå¸‚', 'æ–°ä½™å¸‚', 'é¹°æ½­å¸‚', 'èµ£å·å¸‚', 'å‰å®‰å¸‚', 'å®œæ˜¥å¸‚', 'æŠšå·å¸‚', 'ä¸Šé¥¶å¸‚', 'æµå—å¸‚', 'é’å²›å¸‚', 'æ·„åšå¸‚', 'æ£åº„å¸‚', 'ä¸œè¥å¸‚', 'çƒŸå°å¸‚', 'æ½åŠå¸‚', 'æµå®å¸‚', 'æ³°å®‰å¸‚', 'å¨æµ·å¸‚', 'æ—¥ç…§å¸‚', 'ä¸´æ²‚å¸‚', 'å¾·å·å¸‚', 'èŠåŸå¸‚', 'æ»¨å·å¸‚', 'èæ³½å¸‚', 'éƒ‘å·å¸‚', 'å¼€å°å¸‚', 'æ´›é˜³å¸‚', 'å¹³é¡¶å±±å¸‚', 'å®‰é˜³å¸‚', 'é¹¤å£å¸‚', 'æ–°ä¹¡å¸‚', 'ç„¦ä½œå¸‚', 'æ¿®é˜³å¸‚', 'è®¸æ˜Œå¸‚', 'æ¼¯æ²³å¸‚', 'ä¸‰é—¨å³¡å¸‚', 'å—é˜³å¸‚', 'å•†ä¸˜å¸‚', 'ä¿¡é˜³å¸‚', 'å‘¨å£å¸‚', 'é©»é©¬åº—å¸‚', 'æ­¦æ±‰å¸‚', 'é»„çŸ³å¸‚', 'åå °å¸‚', 'å®œæ˜Œå¸‚', 'è¥„é˜³å¸‚', 'é„‚å·å¸‚', 'è†é—¨å¸‚', 'å­æ„Ÿå¸‚', 'è†å·å¸‚', 'é»„å†ˆå¸‚', 'å’¸å®å¸‚', 'éšå·å¸‚', 'æ©æ–½åœŸå®¶æ—è‹—æ—è‡ªæ²»å·', 'é•¿æ²™å¸‚', 'æ ªæ´²å¸‚', 'æ¹˜æ½­å¸‚', 'è¡¡é˜³å¸‚', 'é‚µé˜³å¸‚', 'å²³é˜³å¸‚', 'å¸¸å¾·å¸‚', 'å¼ å®¶ç•Œå¸‚', 'ç›Šé˜³å¸‚', 'éƒ´å·å¸‚', 'æ°¸å·å¸‚', 'æ€€åŒ–å¸‚', 'å¨„åº•å¸‚', 'æ¹˜è¥¿åœŸå®¶æ—è‹—æ—è‡ªæ²»å·', 'å¹¿å·å¸‚', 'éŸ¶å…³å¸‚', 'æ·±åœ³å¸‚', 'ç æµ·å¸‚', 'æ±•å¤´å¸‚', 'ä½›å±±å¸‚', 'æ±Ÿé—¨å¸‚', 'æ¹›æ±Ÿå¸‚', 'èŒ‚åå¸‚', 'è‚‡åº†å¸‚', 'æƒ å·å¸‚', 'æ¢…å·å¸‚', 'æ±•å°¾å¸‚', 'æ²³æºå¸‚', 'é˜³æ±Ÿå¸‚', 'æ¸…è¿œå¸‚', 'ä¸œèå¸‚', 'ä¸­å±±å¸‚', 'æ½®å·å¸‚', 'æ­é˜³å¸‚', 'äº‘æµ®å¸‚', 'å—å®å¸‚', 'æŸ³å·å¸‚', 'æ¡‚æ—å¸‚', 'æ¢§å·å¸‚', 'åŒ—æµ·å¸‚', 'é˜²åŸæ¸¯å¸‚', 'é’¦å·å¸‚', 'è´µæ¸¯å¸‚', 'ç‰æ—å¸‚', 'ç™¾è‰²å¸‚', 'è´ºå·å¸‚', 'æ²³æ± å¸‚', 'æ¥å®¾å¸‚', 'å´‡å·¦å¸‚', 'æµ·å£å¸‚', 'ä¸‰äºšå¸‚', 'ä¸‰æ²™å¸‚', 'å„‹å·å¸‚', 'æˆéƒ½å¸‚', 'è‡ªè´¡å¸‚', 'æ”€æèŠ±å¸‚', 'æ³¸å·å¸‚', 'å¾·é˜³å¸‚', 'ç»µé˜³å¸‚', 'å¹¿å…ƒå¸‚', 'é‚å®å¸‚', 'å†…æ±Ÿå¸‚', 'ä¹å±±å¸‚', 'å—å……å¸‚', 'çœ‰å±±å¸‚', 'å®œå®¾å¸‚', 'å¹¿å®‰å¸‚', 'è¾¾å·å¸‚', 'é›…å®‰å¸‚', 'å·´ä¸­å¸‚', 'èµ„é˜³å¸‚', 'é˜¿åè—æ—ç¾Œæ—è‡ªæ²»å·', 'ç”˜å­œè—æ—è‡ªæ²»å·', 'å‡‰å±±å½æ—è‡ªæ²»å·', 'è´µé˜³å¸‚', 'å…­ç›˜æ°´å¸‚', 'éµä¹‰å¸‚', 'å®‰é¡ºå¸‚', 'æ¯•èŠ‚å¸‚', 'é“œä»å¸‚', 'é»”è¥¿å—å¸ƒä¾æ—è‹—æ—è‡ªæ²»å·', 'é»”ä¸œå—è‹—æ—ä¾—æ—è‡ªæ²»å·', 'é»”å—å¸ƒä¾æ—è‹—æ—è‡ªæ²»å·', 'æ˜†æ˜å¸‚', 'æ›²é–å¸‚', 'ç‰æºªå¸‚', 'ä¿å±±å¸‚', 'æ˜­é€šå¸‚', 'ä¸½æ±Ÿå¸‚', 'æ™®æ´±å¸‚', 'ä¸´æ²§å¸‚', 'æ¥šé›„å½æ—è‡ªæ²»å·', 'çº¢æ²³å“ˆå°¼æ—å½æ—è‡ªæ²»å·', 'æ–‡å±±å£®æ—è‹—æ—è‡ªæ²»å·', 'è¥¿åŒç‰ˆçº³å‚£æ—è‡ªæ²»å·', 'å¤§ç†ç™½æ—è‡ªæ²»å·', 'å¾·å®å‚£æ—æ™¯é¢‡æ—è‡ªæ²»å·', 'æ€’æ±Ÿå‚ˆåƒ³æ—è‡ªæ²»å·', 'è¿ªåº†è—æ—è‡ªæ²»å·', 'æ‹‰è¨å¸‚', 'æ—¥å–€åˆ™å¸‚', 'æ˜Œéƒ½å¸‚', 'æ—èŠå¸‚', 'å±±å—å¸‚', 'é‚£æ›²å¸‚', 'é˜¿é‡Œåœ°åŒº', 'è¥¿å®‰å¸‚', 'é“œå·å¸‚', 'å®é¸¡å¸‚', 'å’¸é˜³å¸‚', 'æ¸­å—å¸‚', 'å»¶å®‰å¸‚', 'æ±‰ä¸­å¸‚', 'æ¦†æ—å¸‚', 'å®‰åº·å¸‚', 'å•†æ´›å¸‚', 'å…°å·å¸‚', 'å˜‰å³ªå…³å¸‚', 'é‡‘æ˜Œå¸‚', 'ç™½é“¶å¸‚', 'å¤©æ°´å¸‚', 'æ­¦å¨å¸‚', 'å¼ æ–å¸‚', 'å¹³å‡‰å¸‚', 'é…’æ³‰å¸‚', 'åº†é˜³å¸‚', 'å®šè¥¿å¸‚', 'é™‡å—å¸‚', 'ä¸´å¤å›æ—è‡ªæ²»å·', 'ç”˜å—è—æ—è‡ªæ²»å·', 'è¥¿å®å¸‚', 'æµ·ä¸œå¸‚', 'æµ·åŒ—è—æ—è‡ªæ²»å·', 'é»„å—è—æ—è‡ªæ²»å·', 'æµ·å—è—æ—è‡ªæ²»å·', 'æœæ´›è—æ—è‡ªæ²»å·', 'ç‰æ ‘è—æ—è‡ªæ²»å·', 'æµ·è¥¿è’™å¤æ—è—æ—è‡ªæ²»å·', 'é“¶å·å¸‚', 'çŸ³å˜´å±±å¸‚', 'å´å¿ å¸‚', 'å›ºåŸå¸‚', 'ä¸­å«å¸‚', 'ä¹Œé²æœ¨é½å¸‚', 'å…‹æ‹‰ç›ä¾å¸‚', 'åé²ç•ªå¸‚', 'å“ˆå¯†å¸‚', 'æ˜Œå‰å›æ—è‡ªæ²»å·', 'åšå°”å¡”æ‹‰è’™å¤è‡ªæ²»å·', 'å·´éŸ³éƒ­æ¥è’™å¤è‡ªæ²»å·', 'é˜¿å…‹è‹åœ°åŒº', 'å…‹å­œå‹’è‹æŸ¯å°”å…‹å­œè‡ªæ²»å·', 'å–€ä»€åœ°åŒº', 'å’Œç”°åœ°åŒº', 'ä¼ŠçŠå“ˆè¨å…‹è‡ªæ²»å·', 'å¡”åŸåœ°åŒº', 'é˜¿å‹’æ³°åœ°åŒº'];
        let allPoiPhotos = [];
        let currentPoiPhotos = [];
        let currentPhotoIndex = 0;
        let isLightboxAnimating = false;
        const preventNavSwipe = (e) => e.preventDefault();
        let linkClicked = false;

        const CONFIG = {
            GAODE_BASE_URL: 'https://restapi.amap.com',
            GAODE_KEY: 'dcfb48c0f9cb749e59c5031e83cb6e95',
            DEFAULT_PARAMS: {
                output: 'json',
                show_fields: 'business,photos'
            }
        };
        
        /* ===============================================
           æ ¸å¿ƒAPIä¸å·¥å…·å‡½æ•°
           =============================================== */
        async function callGaodeAPI(apiPath, params = {}) {
            const queryParams = {
                ...params,
                key: CONFIG.GAODE_KEY
            };
            const url = `${CONFIG.GAODE_BASE_URL}/${apiPath}?${new URLSearchParams(queryParams).toString()}`;
            
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTPé”™è¯¯: ${response.status} ${response.statusText}`);
                }
                const data = await response.json();
                return data;
            } catch (error) {
                throw new Error(`APIè°ƒç”¨å¤±è´¥: ${error.message}`);
            }
        }
        
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        
        function truncateString(str, num) {
            if (!str) return '';
            if (str.length <= num) {
                return str;
            }
            return str.slice(0, num) + '...';
        }

        function searchByCategory(category) {
            document.getElementById('keywords').value = category;
            searchNearby();
        }

        /* ===============================================
           POIç±»å‹æ˜ å°„ä¸æ•°æ®å¤„ç†
           =============================================== */
        const POI_KEYWORD_MAP = {
            '050100': ['é¤å…', 'é¥­åº—',  'åƒé¥­','ä¸­é¤å…', 'ä¸­é¤','åˆé¤', 'åˆé¥­', 'æ™šé¤', 'æ™šé¥­'],
            '050101': ['é…’æ¥¼'],
            '050102': ['å››å·èœ', 'å·èœ'],
            '050103': ['å¹¿ä¸œèœ', 'ç²¤èœ'],
            '050104': ['å±±ä¸œèœ', 'é²èœ'],
            '050105|050107|050106': ['æ±Ÿè‹èœ', 'æµ™æ±Ÿèœ', 'ä¸Šæµ·èœ', 'æ­å¸®èœ'],
            '050108': ['æ¹–å—èœ', 'æ¹˜èœ'],
            '050109': ['å®‰å¾½èœ', 'å¾½èœ'],
            '050111': ['åŒ—äº¬èœ'],
            '050116': ['è€å­—å·'],
            '050117': ['ç«é”…åº—', 'ç«é”…'],
            '050119': ['æµ·é²œ'],
            '050120': ['ç´ èœ'],
            '050200': ['å¤–å›½é¤å…'],
            '050201': ['è¥¿é¤å…', 'è¥¿é¤'],
            '050300': ['å¿«é¤'],
            '050301': ['è‚¯å¾·åŸº'],
            '050302': ['éº¦å½“åŠ³'],
            '050303': ['å¿…èƒœå®¢'],
            '050305': ['èŒ¶é¤å…'],
            '050500': ['å’–å•¡', 'å’–å•¡é¦†', 'å’–å•¡åº—'],
            '050501': ['æ˜Ÿå·´å…‹', 'æ˜Ÿå·´å…‹å’–å•¡'],
            '050600': ['å–èŒ¶'],
            '050700': ['å†·é¥®', 'å¥¶èŒ¶', 'é¥®å“'],
            '050800': ['ç³•é¥¼'],
            '050900': ['ç”œå“'],
            '060200|060400': ['è¶…å¸‚', 'ä¾¿åˆ©åº—'],
            '060101': ['è´­ç‰©ä¸­å¿ƒ', 'å•†åœº'],
            '060704': ['æ°´æœ', 'æ°´æœåº—', 'æ°´æœæ‘Š'],
            '060705': ['è”¬èœ', 'èœå¸‚åœº'],
            '090601': ['ä¹°è¯', 'è¯åº—', 'è¯æˆ¿'],
            '100100|100101': ['å®¾é¦†é…’åº—', 'é«˜æ¡£é…’åº—', 'å®¾é¦†', 'æ—…é¦†', 'æ—…åº—'],
            '110000': ['é£æ™¯', 'æ™¯ç‚¹'],
            '080100': ['è¿åŠ¨åœºæ‰€'],
            '080500|080300': ['ä¼‘é—²å¨±ä¹'],
            '080600': ['ç”µå½±é™¢', 'ç”µå½±å‰§é™¢'],
            '071100|090201': ['ç¾å®¹ç¾å‘'],
            '200300': ['å…¬å…±å•æ‰€'],
        };
        const SORTED_KEYWORDS = Object.entries(POI_KEYWORD_MAP)
            .flatMap(([code, keywords]) => keywords.map(kw => ({ keyword: kw, code: code })))
            .sort((a, b) => b.keyword.length - a.keyword.length);

        function findPoiTypeByKeyword(userInput) {
            if (!userInput) return null;
            const found = Object.entries(POI_KEYWORD_MAP).find(([code, keywords]) => {
                return keywords.includes(userInput);
            });
            return found ? found[0] : null;
        }
        
        function deduplicatePois(pois) {
            const seen = new Set();
            return pois.filter(poi => {
                const name = poi.name;
                if (seen.has(name)) {
                    return false;
                }
                seen.add(name);
                return true;
            });
        }
        
        /* ===============================================
           æ’åºç®—æ³•ä¸ç¼“å­˜ç®¡ç†
           =============================================== */
        function applySort(sortType) {
            currentDisplaySort = sortType;
            let listToRender = [];
            
            if (sortType === 'comprehensive') {
                listToRender = cachedSortedResults[comprehensiveSortMode];
            } else {
                listToRender = cachedSortedResults[sortType];
            }
            
            renderPoiList(listToRender);
            updateSortButtonStyles(); // æ›´æ–°æŒ‰é’®çŠ¶æ€
        }

        function toggleComprehensiveSort() {
            // å¦‚æœå½“å‰å·²ç»æ˜¯ç»¼åˆæ’åºæ¨¡å¼ï¼Œåˆ™åˆ‡æ¢ç»¼åˆæ’åºç±»å‹
            if (currentDisplaySort === 'comprehensive') {
            comprehensiveSortMode = comprehensiveSortMode === 'cost_effective' ? 'high_end' : 'cost_effective';
            }
            // å¦‚æœä¸æ˜¯ç»¼åˆæ’åºæ¨¡å¼ï¼Œç›´æ¥åº”ç”¨å½“å‰çš„ç»¼åˆæ’åºæ¨¡å¼ï¼Œä¸åˆ‡æ¢
            applySort('comprehensive');
        }

        function precomputeAndCacheAllSorts(limit) {
            const effectiveLimit = limit > 0 ? limit : originalDistanceSortedPois.length;
            cachedSortedResults.distance = [...originalDistanceSortedPois].slice(0, effectiveLimit);
            cachedSortedResults.rating = sortPoisByRating(originalDistanceSortedPois).slice(0, effectiveLimit);
            cachedSortedResults.cost_effective = sortPoisByComprehensive(originalDistanceSortedPois, 'cost_effective').slice(0, effectiveLimit);
            cachedSortedResults.high_end = sortPoisByComprehensive(originalDistanceSortedPois, 'high_end').slice(0, effectiveLimit);
        }

        function sortPoisByRating(pois) {
            const sortedByDistance = [...pois].sort((a, b) => a.distance - b.distance);

            const poisWithRanks = sortedByDistance.map(poi => ({
                ...poi,
                distanceRank: Math.floor(poi.distance / 500) + 1,
                rating: parseFloat(poi.business?.rating) || 0,
            }));

            const sortedByRating = [...poisWithRanks].sort((a, b) => b.rating - a.rating);
            sortedByRating.forEach((p, i) => {
                const originalPoi = poisWithRanks.find(item => item.id === p.id);
                if(originalPoi) originalPoi.ratingRank = i + 1;
            });

            const maxRatingRank = poisWithRanks.length;
            let maxDistance = 0;
            poisWithRanks.forEach(p => {
                if (p.distance > maxDistance) maxDistance = p.distance;
            });
            const maxDistanceRank = Math.floor(maxDistance / 500) + 1;

            poisWithRanks.forEach(poi => {
                const normRating = maxRatingRank > 1 ? (poi.ratingRank - 1) / (maxRatingRank - 1) : 0;
                const normDistance = maxDistanceRank > 1 ? (poi.distanceRank - 1) / (maxDistanceRank - 1) : 0;
                poi.compositeScore = (normRating * 0.8) + (normDistance * 0.2);
            });
            
            poisWithRanks.sort((a, b) => a.compositeScore - b.compositeScore);
            
            return poisWithRanks;
        }

        /**
         * æ ¹æ®ç»¼åˆè§„åˆ™æ’åº
         * @param {Array} pois
         * @param {'cost_effective' | 'high_end'} mode
         */
        function sortPoisByComprehensive(pois, mode) {
            // æ–°çš„æ€§ä»·æ¯”æ’åºé€»è¾‘ï¼Œä¸å†åŒºåˆ† mode
            if (mode === 'cost_effective') {
                const poisWithData = pois
                    .map(poi => ({
                        ...poi,
                        rating: parseFloat(poi.business?.rating) || 0,
                        cost: parseFloat(poi.business?.cost) || 0,
                        distance: parseInt(poi.distance, 10) || Infinity,
                        distanceRank: Math.floor((parseInt(poi.distance, 10) || 0) / 500) + 1,
                    }))
                    .filter(poi => poi.rating > 0 && poi.cost > 0);

                if (poisWithData.length === 0) return pois; // å¦‚æœæ²¡æœ‰å¯ç”¨æ•°æ®ï¼Œè¿”å›åŸå§‹åˆ—è¡¨

                poisWithData.forEach(poi => {
                    poi.pricePerformance = poi.rating / poi.cost;
                });

                // æ‰¾åˆ°æœ€å¤§å’Œæœ€å°çš„æ€§ä»·æ¯”å€¼å’Œè·ç¦»æ’åï¼Œç”¨äºå½’ä¸€åŒ–
                let maxPricePerformance = -Infinity, minPricePerformance = Infinity;
                let maxDistanceRank = -Infinity, minDistanceRank = Infinity;

                poisWithData.forEach(p => {
                    if (p.pricePerformance > maxPricePerformance) maxPricePerformance = p.pricePerformance;
                    if (p.pricePerformance < minPricePerformance) minPricePerformance = p.pricePerformance;
                    if (p.distanceRank > maxDistanceRank) maxDistanceRank = p.distanceRank;
                    if (p.distanceRank < minDistanceRank) minDistanceRank = p.distanceRank;
                });
                
                // å½’ä¸€åŒ–å¹¶è®¡ç®—ç»¼åˆå¾—åˆ†
                poisWithData.forEach(poi => {
                    // å½’ä¸€åŒ–æ€§ä»·æ¯”å€¼ (è¶Šé«˜è¶Šå¥½)
                    const normPricePerformance = (maxPricePerformance - minPricePerformance > 0)
                        ? (poi.pricePerformance - minPricePerformance) / (maxPricePerformance - minPricePerformance)
                        : 0;

                    // å½’ä¸€åŒ–è·ç¦»æ’å (è¶Šä½è¶Šå¥½ï¼Œæ‰€ä»¥ç”¨ 1 - normalized_value)
                    const normDistanceRank = (maxDistanceRank - minDistanceRank > 0)
                        ? 1 - ((poi.distanceRank - minDistanceRank) / (maxDistanceRank - minDistanceRank))
                        : 0;
                    
                    // åº”ç”¨æƒé‡
                    poi.compositeScore = (normPricePerformance * 0.7) + (normDistanceRank * 0.3);
                });

                // æŒ‰ç»¼åˆå¾—åˆ†é™åºæ’åº
                poisWithData.sort((a, b) => b.compositeScore - a.compositeScore);
                
                // å°†æ²¡æœ‰æ•°æ®çš„POIæ”¾å›åˆ—è¡¨æœ«å°¾
                const poisWithoutData = pois.filter(p => !(p.business?.rating > 0 && p.business?.cost > 0));
                
                return [...poisWithData, ...poisWithoutData];

            } else { // 'high_end' é€»è¾‘ä¿æŒä¸å˜æˆ–æŒ‰åŸæ ·å¤„ç†
                 // ç¡®ä¿poisæ˜¯æŒ‰è·ç¦»æ’åºçš„
                const sortedByDistance = [...pois].sort((a, b) => a.distance - b.distance);

                const poisWithRanks = sortedByDistance.map(poi => ({
                    ...poi,
                    distanceRank: Math.floor(poi.distance / 500) + 1,
                    rating: parseFloat(poi.business?.rating) || 0,
                    cost: parseFloat(poi.business?.cost) || 0,
                }));

                // è¯„çº§æ’å (é«˜åˆ†åœ¨å‰)
                const sortedByRating = [...poisWithRanks].sort((a, b) => b.rating - a.rating);
                sortedByRating.forEach((p, i) => {
                    const originalPoi = poisWithRanks.find(item => item.id === p.id);
                    if (originalPoi) originalPoi.ratingRank = i + 1;
                });

                // äººå‡æ¶ˆè´¹æ’å
                const withCost = poisWithRanks.filter(p => p.cost > 0);
                const withoutCost = poisWithRanks.filter(p => p.cost <= 0);
                
                // é«˜æ¡£: é«˜æ¶ˆè´¹åœ¨å‰
                withCost.sort((a, b) => b.cost - a.cost); 
                
                withCost.forEach((p, i) => {
                    const originalPoi = poisWithRanks.find(item => item.id === p.id);
                    if (originalPoi) originalPoi.costRank = i + 1;
                });

                const lowestRank = withCost.length + 1;
                withoutCost.forEach(p => {
                    const originalPoi = poisWithRanks.find(item => item.id === p.id);
                    if (originalPoi) originalPoi.costRank = lowestRank;
                });
                
                // Find max ranks for normalization
                const maxRatingRank = poisWithRanks.length;
                const maxCostRank = poisWithRanks.length; // All items get a costRank
                let maxDistance = 0;
                poisWithRanks.forEach(p => {
                    if (p.distance > maxDistance) maxDistance = p.distance;
                });
                const maxDistanceRank = Math.floor(maxDistance / 500) + 1;

                // Define weights for high_end mode
                const weights = { distance: 0, rating: 0.3, cost: 0.7 };
                
                // Calculate composite score using normalized ranks for fairness
                poisWithRanks.forEach(p => {
                    if (p.cost <= 0) {
                        p.compositeScore = Infinity;
                        return;
                    }

                    if (p.ratingRank && p.costRank) { // Ensure ranks exist
                        const normRating = maxRatingRank > 1 ? (p.ratingRank - 1) / (maxRatingRank - 1) : 0;
                        const normCost = maxCostRank > 1 ? (p.costRank - 1) / (maxCostRank - 1) : 0;
                        const normDistance = maxDistanceRank > 1 ? (p.distanceRank - 1) / (maxDistanceRank - 1) : 0;
                        
                        p.compositeScore = (normDistance * weights.distance) + (normRating * weights.rating) + (normCost * weights.cost);
                    } else {
                        p.compositeScore = Infinity; // Put items without full ranks at the end
                    }
                });

                // æŒ‰ç»¼åˆå¾—åˆ†å‡åºæ’åº
                poisWithRanks.sort((a, b) => a.compositeScore - b.compositeScore);
                return poisWithRanks;
            }
        }

        /* ===============================================
           POIåˆ—è¡¨æ¸²æŸ“ä¸æ˜¾ç¤º
           =============================================== */
        function renderPoiList(pois) {
            const listContainer = document.getElementById('poi-list-container');
            if (!listContainer) return;
            
            let html = '';
            pois.forEach((poi, index) => {
                let displayType;
                if (poi.type) {
                    const typeParts = poi.type.split(';');
                    // ä½¿ç”¨ç¬¬äºŒçº§åˆ†ç±»ï¼ˆå¦‚æœå­˜åœ¨ï¼‰ï¼Œå¦åˆ™å›é€€åˆ°ç¬¬ä¸€çº§
                    displayType = typeParts[1] || typeParts[0] || 'æœªåˆ†ç±»';
                } else {
                    displayType = 'æœªåˆ†ç±»';
                }

                // æ ¹æ®è¦æ±‚åº”ç”¨è‡ªå®šä¹‰åç§°æ˜ å°„
                const typeNameMap = {
                    'ä¾¿æ°‘å•†åº—/ä¾¿åˆ©åº—': 'ä¾¿åˆ©åº—',
                    'ä¸ªäººç”¨å“/åŒ–å¦†å“åº—': 'æ´—æŠ¤åŒ–å¦†å“',
                    'æ±½è½¦å…»æŠ¤/è£…é¥°': 'æ±½è½¦å…»æŠ¤',
                    'é‡‘èä¿é™©æœåŠ¡æœºæ„': 'é‡‘èæœåŠ¡',
                    'æ”¿åºœåŠç¤¾ä¼šå›¢ä½“ç›¸å…³': 'æ”¿åºœæœºæ„ç›¸å…³',
                    'åŒ»è¯ä¿å¥é”€å”®åº—': 'åŒ»è¯ä¿å¥é”€å”®',
                    'åŒ»ç–—ä¿å¥æœåŠ¡åœºæ‰€': 'åŒ»ç–—ä¿å¥æœåŠ¡',
                    'ç”µåŠ¨è‡ªåŠ¨è½¦å……ç”µç«™': 'åŒè½®è½¦å……ç”µç«™',
                    'å½©ç¥¨å½©åˆ¸é”€å”®ç‚¹': 'å½©ç¥¨å½©åˆ¸',
                    'æœè£…é‹å¸½çš®å…·åº—': 'æœè£…é‹å¸½çš®å…·'
                };
                displayType = typeNameMap[displayType] || displayType;

                // å¦‚æœç¬¬äºŒç±»å‹çš„æœ€åä¸¤ä¸ªå­—ä¸ºï¼šç»´ä¿®ï¼Œç»Ÿä¸€æ”¹æˆï¼šæ±½è½¦ç»´ä¿®
                if (displayType.endsWith('ç»´ä¿®')) {
                    displayType = 'æ±½è½¦ç»´ä¿®';
                }

                // å½“ç¬¬äºŒç±»å‹åŒ…å« é”€å”® ä¸”å¤§äºç­‰äº7ä¸ªä¸­æ–‡å­—ï¼Œå…¨éƒ¨æ”¹æˆæ±½è½¦é”€å”®
                if (displayType.includes('é”€å”®') && displayType.length >= 7) {
                    displayType = 'æ±½è½¦é”€å”®';
                }
                
                // const mapUrl = getMapUrl(poi); // This is now handled dynamically
                const poiName = truncateString(poi.name || 'æœªçŸ¥åœ°ç‚¹', 28);//æœ€å¤šæ˜¾ç¤º28ä¸ªå­—ç¬¦

                let photoHtml = '';
                if (poi.photos && poi.photos.length > 0) {
                    const firstPhotoUrl = poi.photos[0].url;
                    // Escape quotes for the HTML attribute.
                    const photosJson = JSON.stringify(poi.photos).replace(/"/g, '&quot;');
                    photoHtml = `<img src="${firstPhotoUrl}" class="poi-item-photo lightbox-trigger" alt="${poi.name}" loading="lazy" data-photos="${photosJson}" data-poi-id="${poi.id}" title="ç‚¹å‡»é¢„è§ˆ ${poi.photos.length} å¼ å›¾ç‰‡">`;
                } else {
                    // Render a placeholder if no photos are available.
                    // It uses 'poi-item-photo' for sizing/positioning, and the new class for styling.
                    // Importantly, it does NOT have the 'lightbox-trigger' class, making it unclickable.
                    photoHtml = `<div class="poi-item-photo poi-item-photo-placeholder">æ•¬è¯·æœŸå¾…</div>`;
                }

                const fullAddress = buildFullAddress(poi);
                const escapedAddress = fullAddress.replace(/"/g, '&quot;');

                // Helper to create consistently styled info lines
                const createInfoLine = (label, value) => {
                    if (!value || value.toString().trim() === '' || value === 'æš‚æ— ç”µè¯') return '';
                    return `<div class="poi-info-line">
                                <span class="poi-info-label">${label}</span>
                                <span class="poi-info-value">${value}</span>
                            </div>`;
                };

                let infoHtml = ``;
                infoHtml += createInfoLine('ğŸ“ç”µè¯:', formatPhoneNumber(poi.business?.tel));
                infoHtml += createInfoLine('ğŸ ç±»å‹:', displayType);
                infoHtml += createInfoLine('ğŸ“ç›´çº¿è·ç¦»:', poi.distance ? poi.distance + 'ç±³' : 'è·ç¦»æœªçŸ¥');
                
                if (poi.business_area) {
                    infoHtml += createInfoLine('ğŸ¢å•†åœˆ:', poi.business_area);
                }
                if (poi.business?.rating && parseFloat(poi.business.rating) > 0) {
                    infoHtml += createInfoLine('â­è¯„åˆ†:', poi.business.rating);
                }
                if (poi.business?.cost) {
                    infoHtml += createInfoLine('ğŸ’°äººå‡:', poi.business.cost + 'å…ƒ');
                }
                
                // å°†è¯¦ç»†åœ°å€æŒ‰é’®ç§»åˆ°æœ€åä¸€è¡Œ
                infoHtml += `<div class="poi-info-line"><button class="address-btn" data-address="${escapedAddress}"> è¯¦ç»†åœ°å€ </button></div>`;
                
                html += `
                    <div class="poi-item" id="poi-item-${poi.id}">
                        <a href="#" onclick="handlePoiClick(event, '${poi.id}')" class="poi-name">
                            <span class="poi-number">${index + 1}. </span>
                            <span class="poi-name-wrapper">
                                <span class="poi-name-content">${poiName}</span>
                            </span>
                        </a>
                        <div class="poi-info">
                            ${infoHtml}
                        </div>
                        ${photoHtml}
                    </div>
                `;
            });
            listContainer.innerHTML = html;
            updateSortButtonStyles();
        }
        
        /**
         * æ ¹æ®è®¾å¤‡ç±»å‹ç”Ÿæˆè·³è½¬é«˜å¾·åœ°å›¾çš„URL
         * @param {object} poi - POIå¯¹è±¡
         * @returns {string} - è·³è½¬é“¾æ¥
         */
        function getMapUrl(poi) {
            const poiName = encodeURIComponent(poi.name);
            const locationParts = poi.location.split(',');
            const lon = locationParts[0];
            const lat = locationParts[1];
            const deviceType = getDeviceType();

            switch (deviceType) {
                case 'ios':
                    return `iosamap://viewMap?poiname=${poiName}&lat=${lat}&lon=${lon}&dev=0`;
                case 'android':
                    return `androidamap://viewMap?poiname=${poiName}&lat=${lat}&lon=${lon}&dev=0`;
                case 'wechat':
                    // å¾®ä¿¡ä¸­ä½¿ç”¨ç‰¹æ®ŠURLï¼Œä¼šè§¦å‘å¾®ä¿¡å¼•å¯¼è’™å±‚
                    return `/#poiId=${poi.id}`;
                case 'pc':
                default:
                    // PCç«¯ä½¿ç”¨æ ‡å‡†é«˜å¾·åœ°å›¾ç½‘é¡µ
                    return `https://www.amap.com/place/${poi.id}`;
            }
        }
        
        /**
         * æ›´æ–°æ’åºæŒ‰é’®çš„æ ·å¼
         */
        function updateSortButtonStyles() {
            const buttons = document.querySelectorAll('.sort-buttons button');
            buttons.forEach(button => {
                if (button.dataset.sort === currentDisplaySort) {
                    button.classList.add('active');
                } else {
                    button.classList.remove('active');
                }
            });
            
            const comprehensiveBtn = document.querySelector('button[data-sort="comprehensive"]');
            if (comprehensiveBtn) {
                comprehensiveBtn.textContent = comprehensiveSortMode === 'cost_effective' ? 'æ€§ä»·æ¯”ç»¼åˆ' : 'é«˜æ¡£ç»¼åˆ';
            }
        }
        
        /**
         * æ ¼å¼åŒ–ç”µè¯å·ç å­—ç¬¦ä¸²
         * - å»é™¤é‡å¤å·ç 
         * - å»é™¤æœ«å°¾çš„ ',0'
         * - ç”¨ ' / ' è¿æ¥å¤šä¸ªå·ç 
         * @param {string} telString - åŸå§‹ç”µè¯å·ç å­—ç¬¦ä¸²
         * @returns {string} æ ¼å¼åŒ–åçš„ç”µè¯å·ç 
         */
        function formatPhoneNumber(telString) {
            if (!telString || typeof telString !== 'string') {
                return 'æš‚æ— ç”µè¯';
            }
            
            const numbers = telString.split(';').map(num => {
                let cleanedNum = num.trim();
                // ä¸“é—¨å¤„ç†APIå¯èƒ½è¿”å›çš„æœ«å°¾ä¸º ',0' çš„æƒ…å†µ
                if (cleanedNum.endsWith(',0')) {
                    cleanedNum = cleanedNum.substring(0, cleanedNum.length - 2);
                }
                return cleanedNum;
            });

            const uniqueNumbers = [...new Set(numbers.filter(n => n))]; // è¿‡æ»¤ç©ºå­—ç¬¦ä¸²å¹¶å»é‡

            if (uniqueNumbers.length === 0) {
                return 'æš‚æ— ç”µè¯';
            }

            // Wrap each number in a span to prevent it from breaking midway
            return uniqueNumbers.map(n => `<span style="white-space: nowrap;">${n}</span>`).join('<br>');
        }
        
        /**
         * æ„å»ºå®Œæ•´åœ°å€
         */
        function buildFullAddress(poi) {
            const addressParts = [];
            if (poi.cityname) addressParts.push(poi.cityname);
            if (poi.adname) addressParts.push(poi.adname);
            if (poi.address) addressParts.push(poi.address);
            return addressParts.join('') || 'åœ°å€æœªçŸ¥';
        }

        /**
         * å¤„ç†å¹¶æ˜¾ç¤ºä¸­å¿ƒç‚¹POIä¿¡æ¯
         * @param {object} poi - POIå¯¹è±¡
         * @param {boolean} fromCache - æ˜¯å¦æ¥è‡ªç¼“å­˜
         */
        function processLocationPoi(poi, fromCache = false) {
            const location = poi.location;
            if (!location) {
                throw new Error('APIè¿”å›çš„POIä¸­ç¼ºå°‘åæ ‡ä¿¡æ¯ã€‚');
            }
            const [longitude, latitude] = location.split(',');
            document.getElementById('longitude').value = longitude;
            document.getElementById('latitude').value = latitude;
            
            const addressParts = [];
            if (poi.pname) addressParts.push(poi.pname);
            if (poi.cityname && poi.cityname !== poi.pname) addressParts.push(poi.cityname);
            if (poi.adname) addressParts.push(poi.adname);
            if (poi.address) addressParts.push(poi.address);
            const fullAddress = addressParts.join('') || 'åœ°å€æœªçŸ¥';

            const statusDiv = document.getElementById('locationStatus');
            statusDiv.innerHTML = `<div class="success">âœ… åæ ‡è·å–æˆåŠŸï¼<br><strong></strong> ${poi.name}<br><strong></strong> ${fullAddress}</div>`;
            document.getElementById('nearby-search-section').style.display = 'block';
            
            // æˆåŠŸå¤„ç†åï¼Œæ›´æ–°"ä¸Šä¸€æ¬¡çš„å…³é”®å­—"
            lastLocationKeyword = document.getElementById('locationKeyword').value.trim();
        }

        /**
         * æ¸²æŸ“å¤šä¸ªä¸­å¿ƒç‚¹é€‰é¡¹
         * @param {Array<object>} pois - POIæ•°ç»„
         * @param {boolean} recommendCity - æ˜¯å¦æ˜¾ç¤ºæ¨èè¾“å…¥åŸå¸‚çš„æç¤º
         */
        function renderLocationChoices(pois, recommendCity = false) {
            locationChoices = pois;
            const statusDiv = document.getElementById('locationStatus');
            
            let promptHtml;
            if (recommendCity) {
                // New structure using grid for alignment
                promptHtml = `
                    <div class="info-prompt recommend-grid">
                        <div class="recommend-emoji">ğŸ’¡</div>
                        <div class="recommend-line-1">è¯·é€‰æ‹©ä»¥ä¸‹åæ ‡ä¸­çš„ä¸€ä¸ª:</div>
                        <div class="recommend-text">æ¨èè¾“å…¥åŒ…å«åŸå¸‚çš„åœ°ç‚¹ä»¥ç²¾ç¡®å®šä½</div>
                    </div>`;
            } else {
                if (isCurrentLocationSelection) {
                    promptHtml = `<div class="success">è¯·é€‰æ‹©æ‚¨æ‰€åœ¨çš„ä½ç½®:(ç”±è¿‘åˆ°è¿œ)</div>`;
                } else {
                    promptHtml = `<div class="success">è¯·é€‰æ‹©ä»¥ä¸‹åæ ‡ä¸­çš„ä¸€ä¸ª:</div>`;
                }
            }

            let choicesHtml = promptHtml;
            
            pois.forEach((poi, index) => {
                const fullAddress = buildFullAddress(poi);
                choicesHtml += `
                    <div class="location-choice" onclick="selectLocation(${index})">
                        <strong>${poi.name}</strong><br>
                        <small>${fullAddress}</small>
                    </div>
                `;
            });
            
            statusDiv.innerHTML = choicesHtml;
            document.getElementById('nearby-search-section').style.display = 'none'; // Ensure this is hidden
        }

        /**
         * ä»å¤šä¸ªé€‰é¡¹ä¸­é€‰æ‹©ä¸€ä¸ªä¸­å¿ƒç‚¹
         * @param {number} index - æ‰€é€‰POIåœ¨locationChoicesæ•°ç»„ä¸­çš„ç´¢å¼•
         */
        function selectLocation(index) {
            const selectedPoi = locationChoices[index];
            
            // æ›´æ–°ä¸¤ä¸ªè¾“å…¥æ¡†ä¸ºæ‰€é€‰çš„åœ°å
            const mobileInput = document.getElementById('locationKeyword');
            const desktopInput = document.getElementById('locationKeywordDesktop');

            if (mobileInput) mobileInput.value = selectedPoi.name;
            if (desktopInput) desktopInput.value = selectedPoi.name;

            // æ¸…ç†é€‰é¡¹
            locationChoices = [];
            
            if (isCurrentLocationSelection) {
                // æ¥è‡ªé«˜å¾·å®šä½ï¼šåªå¡«å…¥æ–‡æœ¬æ¡†ï¼Œè®¾ç½®æŒ‰é’®çŠ¶æ€ï¼Œä¸ç¼“å­˜
                isCurrentLocationSelection = false;
                updateSearchButtonState('completed');
                // å¤„ç†æ‰€é€‰POI
                processLocationPoi(selectedPoi, false);
                // æ›´æ–°å…³é”®å­—ä½†ä¸ç¼“å­˜åˆ°locationCacheï¼ˆé«˜å¾·å®šä½æ¯æ¬¡éƒ½é‡æ–°è·å–ï¼‰
                lastLocationKeyword = selectedPoi.name;
            } else {
                // æ¥è‡ªæ‰‹åŠ¨è¾“å…¥ï¼šæ­£å¸¸å¤„ç†å¹¶ç¼“å­˜
            processLocationPoi(selectedPoi, false);
                updateSearchButtonState('completed');
            // ä½¿ç”¨æ–°çš„ã€æ˜ç¡®çš„åœ°åä½œä¸ºé”®æ¥ç¼“å­˜é€‰æ‹©
            locationCache[selectedPoi.name] = { pois: [selectedPoi], cityMatch: true };
            // æˆåŠŸé€‰æ‹©åï¼ŒåŒæ ·æ›´æ–°"ä¸Šä¸€æ¬¡çš„å…³é”®å­—"
            lastLocationKeyword = selectedPoi.name;
        }
        }

        /* ===============================================
           ä¸­å¿ƒç‚¹å®šä½ä¸é€‰æ‹©
           =============================================== */
        
        // æŒ‰é’®çŠ¶æ€ç®¡ç†
        function updateSearchButtonState(state) {
            const mobileBtn = document.getElementById('searchLocationBtn');
            const desktopBtn = document.getElementById('searchLocationBtnDesktop');
            
            const updateBtn = (btn) => {
                if (!btn) return;
                switch (state) {
                    case 'completed':
                        btn.textContent = 'âœ… å·²è·å–ä½ç½®';
                        btn.disabled = true;
                        btn.style.backgroundColor = '#ccc';
                        btn.style.cursor = 'not-allowed';
                        break;
                    case 'normal':
                    default:
                        btn.textContent = 'ğŸ“ è·å–è¯¥ä½ç½®';
                        btn.disabled = false;
                        btn.style.backgroundColor = '';
                        btn.style.cursor = 'pointer';
                        break;
                }
            };
            
            updateBtn(mobileBtn);
            updateBtn(desktopBtn);
        }
        
        // è¾“å…¥æ¡†å˜åŒ–ç›‘å¬
        function onLocationInputChange() {
            // åŒæ­¥è¾“å…¥æ¡†å†…å®¹
            const mobileInput = document.getElementById('locationKeyword');
            const desktopInput = document.getElementById('locationKeywordDesktop');
            
            // ç¡®å®šæ˜¯å“ªä¸ªè¾“å…¥æ¡†å‘ç”Ÿäº†å˜åŒ–ï¼Œå¹¶åŒæ­¥åˆ°å¦ä¸€ä¸ª
            if (event && event.target) {
                if (event.target.id === 'locationKeyword') {
                    if (desktopInput) desktopInput.value = event.target.value;
                } else if (event.target.id === 'locationKeywordDesktop') {
                    if (mobileInput) mobileInput.value = event.target.value;
                }
            }
            
            // å½“è¾“å…¥æ¡†å†…å®¹å˜åŒ–æ—¶ï¼Œæ¢å¤æŒ‰é’®çŠ¶æ€
            updateSearchButtonState('normal');
        }
        
        // é«˜å¾·å®šä½åŠŸèƒ½
        async function getCurrentLocation() {
            // æ£€æŸ¥æ˜¯å¦ä¸ºç”µè„‘ç«¯
            const deviceInfo = detectDeviceType();
            if (deviceInfo.isDesktop) {
                alert('è¯¥åŠŸèƒ½ä»…åœ¨ç§»åŠ¨è®¾å¤‡ä¸Šå¯ç”¨ã€‚è¯·åœ¨æ‰‹æœºæˆ–å¹³æ¿ç”µè„‘ä¸Šè®¿é—®æ­¤é¡µé¢ä½¿ç”¨å®šä½åŠŸèƒ½ã€‚');
                return;
            }

            const currentLocationBtn = document.getElementById('currentLocationBtn');
            const statusDiv = document.getElementById('locationStatus');
            const nearbySection = document.getElementById('nearby-search-section');
            
            // éšè—å‘¨è¾¹æœç´¢åŒºåŸŸ
            nearbySection.style.display = 'none';
            document.getElementById('results').innerHTML = '';
            
            // é‡ç½®"è·å–è¯¥ä½ç½®"æŒ‰é’®åˆ°æ­£å¸¸çŠ¶æ€
            updateSearchButtonState('normal');
            
            // è®¾ç½®æŒ‰é’®çŠ¶æ€
            currentLocationBtn.disabled = true;
            currentLocationBtn.textContent = 'ğŸ”„ å®šä½ä¸­...';
            statusDiv.innerHTML = `<div class="loading">æ­£åœ¨è·å–æ‚¨çš„å½“å‰ä½ç½®...</div>`;
            
            try {
                if (typeof AMap === 'undefined') {
                    throw new Error('é«˜å¾·APIæœªåŠ è½½');
                }

                AMap.plugin('AMap.Geolocation', function() {
                    const geolocation = new AMap.Geolocation({
                        enableHighAccuracy: true,
                        timeout: 15000,
                        maximumAge: 0,  // ä¸ä½¿ç”¨ç¼“å­˜
                        convert: true
                    });

                    geolocation.on('complete', async function(result) {
                        try {
                            let lat = result.position.lat;
                            let lng = result.position.lng;
                            const isConverted = result.info?.isConverted || false;
                            
                            // å¦‚æœæœªè½¬æ¢ï¼Œæ‰‹åŠ¨è½¬æ¢åæ ‡ç³»
                            if (!isConverted) {
                                try {
                                    const url = `https://restapi.amap.com/v3/assistant/coordinate/convert?locations=${lng},${lat}&coordsys=gps&output=json&key=dcfb48c0f9cb749e59c5031e83cb6e95`;
                                    const response = await fetch(url);
                                    const data = await response.json();
                                    
                                    if (data.status === '1' && data.locations) {
                                        const [gcjLng, gcjLat] = data.locations.split(',').map(Number);
                                        lng = gcjLng;
                                        lat = gcjLat;
                                    }
                                } catch (error) {
                                    console.log('åæ ‡è½¬æ¢å¤±è´¥ï¼Œä½¿ç”¨åŸåæ ‡:', error);
                                }
                            }
                            
                            // è·å–å‘¨è¾¹POI (åŠå¾„100ç±³ï¼Œæœ€å¤š5ä¸ª)
                            const nearbyPois = await getNearbyPOIs(lng, lat);
                            
                            if (nearbyPois && nearbyPois.length > 0) {
                                // æ ‡è®°ä¸ºé«˜å¾·å®šä½é€‰æ‹©
                                isCurrentLocationSelection = true;
                                // ä½¿ç”¨ç°æœ‰çš„åœ°ç‚¹é€‰æ‹©UI
                                renderLocationChoices(nearbyPois, false);
                            } else {
                                // å¦‚æœæ²¡æœ‰POIï¼Œè¿›è¡Œé€†åœ°ç†ç¼–ç è·å–åœ°å€
                                const address = await reverseGeocode(lng, lat);
                                if (address) {
                                    // åˆ›å»ºä¸€ä¸ªè™šæ‹ŸPOIå¯¹è±¡
                                    const virtualPoi = {
                                        name: address,
                                        location: `${lng},${lat}`,
                                        address: address,
                                        pname: '',
                                        cityname: '',
                                        adname: ''
                                    };
                                    processLocationPoi(virtualPoi, false);
                                } else {
                                    statusDiv.innerHTML = `<div class="error">æ— æ³•è·å–ä½ç½®ä¿¡æ¯</div>`;
                                }
                            }
                            
                        } catch (error) {
                            statusDiv.innerHTML = `<div class="error">å®šä½å¤„ç†å¤±è´¥: ${error.message}</div>`;
                            isCurrentLocationSelection = false; // é‡ç½®æ ‡å¿—
                        } finally {
                            currentLocationBtn.disabled = false;
                            currentLocationBtn.textContent = 'ğŸ“ é«˜å¾·å®šä½';
                        }
                    });

                    geolocation.on('error', function(error) {
                        statusDiv.innerHTML = `<div class="error">å®šä½å¤±è´¥: ${error.message || error.info}</div>`;
                        isCurrentLocationSelection = false; // é‡ç½®æ ‡å¿—
                        currentLocationBtn.disabled = false;
                        currentLocationBtn.textContent = 'ğŸ“ é«˜å¾·å®šä½';
                    });

                    geolocation.getCurrentPosition();
                });

            } catch (error) {
                statusDiv.innerHTML = `<div class="error">å®šä½åˆå§‹åŒ–å¤±è´¥: ${error.message}</div>`;
                isCurrentLocationSelection = false; // é‡ç½®æ ‡å¿—
                currentLocationBtn.disabled = false;
                currentLocationBtn.textContent = 'ğŸ“ é«˜å¾·å®šä½';
            }
        }
        
        // è·å–å‘¨è¾¹POI - é€æ­¥æ‰©å¤§æœç´¢èŒƒå›´
        async function getNearbyPOIs(lng, lat) {
            const searchRadii = [100, 500, 2000]; // æœç´¢åŠå¾„ï¼š100ç±³ -> 500ç±³ -> 2000ç±³
            let allPois = [];
            let formattedAddress = '';
            let addressComponent = {};
            
            try {
                for (const radius of searchRadii) {
                    console.log(`æœç´¢åŠå¾„ ${radius}ç±³...`);
                    
                    const url = `https://restapi.amap.com/v3/geocode/regeo?location=${lng},${lat}&key=dcfb48c0f9cb749e59c5031e83cb6e95&radius=${radius}&extensions=all&output=json`;
                    const response = await fetch(url);
                    const data = await response.json();
                    
                    if (data.status === '1' && data.regeocode) {
                        // ä¿å­˜åœ°å€ä¿¡æ¯ï¼ˆç¬¬ä¸€æ¬¡è·å–æ—¶ï¼‰
                        if (!formattedAddress && data.regeocode.formatted_address) {
                            formattedAddress = data.regeocode.formatted_address;
                            addressComponent = data.regeocode.addressComponent || {};
                        }
                        
                        // è·å–æ­¤åŠå¾„ä¸‹çš„POI
                        if (data.regeocode.pois && data.regeocode.pois.length > 0) {
                            const newPois = data.regeocode.pois;
                            
                            // å»é‡ï¼ˆé¿å…ä¸åŒåŠå¾„æœç´¢åˆ°é‡å¤POIï¼‰
                            const existingNames = new Set(allPois.map(poi => poi.name));
                            const uniqueNewPois = newPois.filter(poi => !existingNames.has(poi.name));
                            
                            // æ·»åŠ æ–°çš„POIåˆ°æ€»åˆ—è¡¨
                            uniqueNewPois.forEach(poi => {
                                allPois.push({
                                    name: poi.name,
                                    location: poi.location || `${lng},${lat}`,
                                    address: poi.address || '',
                                    pname: addressComponent.province || '',
                                    cityname: addressComponent.city || '',
                                    adname: addressComponent.district || '',
                                    distance: poi.distance,
                                    searchRadius: radius // è®°å½•æœç´¢åŠå¾„
                                });
                            });
                            
                            console.log(`åŠå¾„ ${radius}ç±³: æ–°å¢ ${uniqueNewPois.length} ä¸ªPOIï¼Œæ€»è®¡ ${allPois.length} ä¸ª`);
                            
                            // å¦‚æœå·²ç»æ‰¾åˆ°5ä¸ªæˆ–æ›´å¤šPOIï¼Œåœæ­¢æœç´¢
                            if (allPois.length >= 5) {
                                console.log(`å·²æ‰¾åˆ°è¶³å¤Ÿçš„POI (${allPois.length}ä¸ª)ï¼Œåœæ­¢æ‰©å¤§æœç´¢èŒƒå›´`);
                                break;
                            }
                        }
                    }
                }
                
                // æŒ‰è·ç¦»æ’åºï¼Œå–å‰5ä¸ª
                allPois.sort((a, b) => parseFloat(a.distance) - parseFloat(b.distance));
                const resultPois = allPois.slice(0, 5);
                
                // å¦‚æœä»ç„¶ä¸å¤Ÿ5ä¸ªï¼Œæ·»åŠ "å½“å‰ä½ç½®"ä½œä¸ºé€‰é¡¹
                if (resultPois.length < 5 && formattedAddress) {
                    resultPois.push({
                        name: 'å½“å‰ä½ç½®',
                        location: `${lng},${lat}`,
                        address: formattedAddress,
                        pname: addressComponent.province || '',
                        cityname: addressComponent.city || '',
                        adname: addressComponent.district || '',
                        distance: '0',
                        searchRadius: 0
                    });
                }
                
                console.log(`æœ€ç»ˆè¿”å› ${resultPois.length} ä¸ªåœ°ç‚¹é€‰é¡¹`);
                return resultPois;
                
            } catch (error) {
                console.error('è·å–å‘¨è¾¹POIå¤±è´¥:', error);
                return [];
            }
        }
        
        // é€†åœ°ç†ç¼–ç 
        async function reverseGeocode(lng, lat) {
            try {
                const url = `https://restapi.amap.com/v3/geocode/regeo?location=${lng},${lat}&key=dcfb48c0f9cb749e59c5031e83cb6e95&radius=50&extensions=base&output=json`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.status === '1' && data.regeocode) {
                    return data.regeocode.formatted_address;
                }
                return null;
            } catch (error) {
                console.error('é€†åœ°ç†ç¼–ç å¤±è´¥:', error);
                return null;
            }
        }

        // è·å–å½“å‰æ¿€æ´»çš„è¾“å…¥æ¡†å€¼
        function getCurrentLocationKeyword() {
            const deviceInfo = detectDeviceType();
            let locationKeyword = '';
            
            if (deviceInfo.isDesktop) {
                const desktopInput = document.getElementById('locationKeywordDesktop');
                locationKeyword = desktopInput ? desktopInput.value.trim() : '';
            } else {
                const mobileInput = document.getElementById('locationKeyword');
                locationKeyword = mobileInput ? mobileInput.value.trim() : '';
            }
            
            return locationKeyword || 'æ­å·è¥¿æ¹–';
        }

        async function searchLocationByKeyword(isAutomated = false) {
            let locationKeyword = getCurrentLocationKeyword();

            const statusDiv = document.getElementById('locationStatus');
            const nearbySection = document.getElementById('nearby-search-section');
            
            // è·å–å½“å‰æ´»è·ƒçš„æŒ‰é’®
            const deviceInfo = detectDeviceType();
            const searchBtn = deviceInfo.isDesktop ? 
                document.getElementById('searchLocationBtnDesktop') : 
                document.getElementById('searchLocationBtn');
            
            // åªæœ‰å½“å…³é”®å­—æ”¹å˜æ—¶ï¼Œæ‰æ¸…ç©ºç»“æœå’Œç¼“å­˜
            if (locationKeyword !== lastLocationKeyword) {
                originalDistanceSortedPois = []; 
                searchCache = {}; // æ¸…ç©ºå‘¨è¾¹æœç´¢ç¼“å­˜
                cachedSortedResults = { distance: [], rating: [], cost_effective: [], high_end: [] };
                document.getElementById('results').innerHTML = ''; 
                nearbySection.style.display = 'none'; // ä¿®æ”¹ä¸­å¿ƒç‚¹æ—¶éšè—ä¸‹æ–¹å†…å®¹
            }

            // æ£€æŸ¥ä¸­å¿ƒç‚¹ç¼“å­˜
            if (locationCache[locationKeyword]) {
                try {
                    const cachedResult = locationCache[locationKeyword];
                    
                    if (cachedResult && cachedResult.pois) {
                        const pois = cachedResult.pois;
                        const recommendCity = !cachedResult.cityMatch;

                        if (pois.length > 1) {
                            // ä»ç¼“å­˜åŠ è½½å¤šä¸ªé€‰é¡¹ï¼Œæ¢å¤æŒ‰é’®æ­£å¸¸çŠ¶æ€ç­‰å¾…ç”¨æˆ·é€‰æ‹©
                            const searchBtn = document.getElementById('searchLocationBtn');
                            searchBtn.disabled = false;
                            searchBtn.textContent = 'ğŸ“ è·å–è¯¥ä½ç½®';
                            renderLocationChoices(pois, recommendCity);
                            // é€‰æ‹©åä¼šåœ¨selectLocationä¸­è®¾ç½®æŒ‰é’®çŠ¶æ€
                        } else if (pois.length === 1) {
                            processLocationPoi(pois[0], true);
                            updateSearchButtonState('completed');
                        } else {
                            statusDiv.innerHTML = `<div class="error">æ²¡æœ‰æ‰¾åˆ°æ»¡è¶³æ‚¨è¦æ±‚çš„åæ ‡</div>`;
                        }

                    } else {
                        throw new Error("Invalid cache format.");
                    }
                } catch (error) {
                    statusDiv.innerHTML = `<div class="error">ç¼“å­˜æ•°æ®å¤„ç†å¤±è´¥: ${error.message}</div>`;
                    delete locationCache[locationKeyword]; // ç§»é™¤é”™è¯¯çš„ç¼“å­˜
                }
                return; // ä»ç¼“å­˜åŠ è½½åç›´æ¥è¿”å›
            }

            searchBtn.disabled = true;
            searchBtn.textContent = 'ğŸ”„ æœç´¢ä¸­...';
            statusDiv.innerHTML = `<div class="loading">æ­£åœ¨é€šè¿‡å…³é”®å­—è·å–åæ ‡...</div>`;
            
            // é‡ç½®é«˜å¾·å®šä½é€‰æ‹©æ ‡å¿—ï¼ˆç¡®ä¿æ‰‹åŠ¨æœç´¢æ—¶çš„å¤„ç†é€»è¾‘æ­£ç¡®ï¼‰
            isCurrentLocationSelection = false;
            
            let matchedCity = '';
            for (const city of CHINESE_CITIES) {
                const cityName = city.replace(/å¸‚|çœ|è‡ªæ²»åŒº|ç‰¹åˆ«è¡Œæ”¿åŒº/, '');
                if (locationKeyword.includes(cityName) && cityName) {
                    matchedCity = city;
                    break;
                }
            }
            
            const params = {
                keywords: locationKeyword,
                page_num: '1',
                page_size: '5' // Always fetch up to 5 results
            };

            if (matchedCity) {
                params.region = matchedCity;
            }

            let searchSuccess = false;

            try {
                const data = await callGaodeAPI('v5/place/text', params);
                let poisToProcess = (data.status === '1' && data.pois) ? data.pois : [];

                // If a city was matched, strictly filter results on the client-side
                if (matchedCity && poisToProcess.length > 0) {
                    const targetCityName = matchedCity.replace(/å¸‚|çœ|è‡ªæ²»åŒº|ç‰¹åˆ«è¡Œæ”¿åŒº/, '');
                    poisToProcess = poisToProcess.filter(poi => {
                        return poi.cityname && poi.cityname.includes(targetCityName);
                    });
                }

                if (poisToProcess.length > 0) {
                    searchSuccess = true;
                    // Cache the result along with whether a city was matched
                    locationCache[locationKeyword] = { pois: poisToProcess, cityMatch: !!matchedCity };
                    
                    if (isAutomated) {
                        // è‡ªåŠ¨åŒ–æµç¨‹ï¼Œç›´æ¥é€‰æ‹©ç¬¬ä¸€ä¸ªç»“æœ
                        processLocationPoi(poisToProcess[0], false);
                        updateSearchButtonState('completed');
                    } else {
                        // æ‰‹åŠ¨æµç¨‹ï¼šæ˜¾ç¤ºé€‰é¡¹æˆ–ç›´æ¥å¤„ç†
                        if (poisToProcess.length > 1 || !matchedCity) {
                            // æœç´¢æˆåŠŸï¼Œå…ˆæ¢å¤æŒ‰é’®æ­£å¸¸çŠ¶æ€ï¼Œç­‰å¾…ç”¨æˆ·é€‰æ‹©
                            searchBtn.disabled = false;
                            searchBtn.textContent = 'ğŸ“ è·å–è¯¥ä½ç½®';
                            renderLocationChoices(poisToProcess, !matchedCity);
                            // é€‰æ‹©åä¼šåœ¨selectLocationä¸­è®¾ç½®æŒ‰é’®çŠ¶æ€
                        } else {
                            processLocationPoi(poisToProcess[0], false);
                            updateSearchButtonState('completed');
                        }
                    }
                } else {
                    statusDiv.innerHTML = `<div class="error">æ²¡æœ‰æ‰¾åˆ°æ»¡è¶³æ‚¨è¦æ±‚çš„åæ ‡</div>`;
                }
            } catch (error) {
                statusDiv.innerHTML = `<div class="error">ä¸­å¿ƒç‚¹åæ ‡è·å–å¤±è´¥: ${error.message}</div>`;
                document.getElementById('longitude').value = '';
                document.getElementById('latitude').value = '';
            } finally {
                if (!searchSuccess) {
                    // åªæœ‰åœ¨å¤±è´¥æ—¶æ‰æ¢å¤æ­£å¸¸çŠ¶æ€
                searchBtn.disabled = false;
                    searchBtn.textContent = 'ğŸ“ è·å–è¯¥ä½ç½®';
                }
            }
        }

        /* ===============================================
           æœç´¢æ‰§è¡Œä¸ç»“æœå¤„ç†
           =============================================== */
        async function searchNearby() {
            originalDistanceSortedPois = [];
            cachedSortedResults = { distance: [], rating: [], cost_effective: [], high_end: [] };
            currentDisplaySort = 'rating';
            comprehensiveSortMode = 'cost_effective';
            
            const resultsDiv = document.getElementById('results');
            const currentHeight = resultsDiv.offsetHeight;
            resultsDiv.style.minHeight = `${currentHeight > 0 ? currentHeight : 80}px`;

            resultsDiv.innerHTML = `
                <div class="result-section" id="search-status-section">
                    <h3>ğŸ”„ æ­£åœ¨æœç´¢åœ°ç‚¹åˆ—è¡¨ï¼Œè¯·ç¨å€™...</h3>
                </div>
            `;

            await sleep(50);
            await doSearch();
        }

        /**
         * æ ¸å¿ƒçš„æœç´¢æ‰§è¡Œå‡½æ•°
         */
        async function doSearch() {
            const params = getSearchParams();
            const totalPagesToFetch = parseInt(params.page_num, 10);
            let isPoiTypeSearch = false;

            if (!validateParams(params)) {
                return;
            }
            
            const userInput = params.keywords;
            let finalTypes = null;
            let finalKeywords = userInput;

            // æœ€é«˜ä¼˜å…ˆçº§ï¼šæ£€æŸ¥è¾“å…¥æ˜¯å¦ä¸º6ä½POIä»£ç 
            if (/^\d{6}$/.test(userInput)) {
                finalTypes = userInput;
                finalKeywords = '';
                isPoiTypeSearch = true;
            } else {
                // å¸¸è§„é€»è¾‘ï¼šé€šè¿‡å…³é”®å­—æŸ¥æ‰¾POIç±»å‹ (å®Œå…¨åŒ¹é…)
                const matchedPoiType = findPoiTypeByKeyword(userInput);
                if (matchedPoiType) {
                    finalTypes = matchedPoiType;
                    finalKeywords = '';
                    isPoiTypeSearch = true;
                }
            }
            
            // æ ¹æ®æœ€ç»ˆç¡®å®šçš„å‚æ•°ç”Ÿæˆç¼“å­˜é”®
            const cacheKey = JSON.stringify({ 
                types: finalTypes || '', 
                keywords: finalKeywords, 
                location: params.location, 
                radius: params.radius, 
                page_num: totalPagesToFetch 
            });

            // æ£€æŸ¥ç¼“å­˜
            if (searchCache[cacheKey]) {
                const cached = searchCache[cacheKey];
                
                originalDistanceSortedPois = [...cached.aggregatedData.pois].sort((a, b) => a.distance - b.distance);
                precomputeAndCacheAllSorts(params.requested_count);
                
                let listToDisplay;
                if (currentDisplaySort === 'comprehensive') {
                    listToDisplay = cachedSortedResults[comprehensiveSortMode];
                } else {
                    listToDisplay = cachedSortedResults[currentDisplaySort];
                }

                displayResults(cached.aggregatedData, cached.pagesFetched, listToDisplay, cached.rawFetchedCount, cached.isPoiTypeSearch, true, params);
                return; // å‘½ä¸­ç¼“å­˜ï¼Œç«‹å³è¿”å›
            }
            
            // --- æ ¸å¿ƒæœç´¢é€»è¾‘å¼€å§‹ ---
            const statusH3 = document.querySelector('#search-status-section h3');
            const allPois = [];
            let totalReportedCount = 0;
            let finalStatus = '1';
            let finalInfo = '';
            let finalInfocode = '';
            let lastFetchedPage = 0;
            let pois = [];

            try {
                // --- æ­¥éª¤ 1: è·å–æ‰€æœ‰é¡µçš„åŸºç¡€ POI æ•°æ® ---
                for (let currentPage = 1; currentPage <= totalPagesToFetch; currentPage++) {
                    lastFetchedPage = currentPage;
                    
                    if (statusH3) {
                        statusH3.textContent = `ğŸ”„ æ­£åœ¨æœç´¢åœ°ç‚¹åˆ—è¡¨... (${currentPage}/${totalPagesToFetch})`;
                    }

                    const currentParams = {
                        ...params,
                        page_num: currentPage,
                        sortrule: 'distance',
                        types: finalTypes,
                        keywords: finalKeywords
                    };
                    
                    const requestParams = buildRequestParams(currentParams);

                    const data = await callGaodeAPI('v5/place/around', requestParams);
                    
                    if (data.status !== '1') {
                        finalStatus = data.status;
                        finalInfo = data.info;
                        finalInfocode = data.infocode;
                        break; 
                    }
                    
                    if (currentPage === 1) {
                        totalReportedCount = data.count || 0;
                    }
                    
                    pois = data.pois || [];
                    allPois.push(...pois);

                    if (pois.length === 0) {
                        break;
                    }

                    if (currentPage < totalPagesToFetch) {
                        await sleep(150);
                    }
                }
                
                // --- æ­¥éª¤ 2 & 3: å¤„ç†å’Œå±•ç¤ºæœ€ç»ˆæ•°æ® (è¯¦æƒ…å·²åœ¨æ­¥éª¤1è·å–) ---
                if (statusH3) {
                    statusH3.textContent = `âœ… æœç´¢å®Œæˆï¼Œæ­£åœ¨å¤„ç†æ•°æ®...`;
                }

                let pagesToDisplay = lastFetchedPage;
                if (pois.length === 0 && lastFetchedPage > 0) {
                    pagesToDisplay = lastFetchedPage - 1;
                }

                const rawFetchedCount = allPois.length;
                const uniquePois = deduplicatePois(allPois);

                const aggregatedData = {
                    status: finalStatus,
                    info: finalInfo,
                    infocode: finalInfocode,
                    count: totalReportedCount,
                    pois: uniquePois
                };

                originalDistanceSortedPois = [...uniquePois].sort((a, b) => a.distance - b.distance);
                precomputeAndCacheAllSorts(params.requested_count);
                
                const initialPoisToDisplay = cachedSortedResults[comprehensiveSortMode];

                const dataToCache = {
                    aggregatedData: aggregatedData,
                    pagesFetched: pagesToDisplay,
                    rawFetchedCount: rawFetchedCount,
                    isPoiTypeSearch: isPoiTypeSearch
                };
                searchCache[cacheKey] = dataToCache;
                
                displayResults(aggregatedData, pagesToDisplay, cachedSortedResults['rating'], rawFetchedCount, isPoiTypeSearch, false, params);

            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">è¯·æ±‚å¤±è´¥: ${error.message}</div>`;
            }
        }
        
        /**
         * è·å–æœç´¢å‚æ•°
         */
        function getSearchParams() {
            const requestedCount = parseInt(document.getElementById('totalCount').value, 10) || 0;
            // è®¡ç®—éœ€è¦è¯·æ±‚çš„é¡µæ•°ï¼Œç¡®ä¿èƒ½è¦†ç›–ç”¨æˆ·è¯·æ±‚çš„æ•°é‡
            const pageNum = requestedCount > 0 ? Math.ceil(requestedCount / 25) : 0;

            return {
                keywords: document.getElementById('keywords').value.trim(),
                location: `${document.getElementById('longitude').value},${document.getElementById('latitude').value}`,
                radius: document.getElementById('radius').value,
                page_num: pageNum,
                page_size: 25, // æ¯é¡µæ•°é‡å›ºå®šä¸º25
                requested_count: requestedCount // æŠŠç”¨æˆ·è¯·æ±‚çš„æ•°é‡ä¹Ÿä¼ å‡ºå»
            };
        }
        
        /**
         * éªŒè¯å‚æ•°
         */
        function validateParams(params) {
            const [lng, lat] = params.location.split(',');
            if (!lng || !lat || isNaN(lng) || isNaN(lat)) {
                alert('ä¸­å¿ƒç‚¹ä½ç½®æœªè·å–ï¼');
                return false;
            }

            if (!params.keywords) {
                alert('è¯·è¾“å…¥å‘¨è¾¹æœç´¢å…³é”®å­—ï¼');
                return false;
            }
            
            return true;
        }
        
        /**
         * æ„å»ºè¯·æ±‚å‚æ•°
         */
        function buildRequestParams(params) {
            // åŸºç¡€å‚æ•°ï¼Œä¸åŒ…å«keywordså’Œtypesï¼Œé¿å…æ±¡æŸ“
            const requestParams = {
                location: params.location,
                radius: params.radius,
                page_num: params.page_num,
                page_size: params.page_size,
                sortrule: params.sortrule,
                ...CONFIG.DEFAULT_PARAMS
            };

            // æ ¹æ®æœ€ç»ˆç¡®å®šçš„å‚æ•°ï¼Œåªæ·»åŠ å…¶ä¸­ä¸€ä¸ªï¼Œç¡®ä¿è¯·æ±‚çº¯ç²¹æ€§
            if (params.types) {
                requestParams.types = params.types;
            } else if (params.keywords) {
                requestParams.keywords = params.keywords;
            }
            
            return requestParams;
        }
        
        /**
         * æ˜¾ç¤ºæœç´¢ç»“æœ
         */
        function displayResults(data, pagesFetched, initialPois, rawFetchedCount, isPoiTypeSearch, isFromCache = false, searchParams = null) {
            const resultsDiv = document.getElementById('results');
            const statusSection = document.getElementById('search-status-section');

            if (!statusSection) {
                resultsDiv.innerHTML = '<div class="error">æ¸²æŸ“é”™è¯¯ï¼šæ‰¾ä¸åˆ°çŠ¶æ€æ˜¾ç¤ºåŒºåŸŸã€‚</div>';
                return;
            }

            const oldPoiList = document.getElementById('poi-list-section');
            if (oldPoiList) oldPoiList.remove();
            const oldRawData = document.querySelector('.raw-data-section');
            if (oldRawData) oldRawData.remove();

            if (data.status === '1') {
                if (searchParams) {
                    lastUsedSearchParams = {
                        radius: searchParams.radius,
                        count: searchParams.requested_count
                    };
                }
                const displayedCount = initialPois.length;
                const searchMessage = isPoiTypeSearch ? 'ç±»å‹æœç´¢æˆåŠŸ' : 'å…³é”®å­—æœç´¢æˆåŠŸ';
                
                let successMessage = `ä¸ºæ‚¨æ‰¾åˆ° ${displayedCount}ä¸ªåœ°ç‚¹ã€‚`;
                
                // æ›´æ–°çŠ¶æ€åŒºåŸŸä¸º"æˆåŠŸ"
                statusSection.innerHTML = `
                    <h3>âœ… ${searchMessage}</h3>
                    <div class="success">
                       ${successMessage}
                    </div>
                `;
                
                if (initialPois.length > 0) {
                    // åˆ›å»ºå¹¶è¿½åŠ æ–°çš„POIåˆ—è¡¨åŒºåŸŸ
                    const poiListSection = document.createElement('div');
                    poiListSection.id = 'poi-list-section';
                    poiListSection.className = 'result-section';

                    poiListSection.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 style="margin: 0;">ğŸ“ åœ°ç‚¹åˆ—è¡¨</h3>
                            <div class="sort-buttons">
                                <button onclick="toggleComprehensiveSort()" data-sort="comprehensive" title="ç‚¹å‡»åˆ‡æ¢ç»¼åˆæ’åºæ¨¡å¼" style="font-size: 13px; padding: 5px 12px; margin-top: 0; min-width: 90px; text-align: center;">æ€§ä»·æ¯”ç»¼åˆ</button>
                                <button onclick="applySort('rating')" data-sort="rating" title="ç‚¹å‡»æŒ‰å¥½è¯„åº¦æ’åº" style="font-size: 13px; padding: 5px 12px; margin-top: 0; margin-left: 5px;">å¥½è¯„ä¼˜å…ˆ</button>
                                <button onclick="applySort('distance')" data-sort="distance" title="ç‚¹å‡»æŒ‰è·ç¦»æ’åº" style="font-size: 13px; padding: 5px 12px; margin-top: 0; margin-left: 5px;">è·ç¦»ä¼˜å…ˆ</button>
                            </div>
                        </div>
                        <div id="poi-list-container"></div>
                    `;
                    resultsDiv.appendChild(poiListSection);
                    
                    renderPoiList(initialPois);
                }

            } else { // é”™è¯¯æƒ…å†µ
                const errorMsg = data.info || 'æœªçŸ¥é”™è¯¯';
                const infoCode = data.infocode || '';
                
                // æ›´æ–°çŠ¶æ€åŒºåŸŸä¸º"å¤±è´¥"
                statusSection.innerHTML = `
                    <h3>âŒ æœç´¢å¤±è´¥</h3>
                    <div class="error">
                        é”™è¯¯ä¿¡æ¯: ${errorMsg}<br>
                        é”™è¯¯ä»£ç : ${infoCode}
                    </div>
                `;
                
                // åˆ›å»ºå¹¶è¿½åŠ åŸå§‹æ•°æ®åŒºåŸŸ
                const rawDataSection = document.createElement('div');
                rawDataSection.className = 'result-section raw-data-section';
                rawDataSection.innerHTML = `
                    <h3>ğŸ“‹ åŸå§‹è¿”å›æ•°æ®</h3>
                    <div class="raw-data">${JSON.stringify(data, null, 2)}</div>
                `;
                resultsDiv.appendChild(rawDataSection);
            }

            const resultsContainer = document.getElementById('results');
            
            // åœ¨æ‰€æœ‰UIæ›´æ–°å®Œæˆåï¼Œå°†çŠ¶æ€åŒºåŸŸæ»šåŠ¨åˆ°è§†å›¾é¡¶éƒ¨
            const statusSectionToScroll = document.getElementById('search-status-section');
            if (statusSectionToScroll) {
                statusSectionToScroll.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }

            // Reset the container's height so it can shrink if needed
            resultsContainer.style.minHeight = '';
        }
        
        /**
         * æ¸²æŸ“æ‰€æœ‰åœ°ç‚¹çš„å›¾ç‰‡å¢™
         */
        function renderPhotoGallery(pois) {
            const gallerySection = document.getElementById('photo-gallery-section');
            const galleryGrid = document.getElementById('photo-gallery-grid');
            if (!gallerySection || !galleryGrid) return;

            const poisWithPhotos = pois.filter(p => p.photos && p.photos.length > 0);

            if (poisWithPhotos.length === 0) {
                gallerySection.style.display = 'block';
                galleryGrid.innerHTML = '<p style="color: #666;">æœ¬æ¬¡æœç´¢çš„æ‰€æœ‰åœ°ç‚¹å‡æœªæ‰¾åˆ°å®˜æ–¹å›¾ç‰‡ã€‚</p>';
                return;
            }
            
            let galleryHtml = '';
            poisWithPhotos.forEach(poi => {
                // æ¯ä¸ªåœ°ç‚¹åªå–ç¬¬ä¸€å¼ å›¾æ”¾å…¥ç”»å»Š
                const photo = poi.photos[0];
                galleryHtml += `
                    <div class="gallery-item">
                        <a href="${photo.url}" target="_blank" title="ç‚¹å‡»æŸ¥çœ‹å¤§å›¾: ${poi.name}">
                            <img src="${photo.url}" alt="${poi.name}" loading="lazy">
                            <div class="poi-name-overlay">${poi.name}</div>
                        </a>
                    </div>
                `;
            });
            
            galleryGrid.innerHTML = galleryHtml;
            gallerySection.style.display = 'block';
        }

        /**
         * å¦‚æœéœ€è¦ï¼Œåˆ™å¹³æ»‘æ»šåŠ¨åˆ°ç»“æœåŒºåŸŸ
         */
        function scrollToResultsIfNeeded() {
            setTimeout(() => {
                document.getElementById('results').scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
        }
        
        // è®¾å¤‡æ£€æµ‹å‡½æ•°
        function detectDeviceType() {
            const userAgent = navigator.userAgent.toLowerCase();
            const isMobile = /android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini|mobile/i.test(userAgent);
            const isTablet = /ipad|android(?!.*mobile)/i.test(userAgent);
            
            return {
                isMobile: isMobile && !isTablet,
                isTablet: isTablet,
                isDesktop: !isMobile && !isTablet,
                userAgent: navigator.userAgent
            };
        }
        
        // æ ¹æ®è®¾å¤‡ç±»å‹è°ƒæ•´UI
        function adjustUIForDevice() {
            const deviceInfo = detectDeviceType();
            const mobileContainer = document.getElementById('mobileLocationContainer');
            const desktopContainer = document.getElementById('desktopLocationContainer');
            const categoryLabel = document.getElementById('categoryLabel');
            
            if (deviceInfo.isDesktop) {
                // ç”µè„‘ç«¯ï¼šæ˜¾ç¤ºç”µè„‘ç«¯å¸ƒå±€ï¼Œéšè—ç§»åŠ¨ç«¯å¸ƒå±€
                if (mobileContainer) {
                    mobileContainer.style.display = 'none';
                }
                if (desktopContainer) {
                    desktopContainer.style.display = 'block';
                }
                // ä¿®æ”¹åˆ†ç±»æ ‡ç­¾ä¸º"2.ç‚¹å‡»åˆ†ç±»æŒ‰é’®æˆ–æ‰‹åŠ¨è¾“å…¥å…³é”®å­—:"
                if (categoryLabel) {
                    categoryLabel.textContent = '2.ç‚¹å‡»åˆ†ç±»æŒ‰é’®æˆ–æ‰‹åŠ¨è¾“å…¥å…³é”®å­—:';
                }
            } else {
                // ç§»åŠ¨ç«¯ï¼šæ˜¾ç¤ºç§»åŠ¨ç«¯ä¸‰è¡Œå¸ƒå±€ï¼Œéšè—ç”µè„‘ç«¯å¸ƒå±€
                if (mobileContainer) {
                    mobileContainer.style.display = 'block';
                }
                if (desktopContainer) {
                    desktopContainer.style.display = 'none';
                }
                // ä¿®æ”¹åˆ†ç±»æ ‡ç­¾ä¸º"3.ç‚¹å‡»åˆ†ç±»æŒ‰é’®æˆ–æ‰‹åŠ¨è¾“å…¥å…³é”®å­—:"
                if (categoryLabel) {
                    categoryLabel.textContent = '3.ç‚¹å‡»åˆ†ç±»æŒ‰é’®æˆ–æ‰‹åŠ¨è¾“å…¥å…³é”®å­—:';
                }
            }
            
            // åŒæ­¥ä¸¤ä¸ªè¾“å…¥æ¡†çš„å€¼
            syncInputFields();
        }
        
        // åŒæ­¥ç§»åŠ¨ç«¯å’Œç”µè„‘ç«¯è¾“å…¥æ¡†çš„å€¼
        function syncInputFields() {
            const mobileInput = document.getElementById('locationKeyword');
            const desktopInput = document.getElementById('locationKeywordDesktop');
            
            if (mobileInput && desktopInput) {
                // ä»¥ç§»åŠ¨ç«¯è¾“å…¥æ¡†ä¸ºå‡†ï¼ŒåŒæ­¥åˆ°ç”µè„‘ç«¯
                desktopInput.value = mobileInput.value;
            }
        }
        
        // ===== é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ– =====
        document.addEventListener('DOMContentLoaded', function() {
            // é¦–å…ˆè°ƒæ•´è®¾å¤‡UI
            adjustUIForDevice();
            
            // æ¸…ç†æ‰ä¹‹å‰ç”¨äº"å¤ç°æœç´¢"ä½†å¤±è´¥äº†çš„ sessionStorage é€»è¾‘ã€‚
            // ç”±äºå¾®ä¿¡å’Œå¤–éƒ¨æµè§ˆå™¨ä¼šè¯éš”ç¦»ï¼Œæ­¤æ–¹æ¡ˆæ— æ•ˆã€‚
            // ä¿ç•™ä¸€ä¸ªå¹²å‡€çš„å¯åŠ¨æµç¨‹ã€‚

            // ===== æ–°å¢ï¼šå¤„ç†ä» /poi/ID?context... è·³è½¬è¿‡æ¥çš„é€»è¾‘ =====
            const path = window.location.pathname;
            const poiMatch = path.match(/^\/poi\/([A-Z0-9]+)$/i); 

            if (poiMatch) {
                const deviceType = getDeviceType();

                const poiId = poiMatch[1];
                const params = new URLSearchParams(window.location.search);
                const context = {
                    poiIdToScroll: poiId,
                    center_name: params.get('center_name'),
                    center_lon: params.get('center_lon'),
                    center_lat: params.get('center_lat'),
                    search_kw: params.get('search_kw'),
                    radius: params.get('radius'),
                    count: params.get('count')
                };

                // ç«‹å³æ¸…ç†URLï¼Œé¿å…ç”¨æˆ·åˆ·æ–°æ—¶é‡å¤è§¦å‘ã€‚
                history.replaceState(null, '', '/');

                // åªæœ‰åœ¨éå¾®ä¿¡ç¯å¢ƒï¼ˆä¾‹å¦‚ä»"åœ¨æµè§ˆå™¨æ‰“å¼€"è·³è½¬è¿‡æ¥åï¼‰æ‰æ‰§è¡Œè‡ªåŠ¨è¿˜åŸ
                if (deviceType !== 'wechat') {
                    // åªæœ‰åœ¨ä¸Šä¸‹æ–‡ä¿¡æ¯å®Œæ•´æ—¶ï¼Œæ‰æ‰§è¡Œè‡ªåŠ¨è¿˜åŸ
                    if (context.center_name && context.center_lon && context.center_lat && context.search_kw && context.radius && context.count) {
                        restoreSearchAndScroll(context);
                    }
                }
            }
            // ===== å¤„ç†è·³è½¬é€»è¾‘ç»“æŸ =====

            const locationKeywordInput = document.getElementById('locationKeyword');
            const totalCountInput = document.getElementById('totalCount');
            const increaseBtn = document.getElementById('increaseBtn');
            const decreaseBtn = document.getElementById('decreaseBtn');
            const radiusInput = document.getElementById('radius');
            const keywordsInput = document.getElementById('keywords');

            // å½“ç”¨æˆ·ä¿®æ”¹ä¸­å¿ƒç‚¹å…³é”®å­—æ—¶ï¼Œç«‹å³éšè—ä¸‹æ–¹çš„å‘¨è¾¹æœç´¢åŒºåŸŸå’ŒçŠ¶æ€ä¿¡æ¯
            locationKeywordInput.addEventListener('input', function() {
                document.getElementById('nearby-search-section').style.display = 'none';
                document.getElementById('locationStatus').innerHTML = ''; // åŒæ—¶æ¸…é™¤æ—§çš„çŠ¶æ€ä¿¡æ¯
                document.getElementById('results').innerHTML = ''; // æ–°å¢: æ¸…ç©ºåœ°ç‚¹åˆ—è¡¨ç»“æœ
            });

            // æ–°å¢ï¼šå½“å‘¨è¾¹æœç´¢å…³é”®å­—å˜åŒ–æ—¶ï¼Œä¹Ÿæ¸…ç©ºæ—§çš„æœç´¢ç»“æœ
            const clearResultsOnChange = () => {
                document.getElementById('results').innerHTML = '';
            };

            keywordsInput.addEventListener('input', clearResultsOnChange);
            
            // ä¸º"ç”Ÿæˆæ•°é‡"è¾“å…¥æ¡†æ·»åŠ äº‹ä»¶ç›‘å¬ï¼Œå®æ—¶æ ¡å‡†
            totalCountInput.addEventListener('input', function() {
                const max = parseInt(this.max, 10);
                if (parseInt(this.value, 10) > max) {
                    this.value = max;
                }
            });
            // å¤±ç„¦æ—¶ï¼Œç¡®ä¿å€¼ä¸ä¸ºç©ºæˆ–å°äºæœ€å°å€¼
            totalCountInput.addEventListener('change', function() {
                const min = parseInt(this.min, 10);
                if (this.value === '' || parseInt(this.value, 10) < min) {
                    this.value = min;
                }
            });

            // "ç”Ÿæˆæ•°é‡" å¢åŠ æŒ‰é’®
            increaseBtn.addEventListener('click', function() {
                let currentValue = parseInt(totalCountInput.value, 10) || 0;
                const max = parseInt(totalCountInput.max, 10);
                let newValue = currentValue + 25;
                if (newValue > max) {
                    newValue = max;
                }
                totalCountInput.value = newValue;
            });

            // "ç”Ÿæˆæ•°é‡" å‡å°‘æŒ‰é’®
            decreaseBtn.addEventListener('click', function() {
                let currentValue = parseInt(totalCountInput.value, 10) || 0;
                const min = parseInt(totalCountInput.min, 10);
                let newValue = currentValue - 25;
                if (newValue < min) {
                    newValue = min;
                }
                totalCountInput.value = newValue;
            });

            // æœç´¢åŠå¾„è¾“å…¥æ¡†è‡ªåŠ¨æ ¡å‡†
            // ä¸º"æœç´¢åŠå¾„"è¾“å…¥æ¡†æ·»åŠ äº‹ä»¶ç›‘å¬ï¼Œå®æ—¶æ ¡å‡†
            radiusInput.addEventListener('input', function() {
                const max = parseInt(this.max, 10);
                if (parseInt(this.value, 10) > max) {
                    this.value = max;
                }
            });
            // å¤±ç„¦æ—¶ï¼Œç¡®ä¿å€¼ä¸ä¸ºç©ºã€å°äºæœ€å°å€¼æˆ–ä¸ºå°æ•°
            radiusInput.addEventListener('change', function() {
                const min = parseInt(this.min, 10);
                let value = parseInt(this.value, 10);

                if (isNaN(value) || value < min) {
                    this.value = min;
                } else {
                    this.value = Math.floor(value); // å–æ•´
                }
            });

            // ç»‘å®šå›è½¦é”®ä¸ºå‘¨è¾¹æœç´¢
            document.getElementById('keywords').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchNearby();
                }
            });

            // ç»‘å®šä¸­å¿ƒç‚¹å…³é”®å­—æœç´¢çš„å›è½¦é”®
            document.getElementById('locationKeyword').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchLocationByKeyword();
                }
            });

            // "å›åˆ°é¡¶éƒ¨" æŒ‰é’®åŠŸèƒ½
            const scrollTopBtn = document.getElementById('scrollTopBtn');

            // å½“ç”¨æˆ·æ»šåŠ¨é¡µé¢æ—¶ï¼Œå†³å®šæ˜¯å¦æ˜¾ç¤ºæŒ‰é’®
            window.onscroll = function() {
                // ç»“åˆå¤šç§æ–¹å¼è·å–æ»šåŠ¨è·ç¦»ï¼Œä»¥å®ç°æœ€ä½³å…¼å®¹æ€§
                const scrollTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop;
                if (scrollTop > 200) {
                    scrollTopBtn.style.display = "block";
                } else {
                    scrollTopBtn.style.display = "none";
                }
            };

            // å½“ç”¨æˆ·ç‚¹å‡»æŒ‰é’®æ—¶ï¼Œå¹³æ»‘æ»šåŠ¨åˆ°é¡¶éƒ¨
            scrollTopBtn.addEventListener('click', function() {
                window.scrollTo({top: 0, behavior: 'smooth'});
            });

            // ===== WX Mask Logic =====
            const wxGuideMask = document.getElementById('wx-guide-mask');

            // ç‚¹å‡»æµ®å±‚ä»…éšè—å®ƒ
            wxGuideMask.addEventListener('click', () => {
                wxGuideMask.style.display = 'none';
            });

            // ===== Lightbox (Image Gallery) Logic =====
            const lightbox = document.getElementById('lightbox');
            const lightboxContent = lightbox.querySelector('.lightbox-content');
            const lightboxCaption = lightbox.querySelector('.lightbox-caption');
            const closeBtn = lightbox.querySelector('.lightbox-close');
            const prevBtn = lightbox.querySelector('.lightbox-prev');
            const nextBtn = lightbox.querySelector('.lightbox-next');
            const bottomCloseBtn = lightbox.querySelector('.lightbox-bottom-close');

            function openLightbox(photos, poiId) {
                // Ensure any open popover is closed first
                const existingPopover = document.querySelector('.address-popover');
                if (existingPopover) existingPopover.remove();

                if (!lightbox || !photos || photos.length === 0) return;
                currentPoiPhotos = photos;
                currentPhotoIndex = 0;
                lightbox.style.display = 'flex';
                
                lightboxContent.innerHTML = ''; // Clear previous images
                
                const img = document.createElement('img');
                img.className = 'lightbox-image';
                img.src = currentPoiPhotos[currentPhotoIndex].url;
                lightboxContent.appendChild(img);
                
                lightboxCaption.textContent = `${currentPhotoIndex + 1} / ${currentPoiPhotos.length}`;

                // Immediately try to fetch all photos for this POI
                if (poiId) {
                    fetchPoiDetails(poiId);
                }
            }

            function closeLightbox() {
                if (!lightbox) return;
                // If an animation is in progress, stop it and reset state immediately
                if (isLightboxAnimating) {
                    const images = lightboxContent.querySelectorAll('.lightbox-image');
                    images.forEach(img => {
                        img.style.transition = 'none'; // Stop any ongoing transition
                        // If there's more than one image, it's from a partial animation. Remove extras.
                        if (img.parentElement && images.length > 1) {
                           // Keep only the current one, remove others
                           const imgSrc = currentPoiPhotos[currentPhotoIndex]?.url;
                           if (img.src !== imgSrc) {
                               img.remove();
                           }
                        }
                    });
                    isLightboxAnimating = false;
                }
                lightbox.style.display = 'none';
                lightboxContent.innerHTML = ''; // Clear images on close
            }

            async function fetchPoiDetails(poiId) {
                const params = {
                    id: poiId,
                    show_fields: 'photos'
                };

                try {
                    const data = await callGaodeAPI('v5/place/detail', params);
                    if (data.status === '1' && data.pois && data.pois.length > 0) {
                        const detailPoi = data.pois[0];
                        // If we got a more complete list of photos, update the gallery
                        if (detailPoi.photos && detailPoi.photos.length > currentPoiPhotos.length) {
                            currentPoiPhotos = detailPoi.photos;
                            // Update the caption to reflect the new total
                            lightboxCaption.textContent = `${currentPhotoIndex + 1} / ${currentPoiPhotos.length}`;
                        }
                    }
                } catch (error) {
                }
            }

            function showNextImage() {
                if (isLightboxAnimating || currentPoiPhotos.length <= 1) return;
                isLightboxAnimating = true;

                const oldImg = lightboxContent.querySelector('.lightbox-image');
                
                currentPhotoIndex = (currentPhotoIndex + 1) % currentPoiPhotos.length;
                const newImg = document.createElement('img');
                newImg.className = 'lightbox-image';
                newImg.src = currentPoiPhotos[currentPhotoIndex].url;
                
                // Position new image off-screen to the right without transition
                newImg.style.transition = 'none';
                newImg.style.transform = 'translateX(100%)';
                lightboxContent.appendChild(newImg);

                // Force browser to apply the initial transform before adding the transition
                newImg.offsetHeight; 

                // Add transitions and animate
                newImg.style.transition = 'transform 0.4s ease-in-out';
                newImg.style.transform = 'translateX(0)';
                if (oldImg) {
                    oldImg.style.transition = 'transform 0.4s ease-in-out';
                    oldImg.style.transform = 'translateX(-100%)';
                }
                
                lightboxCaption.textContent = `${currentPhotoIndex + 1} / ${currentPoiPhotos.length}`;

                // Clean up after the new image has finished its transition
                const transitionEndHandler = (event) => {
                    // Ensure the event is for the new image and not a bubbled event
                    if (event.target === newImg) {
                        if (oldImg && oldImg.parentNode) {
                            oldImg.remove();
                        }
                        isLightboxAnimating = false;
                        newImg.removeEventListener('transitionend', transitionEndHandler);
                    }
                };
                newImg.addEventListener('transitionend', transitionEndHandler);
            }
            
            function showPrevImage() {
                if (isLightboxAnimating || currentPoiPhotos.length <= 1) return;
                isLightboxAnimating = true;

                const oldImg = lightboxContent.querySelector('.lightbox-image');

                currentPhotoIndex = (currentPhotoIndex - 1 + currentPoiPhotos.length) % currentPoiPhotos.length;
                const newImg = document.createElement('img');
                newImg.className = 'lightbox-image';
                newImg.src = currentPoiPhotos[currentPhotoIndex].url;
                
                // Position new image off-screen to the left without transition
                newImg.style.transition = 'none';
                newImg.style.transform = 'translateX(-100%)';
                lightboxContent.appendChild(newImg);
                
                // Force reflow
                newImg.offsetHeight; 

                // Add transitions and animate
                newImg.style.transition = 'transform 0.4s ease-in-out';
                newImg.style.transform = 'translateX(0)';
                if (oldImg) {
                    oldImg.style.transition = 'transform 0.4s ease-in-out';
                    oldImg.style.transform = 'translateX(100%)';
                }

                lightboxCaption.textContent = `${currentPhotoIndex + 1} / ${currentPoiPhotos.length}`;
                
                // Clean up
                const transitionEndHandler = (event) => {
                    if (event.target === newImg) {
                        if (oldImg && oldImg.parentNode) {
                            oldImg.remove();
                        }
                        isLightboxAnimating = false;
                        newImg.removeEventListener('transitionend', transitionEndHandler);
                    }
                };
                newImg.addEventListener('transitionend', transitionEndHandler);
            }

            // Event listener for image clicks (delegated)
            document.getElementById('results').addEventListener('click', function(e) {
                if (e.target && e.target.classList.contains('lightbox-trigger')) {
                    e.preventDefault();
                    e.stopPropagation();
                    const photosJson = e.target.getAttribute('data-photos');
                    const poiId = e.target.getAttribute('data-poi-id');
                    if (photosJson) {
                        try {
                           const photos = JSON.parse(photosJson);
                           openLightbox(photos, poiId);
                        } catch (err) {
                        }
                    }
                }

                if (e.target && e.target.classList.contains('address-btn')) {
                    e.preventDefault();
                    e.stopPropagation();
                    createAddressPopover(e.target);
                }
            });

            function createAddressPopover(button) {
                const oldPopover = document.querySelector('.address-popover');
                let copyToast = document.getElementById('copy-toast');

                if (!copyToast) {
                    copyToast = document.createElement('div');
                    copyToast.id = 'copy-toast';
                    copyToast.className = 'copy-toast';
                    copyToast.textContent = 'è¯¦ç»†åœ°å€å·²å¤åˆ¶';
                    document.body.appendChild(copyToast);
                }

                // If a popover exists and it's for the same button, just remove it and we're done.
                if (oldPopover && oldPopover._ownerButton === button) {
                    oldPopover.remove();
                    return;
                }

                // If any other popover is open, remove it before creating the new one.
                if (oldPopover) {
                    oldPopover.remove();
                }

                // Ensure lightbox is closed
                if (lightbox.style.display !== 'none') {
                    closeLightbox();
                }

                const address = button.dataset.address;
                const popover = document.createElement('div');
                popover.className = 'address-popover';
                popover.textContent = address;
                popover._ownerButton = button; // Link the popover to its button

                // ç§»åŠ¨ç«¯é•¿æŒ‰å¤åˆ¶åŠŸèƒ½
                if (getDeviceType() !== 'pc') {
                    // é•¿æŒ‰å¤åˆ¶åŠŸèƒ½
                    let touchTimer;
                    const startCopyTimer = () => {
                        touchTimer = setTimeout(() => {
                            navigator.clipboard.writeText(address).then(() => {
                                // æ˜¾ç¤ºå¤åˆ¶æˆåŠŸæç¤º
                                copyToast.classList.add('show');
                                setTimeout(() => {
                                    copyToast.classList.remove('show');
                                }, 1500);
                                
                                // å…³é—­å¼¹çª—
                                popover.remove();
                            });
                        }, 500); // é•¿æŒ‰åŠç§’è§¦å‘å¤åˆ¶
                    };

                    const clearCopyTimer = () => {
                        clearTimeout(touchTimer);
                    };

                    popover.addEventListener('touchstart', startCopyTimer);
                    popover.addEventListener('touchend', clearCopyTimer);
                    popover.addEventListener('touchcancel', clearCopyTimer);
                }

                // Stop the popover from closing when clicking inside it
                popover.addEventListener('click', e => e.stopPropagation());
                
                document.body.appendChild(popover);

                // Position it
                const btnRect = button.getBoundingClientRect();
                let top = btnRect.bottom + 8;
                let left = btnRect.left;
                
                // ç¡®ä¿åœ¨ç§»åŠ¨ç«¯ä¸ä¼šè¶…å‡ºå±å¹•è¾¹ç¼˜
                const rightEdge = left + popover.offsetWidth;
                if (rightEdge > window.innerWidth - 10) {
                    left = Math.max(10, window.innerWidth - 10 - popover.offsetWidth);
                }
                
                popover.style.top = `${top}px`;
                popover.style.left = `${left}px`;

                // Add one-time listeners to close the popover on the next click OR scroll
                setTimeout(() => {
                    const closePopover = () => popover.remove();
                    document.addEventListener('click', closePopover, { once: true });
                    window.addEventListener('scroll', closePopover, { once: true });
                }, 0);
            }

            // Lightbox control listeners
            const closeHandler = (e) => {
                e.stopPropagation();
                e.preventDefault();
                closeLightbox();
            };
            closeBtn.addEventListener('mousedown', closeHandler);
            closeBtn.addEventListener('touchstart', closeHandler, { passive: false });
            bottomCloseBtn.addEventListener('mousedown', closeHandler);
            bottomCloseBtn.addEventListener('touchstart', closeHandler, { passive: false });

            nextBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                showNextImage();
            });
            prevBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                showPrevImage();
            });
            // The old generic click handler is removed, replaced by specific close areas.

            // Swipe functionality for mobile
            let touchstartX = 0;
            let touchendX = 0;
            let touchstartY = 0;
            let touchendY = 0;

            lightbox.addEventListener('touchstart', function(event) {
                touchstartX = event.changedTouches[0].screenX;
                touchstartY = event.changedTouches[0].screenY;
            }, false);

            lightbox.addEventListener('touchend', function(event) {
                touchendX = event.changedTouches[0].screenX;
                touchendY = event.changedTouches[0].screenY;
                handleSwipeGesture();
            }, false);

            function handleSwipeGesture() {
                const dx = touchendX - touchstartX;
                const dy = touchendY - touchstartY;

                // Check for a swipe gesture (significant horizontal movement, minimal vertical movement)
                if (Math.abs(dx) > 50 && Math.abs(dy) < 50) {
                    if (dx < 0) { // Swiped left
                        showNextImage();
                    } else { // Swiped right
                        showPrevImage();
                    }
                }
                // A small movement is considered a tap, which will be handled by the 'click' event listener.
            }
        });

        /* ===============================================
           è®¾å¤‡æ£€æµ‹ä¸åœ°å›¾è·³è½¬
           =============================================== */
        function getDeviceType() {
            const ua = navigator.userAgent.toLowerCase();
            if (/micromessenger/.test(ua)) {
                return 'wechat';
            }
            if (/iphone|ipad|ipod/.test(ua)) {
                return 'ios';
            }
            if (/android/.test(ua)) {
                return 'android';
            }
            return 'pc';
        }

        /**
         * Dynamically generates map URL and opens it in a new tab.
         * This ensures the device type is checked at the moment of click.
         * @param {Event} event - The click event.
         * @param {string} poiId - The ID of the POI.
         */
        function openMapForPoi(event, poiId) {
            event.preventDefault();
            // é˜²æ­¢é‡å¤ç‚¹å‡»
            if(linkClicked) return;
            linkClicked = true;
            
            const poi = originalDistanceSortedPois.find(p => p.id === poiId);
            if (!poi) {
                alert('æŠ±æ­‰ï¼Œæ— æ³•ç”Ÿæˆåœ°å›¾é“¾æ¥ï¼Œæœªæ‰¾åˆ°è¯¥åœ°ç‚¹çš„è¯¦ç»†ä¿¡æ¯ã€‚');
                linkClicked = false;
                return;
            }

            const deviceType = getDeviceType();
            const mapUrl = getMapUrl(poi);

            if (deviceType === 'wechat') {
                // åœ¨å¾®ä¿¡ä¸­ï¼Œä½¿ç”¨ history.pushState ä¿®æ”¹URLï¼Œç„¶åæ˜¾ç¤ºå¼•å¯¼è’™å±‚
                const centerName = document.getElementById('locationKeyword').value;
                const centerLon = document.getElementById('longitude').value;
                const centerLat = document.getElementById('latitude').value;
                const searchKw = document.getElementById('keywords').value;
                
                // ä½¿ç”¨ä¸Šæ¬¡æœç´¢æ—¶è®°å½•çš„å‚æ•°ï¼Œå¦‚æœè®°å½•ä¸å­˜åœ¨ï¼Œåˆ™å›é€€åˆ°å½“å‰è¾“å…¥æ¡†çš„å€¼
                const radius = lastUsedSearchParams.radius !== undefined ? lastUsedSearchParams.radius : document.getElementById('radius').value;
                const count = lastUsedSearchParams.count !== undefined ? lastUsedSearchParams.count : document.getElementById('totalCount').value;

                const params = new URLSearchParams();
                params.set('center_name', centerName);
                params.set('center_lon', centerLon);
                params.set('center_lat', centerLat);
                params.set('search_kw', searchKw);
                params.set('radius', radius);
                params.set('count', count);
                
                const newUrl = `/poi/${poi.id}?${params.toString()}`;

                history.pushState({ poiId: poi.id }, '', newUrl);
                document.getElementById('wx-guide-mask').style.display = 'flex';

            } else if (deviceType === 'ios' || deviceType === 'android') {
                // åœ¨ç§»åŠ¨è®¾å¤‡ä¸Šå°è¯•æ‰“å¼€é«˜å¾·åœ°å›¾APP
                window.location.href = mapUrl;

            } else { // PCç«¯
                window.open(mapUrl, '_blank', 'noopener,noreferrer');
            }
            
            // 500msåé‡ç½®æ ‡è®°ï¼Œé˜²æ­¢é‡å¤ç‚¹å‡»
            setTimeout(() => {
                linkClicked = false;
            }, 500);
        }

        /**
         * NEW: Orchestrates the click animation and delayed navigation.
         * This solves the conflict between CSS transform and click events.
         * @param {Event} event
         * @param {string} poiId
         */
        async function handlePoiClick(event, poiId) {
            event.preventDefault();
            const contentElement = event.currentTarget.querySelector('.poi-name-content');

            // ç§»é™¤æ‰€æœ‰å·²é€‰æ‹©å’ŒæŒ‰ä¸‹æ•ˆæœï¼Œç¡®ä¿æ— é—ªçƒ
            document.querySelectorAll('.poi-name-content.selected, .poi-name-content.pressed').forEach(item => {
                if (item !== contentElement) {
                    item.classList.remove('selected', 'pressed');
                }
            });
            
            // ä¸ºå½“å‰ç‚¹å‡»é¡¹æ·»åŠ é€‰ä¸­æ ·å¼
            contentElement.classList.add('selected');
            contentElement.classList.add('pressed');

            // åœ¨åŠ¨ç”»å®Œæˆåç§»é™¤pressedæ•ˆæœ
            await sleep(200);
            contentElement.classList.remove('pressed');

            // è§¦å‘å¯¼èˆª
            openMapForPoi(event, poiId);
        }

        /**
         * æ–°å¢ï¼šæ ¹æ®URLä¸­çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œè‡ªåŠ¨è¿˜åŸæœç´¢å¹¶æ»šåŠ¨åˆ°æŒ‡å®šPOI
         * @param {object} context - åŒ…å«æ‰€æœ‰æœç´¢å‚æ•°å’Œç›®æ ‡POI IDçš„å¯¹è±¡
         */
        async function restoreSearchAndScroll(context) {
            const loader = document.getElementById('restore-loader-overlay');
            loader.style.display = 'flex'; // Show loader

            try {
                const statusDiv = document.getElementById('locationStatus');
                // statusDiv.innerHTML = `<div class="info-prompt">æ­£åœ¨æ ¹æ®é“¾æ¥è‡ªåŠ¨è¿˜åŸæœç´¢...</div>`; // This is now handled by the overlay

                // æ­¥éª¤1: è‡ªåŠ¨å®šä½ä¸­å¿ƒç‚¹
                document.getElementById('locationKeyword').value = context.center_name;
                await searchLocationByKeyword(true); // ä½¿ç”¨ true ä»¥æ¿€æ´»è‡ªåŠ¨åŒ–æ¨¡å¼

                // æ£€æŸ¥ä¸­å¿ƒç‚¹æ˜¯å¦å®šä½æˆåŠŸ
                const lon = document.getElementById('longitude').value;
                if (!lon) {
                    statusDiv.innerHTML = `<div class="error">è‡ªåŠ¨å®šä½ä¸­å¿ƒç‚¹ "${context.center_name}" å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨æœç´¢ã€‚</div>`;
                    return;
                }

                // æ­¥éª¤2: å¡«å……å…¶ä»–æœç´¢å‚æ•°
                document.getElementById('keywords').value = context.search_kw;
                document.getElementById('radius').value = context.radius;
                document.getElementById('totalCount').value = context.count;

                // æ­¥éª¤3: æ‰§è¡Œå‘¨è¾¹æœç´¢
                await searchNearby();

                // æ­¥éª¤4: æ»šåŠ¨åˆ°ç›®æ ‡POIå¹¶é«˜äº®æ˜¾ç¤º
                const targetElement = document.getElementById(`poi-item-${context.poiIdToScroll}`);
                if (targetElement) {
                    // æ»šåŠ¨åˆ°è§†å›¾ä¸­å¤®ï¼Œæä¾›æ›´å¥½çš„ä¸Šä¸‹æ–‡
                    targetElement.scrollIntoView({ behavior: 'auto', block: 'center' });
                    
                    // æ·»åŠ é«˜äº®æ•ˆæœï¼Œè®©ç”¨æˆ·èƒ½ç«‹åˆ»æ³¨æ„åˆ°
                    targetElement.style.transition = 'background-color 1s ease-in-out';
                    targetElement.style.backgroundColor = '#e6f7ff'; // ä½¿ç”¨ä¸»é¢˜è“è‰²
                    setTimeout(() => {
                        targetElement.style.backgroundColor = ''; // 2.5ç§’åæ¢å¤åŸçŠ¶
                    }, 2500);

                    // ===== New Arrow Logic =====
                    const arrowContainer = document.getElementById('arrow-container');
                    if (arrowContainer) {
                        const targetRect = targetElement.getBoundingClientRect();
                        
                        // Position the container. The arrow's visual center should be at 1/4 width of the target.
                        const arrowVisualWidth = 60; // as defined in CSS
                        const arrowLeft = targetRect.left + (targetRect.width / 4) - (arrowVisualWidth / 2);
                        const arrowTop = targetRect.top + window.scrollY - 75; // 60px arrow height + 15px gap

                        arrowContainer.style.top = `${arrowTop}px`;
                        arrowContainer.style.left = `${arrowLeft}px`;
                        
                        // Make it visible with a fade-in effect
                        arrowContainer.style.display = 'flex';
                        setTimeout(() => {
                            arrowContainer.style.opacity = '1';
                        }, 10);

                        // Fade out and hide after 3 seconds
                        setTimeout(() => {
                            arrowContainer.style.opacity = '0';
                            // Hide completely after the transition ends
                            setTimeout(() => {
                                arrowContainer.style.display = 'none';
                            }, 400); // Must match CSS transition duration
                        }, 3000);
                    }
                }
            } catch (error) {
                const statusDiv = document.getElementById('locationStatus');
                statusDiv.innerHTML = `<div class="error">è‡ªåŠ¨è¿˜åŸæœç´¢å¤±è´¥: ${error.message}</div>`;
            } finally {
                loader.style.display = 'none'; // Hide loader
            }
        }
    </script>
</body>
</html>