<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é«˜å¾·åœ°å›¾å‘¨è¾¹æœç´¢A</title>
    <style>
        /* For Webkit browsers (Chrome, Safari, Edge) */
        ::-webkit-scrollbar {
            width: 12px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #a9a9a9;
            border-radius: 6px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        /* For Firefox */
        html {
            scrollbar-width: auto; /* 'auto' or 'thin' */
            scrollbar-color: #a9a9a9 #f1f1f1; /* thumb and track color */
            overflow-y: scroll; /* å§‹ç»ˆæ˜¾ç¤ºæ»šåŠ¨æ¡ï¼Œé˜²æ­¢é¡µé¢å†…å®¹å˜åŒ–æ—¶å®½åº¦æŠ–åŠ¨ */
        }
        
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            min-height: 100vh; /* ç¡®ä¿bodyè¦†ç›–æ•´ä¸ªè§†å£é«˜åº¦ï¼Œé˜²æ­¢åº•éƒ¨ç™½æ¡ */
            box-sizing: border-box; /* å°†paddingå’Œborderè®¡å…¥æ€»é«˜åº¦/å®½åº¦ */
            display: flex; /* ä½¿ç”¨Flexboxå¸ƒå±€ */
            flex-direction: column; /* å‚ç›´æ’åˆ—å­å…ƒç´  */
        }
        
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            max-width: 1200px;
            margin: 0 auto;
            flex: 1; /* è®© container å¡«å……å‰©ä½™çš„å‚ç›´ç©ºé—´ */
            display: flex; /* åŒæ ·ä½¿ç”¨Flexboxï¼Œä»¥ä¾¿å†…éƒ¨å…ƒç´ å¯ä»¥æ›´å¥½åœ°æ§åˆ¶ */
            flex-direction: column; /* å†…éƒ¨å…ƒç´ å‚ç›´æ’åˆ— */
            width: 100%; /* é…åˆ max-width å’Œ margin: auto ä½¿ç”¨ */
            box-sizing: border-box; /* ç¡®ä¿ padding å’Œ border åœ¨è®¡ç®—å†… */
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .search-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center; /* ä»…ä¸­å¿ƒå¯¹é½ä½œä¸ºç›´æ¥å­å…ƒç´ çš„æŒ‰é’® */
            box-shadow: 0 4px 8px rgba(0,0,0,0.08); /* æ·»åŠ ç«‹ä½“é˜´å½± */
            transition: box-shadow 0.3s ease; /* æ·»åŠ è¿‡æ¸¡æ•ˆæœ */
        }
        
        .search-form:hover {
            box-shadow: 0 6px 12px rgba(0,0,0,0.12); /* æ‚¬æµ®æ—¶é˜´å½±æ›´æ˜æ˜¾ */
        }
        
        #locationStatus {
            text-align: left; /* ç¡®ä¿åœ°ç†ç¼–ç æˆåŠŸåçš„çŠ¶æ€ä¿¡æ¯æ˜¯å·¦å¯¹é½çš„ */
        }
        
        .form-group {
            margin-bottom: 15px;
            text-align: left; /* è¦†ç›–çˆ¶çº§çš„å±…ä¸­å¯¹é½ï¼Œç¡®ä¿æ ‡ç­¾å’Œè¾“å…¥æ¡†å·¦å¯¹é½ */
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        
        input[type="text"], input[type="number"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }
        
        /* Custom styles for radius and totalCount inputs */
        #radius, .input-stepper {
            max-width: 120%;
        }

        #radius, #totalCount {
            padding-top: 14px;
            padding-bottom: 14px;
        }
        
        .form-row {
            display: flex;
            gap: 15px;
        }
        
        .form-row.form-row-tight {
            justify-content: center; /* Center the compact items within the row */
            gap: 20px; /* Increased gap to add more space between items */
        }

        /* For rows that should not have flexible, growing children */
        .form-row.form-row-tight .form-group {
            flex: none; /* Override flex: 1 to make items shrink to content width */
        }

        .form-row .form-group {
            flex: 1;
        }
        
        button {
            background: #1890ff;
            color: white;
            padding: 12px 20px; /* å‡å°äº†å·¦å³å†…è¾¹è·ï¼Œä½¿æŒ‰é’®å˜çª„ */
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
        }
        
        button:hover {
            background: #40a9ff;
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            border-color: #096dd9;
        }
        
        .results {
            margin-top: 20px;
            flex: 1; /* å¡«å……å‰©ä½™ç©ºé—´ */
            overflow-y: auto; /* å¦‚æœå†…å®¹æº¢å‡ºï¼Œåˆ™æ˜¾ç¤ºæ»šåŠ¨æ¡ */
        }
        
        .result-section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #e8e8e8;
            border-radius: 6px;
        }
        
        .result-section h3 {
            margin-top: 0;
            color: #1890ff;
        }
        
        .poi-item {
            background: #fafafa;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 4px;
            border-left: 4px solid #1890ff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); /* æ·»åŠ ç«‹ä½“é˜´å½± */
            transition: box-shadow 0.3s ease, transform 0.3s ease; /* æ·»åŠ è¿‡æ¸¡æ•ˆæœ */
        }
        
        .poi-item:hover {
            transform: translateY(-2px); /* æ‚¬æµ®æ—¶è½»å¾®ä¸Šç§» */
            box-shadow: 0 4px 8px rgba(0,0,0,0.1); /* æ‚¬æµ®æ—¶é˜´å½±æ›´æ˜æ˜¾ */
        }
        
        .poi-link {
            text-decoration: none; /* ç§»é™¤é“¾æ¥ä¸‹åˆ’çº¿ */
            color: inherit; /* ç»§æ‰¿çˆ¶å…ƒç´ é¢œè‰² */
        }
        
        .poi-name {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        
        .poi-info {
            color: #666;
            font-size: 14px;
            line-height: 1.5;
        }
        
        .poi-info code {
            word-break: break-all;
            white-space: pre-wrap;
            background-color: #f6f8fa;
            padding: 2px 4px;
            border-radius: 4px;
            font-size: 12px;
        }
        
        .raw-data {
            background: #f6f8fa;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }
        
        .loading {
            text-align: center;
            color: #1890ff;
            font-size: 16px;
        }
        
        .error {
            color: #ff4d4f;
            background: #fff2f0;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #ffccc7;
        }
        
        .success {
            color: #52c41a;
            background: #f6ffed;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #b7eb8f;
        }
        
        .sort-buttons button.active {
            background-color: #096dd9;
            border-color: #096dd9;
        }
        
        .category-buttons {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 3px; /* è¿›ä¸€æ­¥å‡å°æ‰‹æœºç«¯é—´è· */
            margin-bottom: 15px; /* ä¿æŒä¸ä¸‹æ–¹å…ƒç´ çš„è·ç¦» */
        }

        .category-buttons button {
            background-color: #e6f7ff;
            color: #1890ff;
            border: 1px solid #91d5ff;
            margin: 0; /* æ˜ç¡®é‡ç½®å¤–è¾¹è· */
            /* ç§»é™¤æ—§çš„ marginï¼Œç”±çˆ¶å®¹å™¨çš„ gap æ§åˆ¶ */
            padding: 4px 10px; /* å‡å°å‚ç›´å†…è¾¹è·ï¼Œä½¿æŒ‰é’®æ›´ç´§å‡‘ */
            font-size: 14px; /* ç»Ÿä¸€å­—ä½“å¤§å° */
        }
        .category-buttons button:hover {
            background-color: #bae7ff;
        }

        #scrollTopBtn {
            display: none;
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 99;
            border: none;
            outline: none;
            background-color: rgba(24, 144, 255, 0.7);
            color: white;
            cursor: pointer;
            padding: 15px;
            border-radius: 50%;
            font-size: 18px;
            line-height: 1;
            transition: background-color 0.3s, opacity 0.3s;
        }

        #scrollTopBtn:hover {
            background-color: rgba(24, 144, 255, 1);
        }

        @media (max-width: 768px) {
            body {
                padding: 0; /* åœ¨æ‰‹æœºä¸Šç§»é™¤è¾¹è·ï¼Œå®ç°è¾¹ç¼˜åˆ°è¾¹ç¼˜çš„å¸ƒå±€ */
            }

            .container {
                padding: 15px 0; /* ç§»é™¤æ°´å¹³å†…è¾¹è·ï¼Œä»¥ä½¿å†…å®¹å—æŠµè¾¾å±å¹•è¾¹ç¼˜ */
                border-radius: 0;
                box-shadow: none;
            }

            h1 {
                font-size: 24px; /* Smaller main title */
                margin-bottom: 20px;
            }

            .form-row {
                flex-direction: row; /* åœ¨æ‰‹æœºä¸Šå¹¶æ’æ˜¾ç¤º */
                gap: 10px; /* è®¾ç½®é—´è· */
                align-items: flex-start;
            }
            
            /* Ensure spacing between stacked items */
            .form-row .form-group {
                flex: 1; /* æ¯ä¸ªé¡¹ç›®å æ®å‡ç­‰ç©ºé—´ */
                min-width: 0; /* å…è®¸é¡¹ç›®æ”¶ç¼© */
                margin-bottom: 15px; 
            }
            
            /* è°ƒæ•´æ ‡ç­¾å’Œè¾“å…¥æ¡†ä»¥é€‚åº”å¹¶æ’å¸ƒå±€ */
            .form-row label {
                font-size: 13px;
                white-space: nowrap;
            }
            .form-row input[type="number"] {
                padding: 8px 6px; /* å‡å°è¾“å…¥æ¡†çš„å†…è¾¹è· */
            }

            /* Make main action buttons full width for easy tapping */
            #searchLocationBtn, #searchBtn {
                width: auto; /* æ”¹ä¸ºè‡ªé€‚åº”å®½åº¦ */
                box-sizing: border-box;
            }

            .category-buttons {
                gap: 8px; /* åœ¨æ‰‹æœºç«¯ä½¿ç”¨gapç»Ÿä¸€æ§åˆ¶é—´è· */
            }
            
            /* åœ¨æ‰‹æœºç«¯, è®©æŒ‰é’®æˆä¸ºflexboxçš„ç›´æ¥å­é¡¹, ä»¥å®ç°è‡ªç„¶çš„æ¢è¡Œ */
            .category-row {
                display: contents;
            }
            
            .category-buttons button {
                margin: 0; /* ç§»é™¤ç‹¬ç«‹margin, ç”±çˆ¶å®¹å™¨çš„gapæ§åˆ¶ */
                padding: 8px 12px;
                font-size: 14px;
            }

            /* Stack the POI list header (title and sort buttons) */
            .results .result-section > div[style*="display: flex"] {
                flex-direction: column;
                gap: 15px;
            }
            
            .sort-buttons {
                justify-content: center; /* Center sort buttons */
                flex-wrap: wrap; /* Allow buttons to wrap */
                gap: 10px;
            }

            /* Don't let sort buttons take full width */
            .sort-buttons button {
                width: auto;
                margin-left: 0 !important; /* Override inline style */
            }
            
            .poi-item {
                padding: 10px;
            }

            .poi-name {
                font-size: 15px;
            }

            .poi-info {
                font-size: 13px;
            }
            
            #scrollTopBtn {
                bottom: 20px;
                right: 20px;
                padding: 12px;
                font-size: 16px;
            }
        }

        @media (min-width: 769px) {
            .category-buttons {
                display: block; /* åœ¨ç”µè„‘ç«¯ï¼Œå®¹å™¨æœ¬èº«ä¸æ˜¯gridæˆ–flex */
                gap: 0;
            }

            .category-row {
                display: grid;
                gap: 10px;
                margin-bottom: 10px;
            }

            .category-row:last-child {
                margin-bottom: 0;
            }

            .category-row:nth-child(1) {
                grid-template-columns: repeat(8, 1fr); /* ç¬¬ä¸€è¡Œ8åˆ— */
            }

            .category-row:nth-child(2) {
                grid-template-columns: repeat(9, 1fr); /* ç¬¬äºŒè¡Œ9åˆ— */
            }
        }

        /* Styles for stepper buttons */
        .input-stepper {
            display: flex;
        }
        .input-stepper input[type="number"] {
            border-right: none;
            border-radius: 4px 0 0 4px;
            position: relative;
            /* Hide ugly default arrows */
            -moz-appearance: textfield;
        }
        .input-stepper input[type="number"]::-webkit-outer-spin-button,
        .input-stepper input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .stepper-buttons {
            display: flex;
            flex-direction: column;
            width: 40px; /* Width of the buttons area, increased from 30px */
            border: 1px solid #ddd;
            border-left: none;
            border-radius: 0 4px 4px 0;
        }
        
        .stepper-btn {
            background-color: #1890ff;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 10px;
            padding: 0;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            flex: 1; /* Each button takes half the available height */
            line-height: 0;
            transition: background-color 0.3s;
        }
        .stepper-btn:hover {
            background-color: #40a9ff;
        }
        
        #increaseBtn {
            border-bottom: 1px solid #40a9ff; /* Lighter separator for contrast */
            border-radius: 0;
        }
        
        #decreaseBtn {
            border-top: none;
            border-radius: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ—ºï¸ é«˜å¾·åœ°å›¾å‘¨è¾¹æœç´¢</h1>
        
        <div class="search-form">
            <div class="form-group">
                <label for="locationKeyword">1. è¾“å…¥ä¸­å¿ƒç‚¹å…³é”®å­—:</label>
                <input type="text" id="locationKeyword" placeholder="ä¾‹å¦‚ï¼šæ­å·ä¸‡è¾¾" value="ç¯çƒå½±åŸ">
            </div>
            <button onclick="searchLocationByKeyword()" id="searchLocationBtn">ğŸ“ å®šä½ä¸­å¿ƒç‚¹ </button>
            <div id="locationStatus" style="margin-top: 15px;"></div>

            <div id="nearby-search-section" style="display: none;">
                <hr style="margin: 20px 0; border: 0; border-top: 1px dashed #ccc;">

                <div class="form-group">
                    <label for="keywords">2. è¾“å…¥å…³é”®å­—æˆ–ç‚¹å‡»ä¸‹æ–¹å¿«æ·åˆ†ç±»:</label>
                    <input type="text" id="keywords" placeholder="ä¾‹å¦‚ï¼šè¥¿é¤å…ã€ç«é”…ã€æ˜Ÿå·´å…‹ç­‰" value="ä¸­é¤å…">
                </div>

                <div class="category-buttons form-group">
                    <div class="category-row">
                        <button onclick="searchByCategory('ç¾é£Ÿ')">ç¾é£Ÿ</button>
                        <button onclick="searchByCategory('æ°´æœ')">æ°´æœ</button>
                        <button onclick="searchByCategory('å¿«é¤')">å¿«é¤</button>
                        <button onclick="searchByCategory('å°åƒ')">å°åƒ</button>
                        <button onclick="searchByCategory('è´­ç‰©ä¸­å¿ƒ')">è´­ç‰©ä¸­å¿ƒ/å•†åœº</button>
                        <button onclick="searchByCategory('ç¾å®¹ç¾å‘')">ç¾å®¹ç¾å‘</button>
                        <button onclick="searchByCategory('è¿åŠ¨åœºæ‰€')">è¿åŠ¨åœºæ‰€</button>
                        <button onclick="searchByCategory('ä¼‘é—²å¨±ä¹')">ä¼‘é—²å¨±ä¹</button>
                    </div>
                    <div class="category-row">
                        <button onclick="searchByCategory('åˆé¤')">åˆé¤/æ™šé¤</button>
                        <button onclick="searchByCategory('å†·é¥®')">å†·é¥®/é¥®å“</button>
                        <button onclick="searchByCategory('è¶…å¸‚')">è¶…å¸‚/ä¾¿åˆ©åº—</button>
                        <button onclick="searchByCategory('ä¹°è¯')">ä¹°è¯</button>
                        <button onclick="searchByCategory('è”¬èœ')">è”¬èœ</button>
                        <button onclick="searchByCategory('é…’åº—')">é…’åº—</button>
                        <button onclick="searchByCategory('æ™¯ç‚¹')">æ™¯ç‚¹</button>
                        <button onclick="searchByCategory('ç”µå½±é™¢')">ç”µå½±é™¢</button>
                        <button onclick="searchByCategory('å’–å•¡')">å’–å•¡</button>
                    </div>
                </div>
                
                <div class="form-row" style="display: none;">
                    <div class="form-group">
                        <label for="longitude">ç»åº¦ (è‡ªåŠ¨å¡«å……):</label>
                        <input type="text" id="longitude" placeholder="å¾…è‡ªåŠ¨å¡«å……" value="" readonly>
                    </div>
                    <div class="form-group">
                        <label for="latitude">çº¬åº¦ (è‡ªåŠ¨å¡«å……):</label>
                        <input type="text" id="latitude" placeholder="å¾…è‡ªåŠ¨å¡«å……" value="" readonly>
                    </div>
                </div>
                
                <div class="form-row form-row-tight">
                    <div class="form-group">
                        <label for="radius">æœç´¢åŠå¾„:</label>
                        <input type="number" id="radius" value="5000" min="1" max="50000">
                    </div>
                    <div class="form-group">
                        <label for="totalCount">ç”Ÿæˆæ•°é‡:</label>
                        <div class="input-stepper">
                            <input type="number" id="totalCount" value="50" min="0" max="2500" placeholder="è¦æ˜¾ç¤ºçš„ç»“æœæ•°é‡">
                            <div class="stepper-buttons">
                                <button id="increaseBtn" class="stepper-btn" aria-label="å¢åŠ æ•°é‡">â–²</button>
                                <button id="decreaseBtn" class="stepper-btn" aria-label="å‡å°‘æ•°é‡">â–¼</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <button onclick="searchNearby()" id="searchBtn">ğŸ” æœç´¢å‘¨è¾¹</button>
            </div>
        </div>
        
        <div class="results" id="results"></div>
    </div>

    <a id="scrollTopBtn" title="å›åˆ°é¡¶éƒ¨">â–²</a>

    <script>
        // ===== é…ç½®å‚æ•°åŒºåŸŸ - å¯ä¿®æ”¹ =====
        let locationSearchUrl = ''; // ç”¨äºå­˜å‚¨ä¸­å¿ƒç‚¹æœç´¢çš„URL
        let originalDistanceSortedPois = []; // å­˜å‚¨æŒ‰è·ç¦»æ’åºçš„åŸå§‹POIåˆ—è¡¨
        let currentDisplaySort = 'comprehensive'; // å½“å‰æ˜¾ç¤ºçš„æ’åºè§„åˆ™
        let comprehensiveSortMode = 'cost_effective'; // ç»¼åˆæ’åºçš„æ¨¡å¼: 'cost_effective', 'high_end'
        let searchCache = {}; // æ–°å¢ï¼šç”¨äºç¼“å­˜æœç´¢ç»“æœ
        let locationCache = {}; // æ–°å¢ï¼šç”¨äºç¼“å­˜ä¸­å¿ƒç‚¹æœç´¢ç»“æœ
        let cachedSortedResults = {
            distance: [],
            rating: [],
            cost_effective: [],
            high_end: []
        };

        const CONFIG = {
            // SCF_URL å·²æ›¿æ¢ä¸ºæ‚¨æä¾›çš„äº‘å‡½æ•°åœ°å€
            SCF_URL: 'https://1364541279-enva6v5vqu.ap-shanghai.tencentscf.com',
            
            // é»˜è®¤å‚æ•°
            DEFAULT_PARAMS: {
                output: 'json',
                show_fields: 'business'
            }
        };
        
        // ===== ä¸»è¦åŠŸèƒ½å‡½æ•° =====
        
        /**
         * ç­‰å¾…æŒ‡å®šæ¯«ç§’æ•°
         * @param {number} ms - ç­‰å¾…çš„æ¯«ç§’æ•°
         */
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        
        /**
         * ç‚¹å‡»åˆ†ç±»æŒ‰é’®åè§¦å‘æœç´¢
         * @param {string} category - åˆ†ç±»åç§°
         */
        function searchByCategory(category) {
            document.getElementById('keywords').value = category;
            // ç»Ÿä¸€è°ƒç”¨æ–°çš„æœç´¢å…¥å£å‡½æ•°ï¼Œå®ƒä¼šå¤„ç†UIæ›´æ–°å’Œæ»šåŠ¨
            searchNearby();
        }

        // ===== POI å…³é”®å­—æ™ºèƒ½æ˜ å°„ =====
        const POI_KEYWORD_MAP = {
            '050100|050200': ['é¤å…', 'é¥­åº—',  'åƒé¥­','ä¸­é¤å…', 'ä¸­é¤','åˆé¤', 'åˆé¥­', 'æ™šé¤', 'æ™šé¥­'],
            '050101': ['é…’æ¥¼'],
            '050102': ['å››å·èœ', 'å·èœ'],
            '050103': ['å¹¿ä¸œèœ', 'ç²¤èœ'],
            '050104': ['å±±ä¸œèœ', 'é²èœ'],
            '050105|050107|050106': ['æ±Ÿè‹èœ', 'æµ™æ±Ÿèœ', 'ä¸Šæµ·èœ', 'æ­å¸®èœ'],
            '050108': ['æ¹–å—èœ', 'æ¹˜èœ'],
            '050109': ['å®‰å¾½èœ', 'å¾½èœ'],
            '050111': ['åŒ—äº¬èœ'],
            '050116': ['è€å­—å·'],
            '050117': ['ç«é”…åº—', 'ç«é”…'],
            '050119': ['æµ·é²œ'],
            '050120': ['ç´ èœ'],
            '050200': ['å¤–å›½é¤å…'],
            '050201': ['è¥¿é¤å…', 'è¥¿é¤'],
            '050300': ['å¿«é¤'],
            '050301': ['è‚¯å¾·åŸº'],
            '050302': ['éº¦å½“åŠ³'],
            '050303': ['å¿…èƒœå®¢'],
            '050305': ['èŒ¶é¤å…'],
            '050500': ['å’–å•¡', 'å’–å•¡é¦†', 'å’–å•¡åº—'],
            '050501': ['æ˜Ÿå·´å…‹', 'æ˜Ÿå·´å…‹å’–å•¡'],
            '050600': ['å–èŒ¶'],
            '050700': ['å†·é¥®', 'å¥¶èŒ¶', 'é¥®å“'],
            '050800': ['ç³•é¥¼'],
            '050900': ['ç”œå“'],
            '060200|060400': ['è¶…å¸‚', 'ä¾¿åˆ©åº—'],
            '060101': ['è´­ç‰©ä¸­å¿ƒ', 'å•†åœº'],
            '060704': ['æ°´æœ', 'æ°´æœåº—', 'æ°´æœæ‘Š'],
            '060705': ['è”¬èœ', 'èœå¸‚åœº'],
            '090601': ['ä¹°è¯', 'è¯åº—', 'è¯æˆ¿'],
            '100100|100101': ['é…’åº—', 'å®¾é¦†é…’åº—', 'é«˜æ¡£é…’åº—', 'å®¾é¦†', 'æ—…é¦†', 'æ—…åº—'],
            '110000': ['é£æ™¯', 'æ™¯ç‚¹'],
            '080100': ['è¿åŠ¨åœºæ‰€'],
            '080500|080300': ['ä¼‘é—²å¨±ä¹'],
            '080600': ['ç”µå½±é™¢'],
            '071100|090201': ['ç¾å®¹ç¾å‘'],
        };
        const SORTED_KEYWORDS = Object.entries(POI_KEYWORD_MAP)
            .flatMap(([code, keywords]) => keywords.map(kw => ({ keyword: kw, code: code })))
            .sort((a, b) => b.keyword.length - a.keyword.length);

        /**
         * æ ¹æ®ç”¨æˆ·è¾“å…¥æŸ¥æ‰¾å®Œå…¨åŒ¹é…çš„POIç±»å‹ã€‚
         * @param {string} userInput - ç”¨æˆ·è¾“å…¥çš„å…³é”®å­—ã€‚
         * @returns {string|null} - åŒ¹é…åˆ°çš„POIç±»å‹ç ï¼ŒæœªåŒ¹é…åˆ™è¿”å›nullã€‚
         */
        function findPoiTypeByKeyword(userInput) {
            if (!userInput) return null;
            // ä½¿ç”¨å®Œå…¨åŒ¹é…æ¥æŸ¥æ‰¾ï¼Œé¿å…åŒ…å«å…³ç³»å¯¼è‡´çš„é”™è¯¯
            const found = Object.entries(POI_KEYWORD_MAP).find(([code, keywords]) => {
                return keywords.includes(userInput);
            });
            return found ? found[0] : null; // è¿”å›POI Codeï¼Œå¦‚ '080000|080100'
        }
        
        /**
         * POI åˆ—è¡¨å»é‡
         * @param {Array} pois - POIæ•°ç»„
         * @returns {Array} - å»é‡åçš„POIæ•°ç»„
         */
        function deduplicatePois(pois) {
            const seen = new Set();
            return pois.filter(poi => {
                const name = poi.name; // æŒ‰åœ°ç‚¹åç§°å»é‡
                if (seen.has(name)) {
                    return false;
                }
                seen.add(name);
                return true;
            });
        }
        
        /**
         * åˆ‡æ¢æ’åºå¹¶é‡æ–°æ¸²æŸ“åˆ—è¡¨
         * @param {'distance' | 'rating' | 'comprehensive'} sortType
         */
        function applySort(sortType) {
            currentDisplaySort = sortType;
            let listToRender = [];
            
            if (sortType === 'comprehensive') {
                listToRender = cachedSortedResults[comprehensiveSortMode];
            } else {
                listToRender = cachedSortedResults[sortType];
            }
            
            renderPoiList(listToRender);
        }

        /**
         * åˆ‡æ¢ç»¼åˆæ’åºçš„æ¨¡å¼
         */
        function toggleComprehensiveSort() {
            comprehensiveSortMode = comprehensiveSortMode === 'cost_effective' ? 'high_end' : 'cost_effective';
            applySort('comprehensive');
        }

        /**
         * é¢„è®¡ç®—æ‰€æœ‰æ’åº
         */
        function precomputeAndCacheAllSorts(limit) {
            const effectiveLimit = limit > 0 ? limit : originalDistanceSortedPois.length;
            cachedSortedResults.distance = [...originalDistanceSortedPois].slice(0, effectiveLimit);
            cachedSortedResults.rating = sortPoisByRating(originalDistanceSortedPois).slice(0, effectiveLimit);
            cachedSortedResults.cost_effective = sortPoisByComprehensive(originalDistanceSortedPois, 'cost_effective').slice(0, effectiveLimit);
            cachedSortedResults.high_end = sortPoisByComprehensive(originalDistanceSortedPois, 'high_end').slice(0, effectiveLimit);
        }

        /**
         * æ ¹æ®å¥½è¯„ä¼˜å…ˆè§„åˆ™æ’åº
         */
        function sortPoisByRating(pois) {
            // ç¡®ä¿poisæ˜¯æŒ‰è·ç¦»æ’åºçš„
            const sortedByDistance = [...pois].sort((a, b) => a.distance - b.distance);

            const poisWithRanks = sortedByDistance.map(poi => ({
                ...poi,
                distanceRank: Math.floor(poi.distance / 500) + 1,
                rating: parseFloat(poi.business?.rating) || 0,
            }));

            // æŒ‰è¯„åˆ†é™åºï¼Œå¾—åˆ°è¯„åˆ†æ’å
            const sortedByRating = [...poisWithRanks].sort((a, b) => b.rating - a.rating);
            sortedByRating.forEach((p, i) => {
                // åœ¨åŸå§‹æ•°ç»„ä¸­æ‰¾åˆ°å¯¹åº”çš„poiå¹¶è®¾ç½®å…¶æ’å
                const originalPoi = poisWithRanks.find(item => item.id === p.id);
                if(originalPoi) originalPoi.ratingRank = i + 1;
            });

            // Find max ranks for normalization to ensure fair weighting
            const maxRatingRank = poisWithRanks.length;
            let maxDistance = 0;
            poisWithRanks.forEach(p => {
                if (p.distance > maxDistance) maxDistance = p.distance;
            });
            const maxDistanceRank = Math.floor(maxDistance / 500) + 1;

            // Calculate composite score using normalized ranks
            poisWithRanks.forEach(poi => {
                // Normalize ranks to a 0-1 scale. If max rank is 1, all items have same rank, norm is 0.
                const normRating = maxRatingRank > 1 ? (poi.ratingRank - 1) / (maxRatingRank - 1) : 0;
                const normDistance = maxDistanceRank > 1 ? (poi.distanceRank - 1) / (maxDistanceRank - 1) : 0;
                poi.compositeScore = (normRating * 0.8) + (normDistance * 0.2);
            });
            
            // æŒ‰ç»¼åˆå¾—åˆ†å‡åºæ’åº
            poisWithRanks.sort((a, b) => a.compositeScore - b.compositeScore);
            
            return poisWithRanks;
        }

        /**
         * æ ¹æ®ç»¼åˆè§„åˆ™æ’åº
         * @param {Array} pois
         * @param {'cost_effective' | 'high_end'} mode
         */
        function sortPoisByComprehensive(pois, mode) {
            // ç¡®ä¿poisæ˜¯æŒ‰è·ç¦»æ’åºçš„
            const sortedByDistance = [...pois].sort((a, b) => a.distance - b.distance);

            const poisWithRanks = sortedByDistance.map(poi => ({
                ...poi,
                distanceRank: Math.floor(poi.distance / 500) + 1,
                rating: parseFloat(poi.business?.rating) || 0,
                cost: parseFloat(poi.business?.cost) || 0,
            }));

            // è¯„çº§æ’å (é«˜åˆ†åœ¨å‰)
            const sortedByRating = [...poisWithRanks].sort((a, b) => b.rating - a.rating);
            sortedByRating.forEach((p, i) => {
                const originalPoi = poisWithRanks.find(item => item.id === p.id);
                if (originalPoi) originalPoi.ratingRank = i + 1;
            });

            // äººå‡æ¶ˆè´¹æ’å
            const withCost = poisWithRanks.filter(p => p.cost > 0);
            const withoutCost = poisWithRanks.filter(p => p.cost <= 0);
            
            if (mode === 'cost_effective') {
                withCost.sort((a, b) => a.cost - b.cost); // æ€§ä»·æ¯”: ä½æ¶ˆè´¹åœ¨å‰
            } else {
                withCost.sort((a, b) => b.cost - a.cost); // é«˜æ¡£: é«˜æ¶ˆè´¹åœ¨å‰
            }

            withCost.forEach((p, i) => {
                const originalPoi = poisWithRanks.find(item => item.id === p.id);
                if (originalPoi) originalPoi.costRank = i + 1;
            });

            const lowestRank = withCost.length + 1;
            withoutCost.forEach(p => {
                 const originalPoi = poisWithRanks.find(item => item.id === p.id);
                 if (originalPoi) originalPoi.costRank = lowestRank;
            });
            
            // Find max ranks for normalization
            const maxRatingRank = poisWithRanks.length;
            const maxCostRank = poisWithRanks.length; // All items get a costRank
            let maxDistance = 0;
            poisWithRanks.forEach(p => {
                if (p.distance > maxDistance) maxDistance = p.distance;
            });
            const maxDistanceRank = Math.floor(maxDistance / 500) + 1;

            // Define weights for different modes
            const weights = mode === 'cost_effective'
                ? { distance: 0.3, rating: 0.3, cost: 0.4 }
                : { distance: 0, rating: 0.3, cost: 0.7 };
            
            // Calculate composite score using normalized ranks for fairness
            poisWithRanks.forEach(p => {
                // å¯¹äºæ²¡æœ‰æ¶ˆè´¹æˆ–è¯„åˆ†ä¿¡æ¯çš„POIï¼Œåœ¨æ€§ä»·æ¯”å’Œé«˜æ¡£æ’åºä¸­éƒ½åº”è¯¥æ’åœ¨åé¢
                if (p.cost <= 0) {
                    p.compositeScore = Infinity;
                    return;
                }

                if (p.ratingRank && p.costRank) { // Ensure ranks exist
                    // Normalize ranks to a 0-1 scale.
                    const normRating = maxRatingRank > 1 ? (p.ratingRank - 1) / (maxRatingRank - 1) : 0;
                    const normCost = maxCostRank > 1 ? (p.costRank - 1) / (maxCostRank - 1) : 0;
                    const normDistance = maxDistanceRank > 1 ? (p.distanceRank - 1) / (maxDistanceRank - 1) : 0;
                    
                    p.compositeScore = (normDistance * weights.distance) + (normRating * weights.rating) + (normCost * weights.cost);
                } else {
                    p.compositeScore = Infinity; // Put items without full ranks at the end
                }
            });

            // æŒ‰ç»¼åˆå¾—åˆ†å‡åºæ’åº
            poisWithRanks.sort((a, b) => a.compositeScore - b.compositeScore);
            return poisWithRanks;
        }

        /**
         * æ¸²æŸ“POIåˆ—è¡¨åˆ°é¡µé¢
         * @param {Array} pois - è¦æ¸²æŸ“çš„POIæ•°ç»„
         */
        function renderPoiList(pois) {
            const listContainer = document.getElementById('poi-list-container');
            if (!listContainer) return;
            
            let html = '';
            pois.forEach((poi, index) => {
                const displayType = poi.type ? (poi.type.split(';').pop() || 'æœªåˆ†ç±»') : 'æœªåˆ†ç±»';
                const mapUrl = getMapUrl(poi);
                
                html += `
                    <a href="${mapUrl}" target="_blank" class="poi-link">
                        <div class="poi-item">
                            <div class="poi-name">${index + 1}. ${poi.name || 'æœªçŸ¥åœ°ç‚¹'}</div>
                            <div class="poi-info">
                                ğŸ“ è¯¦ç»†åœ°å€: ${buildFullAddress(poi)}<br>
                                ğŸ“ ç”µè¯: ${formatPhoneNumber(poi.business?.tel)}<br>
                                ğŸ·ï¸ ç±»å‹: ${displayType}<br>
                                ğŸ“ ç›´çº¿è·ç¦»: ${poi.distance ? poi.distance + 'ç±³' : 'è·ç¦»æœªçŸ¥'}
                                ${poi.business_area ? '<br>ğŸ¢ å•†åœˆ: ' + poi.business_area : ''}
                                ${poi.business?.rating && parseFloat(poi.business.rating) > 0 ? '<br>â­ è¯„åˆ†: ' + poi.business.rating : ''}
                                ${poi.business?.cost ? '<br>ğŸ’° äººå‡: ' + poi.business.cost + 'å…ƒ' : ''}
                            </div>
                        </div>
                    </a>
                `;
            });
            listContainer.innerHTML = html;
            updateSortButtonStyles();
        }
        
        /**
         * æ ¹æ®è®¾å¤‡ç±»å‹ç”Ÿæˆè·³è½¬é«˜å¾·åœ°å›¾çš„URL
         * @param {object} poi - POIå¯¹è±¡
         * @returns {string} - è·³è½¬é“¾æ¥
         */
        function getMapUrl(poi) {
            const ua = navigator.userAgent.toLowerCase();
            const poiName = encodeURIComponent(poi.name);
            const locationParts = poi.location.split(',');
            const lon = locationParts[0];
            const lat = locationParts[1];

            // åˆ¤æ–­æ˜¯å¦ä¸ºiOSè®¾å¤‡
            if (/iphone|ipad|ipod/.test(ua)) {
                return `iosamap://viewMap?poiname=${poiName}&lat=${lat}&lon=${lon}&dev=0`;
            } 
            
            // åˆ¤æ–­æ˜¯å¦ä¸ºAndroidè®¾å¤‡
            if (/android/.test(ua)) {
                return `androidamap://viewMap?poiname=${poiName}&lat=${lat}&lon=${lon}&dev=0`;
            }

            // å¦‚æœæ˜¯PCæˆ–å…¶ä»–è®¾å¤‡ï¼Œæä¾›ä¸€ä¸ªæŒ‡å‘é«˜å¾·ç½‘é¡µåœ°å›¾çš„é“¾æ¥ä½œä¸ºå¤‡ç”¨
            return `https://www.amap.com/search?query=${poiName}&city=${poi.adcode || ''}`;
        }
        
        /**
         * æ›´æ–°æ’åºæŒ‰é’®çš„æ ·å¼
         */
        function updateSortButtonStyles() {
            const buttons = document.querySelectorAll('.sort-buttons button');
            buttons.forEach(button => {
                if (button.dataset.sort === currentDisplaySort) {
                    button.classList.add('active');
                } else {
                    button.classList.remove('active');
                }
            });
            
            const comprehensiveBtn = document.querySelector('button[data-sort="comprehensive"]');
            if (comprehensiveBtn) {
                comprehensiveBtn.textContent = comprehensiveSortMode === 'cost_effective' ? 'æ€§ä»·æ¯”ç»¼åˆ' : 'é«˜æ¡£ç»¼åˆ';
            }
        }
        
        /**
         * æ ¼å¼åŒ–ç”µè¯å·ç å­—ç¬¦ä¸²
         * - å»é™¤é‡å¤å·ç 
         * - å»é™¤æœ«å°¾çš„ ',0'
         * - ç”¨ ' / ' è¿æ¥å¤šä¸ªå·ç 
         * @param {string} telString - åŸå§‹ç”µè¯å·ç å­—ç¬¦ä¸²
         * @returns {string} æ ¼å¼åŒ–åçš„ç”µè¯å·ç 
         */
        function formatPhoneNumber(telString) {
            if (!telString || typeof telString !== 'string') {
                return 'æš‚æ— ç”µè¯';
            }
            
            const numbers = telString.split(';').map(num => {
                let cleanedNum = num.trim();
                // ä¸“é—¨å¤„ç†APIå¯èƒ½è¿”å›çš„æœ«å°¾ä¸º ',0' çš„æƒ…å†µ
                if (cleanedNum.endsWith(',0')) {
                    cleanedNum = cleanedNum.substring(0, cleanedNum.length - 2);
                }
                return cleanedNum;
            });

            const uniqueNumbers = [...new Set(numbers.filter(n => n))]; // è¿‡æ»¤ç©ºå­—ç¬¦ä¸²å¹¶å»é‡

            if (uniqueNumbers.length === 0) {
                return 'æš‚æ— ç”µè¯';
            }

            return uniqueNumbers.join(' / ');
        }
        
        /**
         * æ„å»ºå®Œæ•´åœ°å€
         */
        function buildFullAddress(poi) {
            const addressParts = [];
            if (poi.cityname) addressParts.push(poi.cityname);
            if (poi.adname) addressParts.push(poi.adname);
            if (poi.address) addressParts.push(poi.address);
            return addressParts.join('') || 'åœ°å€æœªçŸ¥';
        }

        /**
         * å¤„ç†å¹¶æ˜¾ç¤ºä¸­å¿ƒç‚¹POIä¿¡æ¯
         * @param {object} poi - POIå¯¹è±¡
         * @param {boolean} fromCache - æ˜¯å¦æ¥è‡ªç¼“å­˜
         */
        function processLocationPoi(poi, fromCache = false) {
            const location = poi.location;
            if (!location) {
                throw new Error('APIè¿”å›çš„POIä¸­ç¼ºå°‘åæ ‡ä¿¡æ¯ã€‚');
            }
            const [longitude, latitude] = location.split(',');
            document.getElementById('longitude').value = longitude;
            document.getElementById('latitude').value = latitude;
            
            const addressParts = [];
            if (poi.pname) addressParts.push(poi.pname);
            if (poi.cityname && poi.cityname !== poi.pname) addressParts.push(poi.cityname);
            if (poi.adname) addressParts.push(poi.adname);
            if (poi.address) addressParts.push(poi.address);
            const fullAddress = addressParts.join('') || 'åœ°å€æœªçŸ¥';

            const statusDiv = document.getElementById('locationStatus');
            statusDiv.innerHTML = `<div class="success">âœ… åæ ‡è·å–æˆåŠŸï¼<br><strong>ä¸­å¿ƒç‚¹:</strong> ${poi.name}<br><strong>è¯¦ç»†åœ°å€:</strong> ${fullAddress}</div>`;
            document.getElementById('nearby-search-section').style.display = 'block';
        }

        /**
         * æ ¹æ®å…³é”®å­—æœç´¢ä¸­å¿ƒç‚¹åæ ‡
         */
        async function searchLocationByKeyword() {
            const locationKeyword = document.getElementById('locationKeyword').value.trim();
            if (!locationKeyword) {
                alert('è¯·è¾“å…¥ä¸­å¿ƒç‚¹å…³é”®å­—ï¼');
                return;
            }

            const statusDiv = document.getElementById('locationStatus');
            const searchBtn = document.getElementById('searchLocationBtn');
            const nearbySection = document.getElementById('nearby-search-section');
            
            // Invalidate cache and clear previous results
            originalDistanceSortedPois = []; 
            searchCache = {}; // æ¸…ç©ºå‘¨è¾¹æœç´¢ç¼“å­˜
            cachedSortedResults = { distance: [], rating: [], cost_effective: [], high_end: [] };
            document.getElementById('results').innerHTML = ''; 
            nearbySection.style.display = 'none'; // ä¿®æ”¹ä¸­å¿ƒç‚¹æ—¶éšè—ä¸‹æ–¹å†…å®¹

            // æ£€æŸ¥ä¸­å¿ƒç‚¹ç¼“å­˜
            if (locationCache[locationKeyword]) {
                try {
                    processLocationPoi(locationCache[locationKeyword], true);
                } catch (error) {
                    statusDiv.innerHTML = `<div class="error">ç¼“å­˜æ•°æ®å¤„ç†å¤±è´¥: ${error.message}</div>`;
                    delete locationCache[locationKeyword]; // ç§»é™¤é”™è¯¯çš„ç¼“å­˜
                }
                return; // ä»ç¼“å­˜åŠ è½½åç›´æ¥è¿”å›
            }

            searchBtn.disabled = true;
            searchBtn.textContent = 'ğŸ”„ æœç´¢ä¸­...';
            statusDiv.innerHTML = `<div class="loading">æ­£åœ¨é€šè¿‡å…³é”®å­—è·å–åæ ‡...</div>`;
            
            const url = new URL(CONFIG.SCF_URL);
            url.searchParams.set('apiPath', 'v5/place/text'); 
            url.searchParams.set('keywords', locationKeyword);
            url.searchParams.set('page_size', '1');
            url.searchParams.set('page_num', '1');

            locationSearchUrl = url.toString(); // ä¿å­˜URL

            try {
                const response = await fetch(url.toString());
                const data = await response.json();

                if (data.status === '1' && data.pois && data.pois.length > 0) {
                    const poi = data.pois[0];
                    locationCache[locationKeyword] = poi; // å°†æˆåŠŸçš„ç»“æœå­˜å…¥ç¼“å­˜
                    processLocationPoi(poi, false);
                } else {
                     throw new Error(data.info || 'æœªèƒ½æ‰¾åˆ°åŒ¹é…çš„åœ°ç‚¹ã€‚');
                }
            } catch (error) {
                console.error('âŒ ä¸­å¿ƒç‚¹æœç´¢å¤±è´¥:', error);
                statusDiv.innerHTML = `<div class="error">ä¸­å¿ƒç‚¹åæ ‡è·å–å¤±è´¥: ${error.message}</div>`;
                document.getElementById('longitude').value = '';
                document.getElementById('latitude').value = '';
            } finally {
                searchBtn.disabled = false;
                searchBtn.textContent = 'ğŸ“å®šä½ä¸­å¿ƒç‚¹';
            }
        }

        /**
         * æ‰§è¡Œå‘¨è¾¹æœç´¢ (å…¥å£å‡½æ•°)
         */
        async function searchNearby() {
            // æ³¨æ„ï¼šæ­¤å‡½æ•°ç°åœ¨æ˜¯æ‰€æœ‰å‘¨è¾¹æœç´¢çš„ç»Ÿä¸€å…¥å£

            // 1. æ¸…ç†çŠ¶æ€å’Œç¼“å­˜
            originalDistanceSortedPois = [];
            cachedSortedResults = { distance: [], rating: [], cost_effective: [], high_end: [] };
            currentDisplaySort = 'comprehensive';
            comprehensiveSortMode = 'cost_effective';
            
            const resultsDiv = document.getElementById('results');

            // Preserve the height of the results container to prevent page jump on clear
            const currentHeight = resultsDiv.offsetHeight;
            resultsDiv.style.minHeight = `${currentHeight > 0 ? currentHeight : 80}px`;

            // 2. ç«‹å³è®¾ç½®åŠ è½½çŠ¶æ€çš„UI
            resultsDiv.innerHTML = `
                <div class="result-section" id="search-status-section">
                    <h3>ğŸ”„ æ­£åœ¨æœç´¢ï¼Œè¯·ç¨å€™...</h3>
                </div>
            `;

            // æ»šåŠ¨é€»è¾‘å·²ç§»è‡³ displayResults å‡½æ•°æœ«å°¾

            // 4. å°†å®é™…çš„æœç´¢æ“ä½œæ¨è¿Ÿï¼Œä»¥ç¡®ä¿æ»šåŠ¨åŠ¨ç”»æµç•…
            setTimeout(doSearch, 50);
        }

        /**
         * æ ¸å¿ƒçš„æœç´¢æ‰§è¡Œå‡½æ•°
         */
        async function doSearch() {
            const params = getSearchParams();
            const totalPagesToFetch = parseInt(params.page_num, 10);
            let isPoiTypeSearch = false;

            if (!validateParams(params)) {
                return;
            }
            
            const userInput = params.keywords;
            let finalTypes = null;
            let finalKeywords = userInput;

            // æœ€é«˜ä¼˜å…ˆçº§ï¼šæ£€æŸ¥è¾“å…¥æ˜¯å¦ä¸º6ä½POIä»£ç 
            if (/^\d{6}$/.test(userInput)) {
                finalTypes = userInput;
                finalKeywords = '';
                isPoiTypeSearch = true;
            } else {
                // å¸¸è§„é€»è¾‘ï¼šé€šè¿‡å…³é”®å­—æŸ¥æ‰¾POIç±»å‹ (å®Œå…¨åŒ¹é…)
                const matchedPoiType = findPoiTypeByKeyword(userInput);
                if (matchedPoiType) {
                    finalTypes = matchedPoiType;
                    finalKeywords = '';
                    isPoiTypeSearch = true;
                }
            }
            
            // æ ¹æ®æœ€ç»ˆç¡®å®šçš„å‚æ•°ç”Ÿæˆç¼“å­˜é”®
            const cacheKey = JSON.stringify({ 
                types: finalTypes || '', 
                keywords: finalKeywords, 
                location: params.location, 
                radius: params.radius, 
                page_num: totalPagesToFetch 
            });

            // æ£€æŸ¥ç¼“å­˜
            if (searchCache[cacheKey]) {
                const cached = searchCache[cacheKey];
                
                originalDistanceSortedPois = [...cached.aggregatedData.pois].sort((a, b) => a.distance - b.distance);
                precomputeAndCacheAllSorts(params.requested_count);
                
                let listToDisplay;
                if (currentDisplaySort === 'comprehensive') {
                    listToDisplay = cachedSortedResults[comprehensiveSortMode];
                } else {
                    listToDisplay = cachedSortedResults[currentDisplaySort];
                }

                displayResults(cached.aggregatedData, cached.pagesFetched, listToDisplay, cached.rawFetchedCount, cached.isPoiTypeSearch, true);
                return; // å‘½ä¸­ç¼“å­˜ï¼Œç«‹å³è¿”å›
            }
            
            // --- æ ¸å¿ƒæœç´¢é€»è¾‘å¼€å§‹ï¼Œä¸å†å¤„ç†UIåŠ è½½çŠ¶æ€ ---
            const statusH3 = document.querySelector('#search-status-section h3');
            const allPois = [];
            let totalReportedCount = 0;
            let finalStatus = '1';
            let finalInfo = '';
            let finalInfocode = '';
            let lastFetchedPage = 0;
            let pois = [];

            try {
                for (let currentPage = 1; currentPage <= totalPagesToFetch; currentPage++) {
                    lastFetchedPage = currentPage;
                    
                    // æ›´æ–°åŠ è½½æç¤ºä»¥æ˜¾ç¤ºè¿›åº¦
                    if (statusH3) {
                        statusH3.textContent = `ğŸ”„ æ­£åœ¨æœç´¢ï¼Œè¯·ç¨å€™... (${currentPage}/${totalPagesToFetch})`;
                    }

                    const currentParams = {
                        ...params,
                        page_num: currentPage,
                        sortrule: 'distance',
                        types: finalTypes,
                        keywords: finalKeywords
                    };
                    
                    const url = buildRequestUrl(currentParams);

                    const response = await fetch(url);
                    const data = await response.json();
                    
                    if (data.status !== '1') {
                        finalStatus = data.status;
                        finalInfo = data.info;
                        finalInfocode = data.infocode;
                        console.error(`âŒ ç¬¬ ${currentPage} é¡µè¯·æ±‚å¤±è´¥:`, data.info);
                        break; 
                    }
                    
                    if (currentPage === 1) {
                        totalReportedCount = data.count || 0;
                    }
                    
                    pois = data.pois || [];
                    allPois.push(...pois);

                    if (pois.length === 0) {
                        break;
                    }

                    if (currentPage < totalPagesToFetch) {
                        await sleep(150);
                    }
                }

                // ä¿®æ­£é¡µç æ˜¾ç¤ºBug
                let pagesToDisplay = lastFetchedPage;
                if (pois.length === 0 && lastFetchedPage > 0) {
                    pagesToDisplay = lastFetchedPage - 1;
                }

                const rawFetchedCount = allPois.length;
                const uniquePois = deduplicatePois(allPois);

                const aggregatedData = {
                    status: finalStatus,
                    info: finalInfo,
                    infocode: finalInfocode,
                    count: totalReportedCount,
                    pois: uniquePois
                };

                originalDistanceSortedPois = [...uniquePois].sort((a, b) => a.distance - b.distance);
                precomputeAndCacheAllSorts(params.requested_count);
                
                const initialPoisToDisplay = cachedSortedResults[comprehensiveSortMode];

                const dataToCache = {
                    aggregatedData: aggregatedData,
                    pagesFetched: pagesToDisplay,
                    rawFetchedCount: rawFetchedCount,
                    isPoiTypeSearch: isPoiTypeSearch
                };
                searchCache[cacheKey] = dataToCache;
                
                // é¦–æ¬¡åŠ è½½æ—¶ï¼Œæ‰“å°åŸå§‹æ•°æ®
                displayResults(aggregatedData, pagesToDisplay, initialPoisToDisplay, rawFetchedCount, isPoiTypeSearch, false);

            } catch (error) {
                console.error('âŒ è¯·æ±‚å¤±è´¥:', error);
                resultsDiv.innerHTML = `<div class="error">è¯·æ±‚å¤±è´¥: ${error.message}</div>`;
            }
        }
        
        /**
         * è·å–æœç´¢å‚æ•°
         */
        function getSearchParams() {
            const requestedCount = parseInt(document.getElementById('totalCount').value, 10) || 0;
            // è®¡ç®—éœ€è¦è¯·æ±‚çš„é¡µæ•°ï¼Œç¡®ä¿èƒ½è¦†ç›–ç”¨æˆ·è¯·æ±‚çš„æ•°é‡
            const pageNum = requestedCount > 0 ? Math.ceil(requestedCount / 25) : 0;

            return {
                keywords: document.getElementById('keywords').value.trim(),
                location: `${document.getElementById('longitude').value},${document.getElementById('latitude').value}`,
                radius: document.getElementById('radius').value,
                page_num: pageNum,
                page_size: 25, // æ¯é¡µæ•°é‡å›ºå®šä¸º25
                requested_count: requestedCount // æŠŠç”¨æˆ·è¯·æ±‚çš„æ•°é‡ä¹Ÿä¼ å‡ºå»
            };
        }
        
        /**
         * éªŒè¯å‚æ•°
         */
        function validateParams(params) {
            const [lng, lat] = params.location.split(',');
            if (!lng || !lat || isNaN(lng) || isNaN(lat)) {
                alert('ä¸­å¿ƒç‚¹ä½ç½®æœªè·å–ï¼');
                return false;
            }

            if (!params.keywords) {
                alert('è¯·è¾“å…¥å‘¨è¾¹æœç´¢å…³é”®å­—ï¼');
                return false;
            }
            
            return true;
        }
        
        /**
         * æ„å»ºè¯·æ±‚URL
         */
        function buildRequestUrl(params) {
            // åŸºç¡€å‚æ•°ï¼Œä¸åŒ…å«keywordså’Œtypesï¼Œé¿å…æ±¡æŸ“
            const baseParams = {
                location: params.location,
                radius: params.radius,
                page_num: params.page_num,
                page_size: params.page_size,
                sortrule: params.sortrule,
                ...CONFIG.DEFAULT_PARAMS
            };

            const url = new URL(CONFIG.SCF_URL);
            const urlParams = new URLSearchParams(baseParams);

            // å‘Šè¯‰äº‘å‡½æ•°ç›®æ ‡è·¯å¾„
            urlParams.set('apiPath', 'v5/place/around');

            // æ ¹æ®æœ€ç»ˆç¡®å®šçš„å‚æ•°ï¼Œåªæ·»åŠ å…¶ä¸­ä¸€ä¸ªï¼Œç¡®ä¿è¯·æ±‚çº¯ç²¹æ€§
            if (params.types) {
                urlParams.set('types', params.types);
            } else if (params.keywords) {
                urlParams.set('keywords', params.keywords);
            }
            
            url.search = urlParams.toString();
            return url.toString();
        }
        
        /**
         * æ˜¾ç¤ºæœç´¢ç»“æœ
         */
        function displayResults(data, pagesFetched, initialPois, rawFetchedCount, isPoiTypeSearch, isFromCache = false) {
            if (!isFromCache) {
                console.log('ğŸ“‹ åŸå§‹è¿”å›æ•°æ®:', JSON.stringify(data, null, 2));
            }
            
            const resultsDiv = document.getElementById('results');
            const statusSection = document.getElementById('search-status-section');

            // å®‰å…¨æ ¡éªŒï¼Œç¡®ä¿åŠ è½½çŠ¶æ€çš„å®¹å™¨å­˜åœ¨
            if (!statusSection) {
                resultsDiv.innerHTML = '<div class="error">æ¸²æŸ“é”™è¯¯ï¼šæ‰¾ä¸åˆ°çŠ¶æ€æ˜¾ç¤ºåŒºåŸŸã€‚</div>';
                return;
            }

            // æ¸…ç†æ—§çš„POIåˆ—è¡¨å’ŒåŸå§‹æ•°æ®ï¼ˆå¦‚æœæœ‰ï¼‰
            const oldPoiList = document.getElementById('poi-list-section');
            if (oldPoiList) oldPoiList.remove();
            const oldRawData = document.querySelector('.raw-data-section');
            if (oldRawData) oldRawData.remove();

            if (data.status === '1') {
                const displayedCount = initialPois.length;
                const searchMessage = isPoiTypeSearch ? 'ç±»å‹æœç´¢æˆåŠŸ' : 'å…³é”®å­—æœç´¢æˆåŠŸ';
                
                let successMessage = `ä¸ºæ‚¨æ‰¾åˆ° ${displayedCount}ä¸ªåœ°ç‚¹ã€‚`;
                
                // æ›´æ–°çŠ¶æ€åŒºåŸŸä¸º"æˆåŠŸ"
                statusSection.innerHTML = `
                    <h3>âœ… ${searchMessage}</h3>
                    <div class="success">
                       ${successMessage}
                    </div>
                `;
                
                if (initialPois.length > 0) {
                    // åˆ›å»ºå¹¶è¿½åŠ æ–°çš„POIåˆ—è¡¨åŒºåŸŸ
                    const poiListSection = document.createElement('div');
                    poiListSection.id = 'poi-list-section';
                    poiListSection.className = 'result-section';

                    poiListSection.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 style="margin: 0;">ğŸ“ åœ°ç‚¹åˆ—è¡¨</h3>
                            <div class="sort-buttons">
                                <button onclick="applySort('rating')" data-sort="rating" title="ç‚¹å‡»æŒ‰å¥½è¯„åº¦æ’åº" style="font-size: 13px; padding: 5px 12px; margin-top: 0; margin-left: 5px;">å¥½è¯„ä¼˜å…ˆ</button>
                                <button onclick="toggleComprehensiveSort()" data-sort="comprehensive" title="ç‚¹å‡»åˆ‡æ¢ç»¼åˆæ’åºæ¨¡å¼" style="font-size: 13px; padding: 5px 12px; margin-top: 0; margin-left: 5px;">æ€§ä»·æ¯”ç»¼åˆ</button>
                                <button onclick="applySort('distance')" data-sort="distance" title="ç‚¹å‡»æŒ‰è·ç¦»æ’åº" style="font-size: 13px; padding: 5px 12px; margin-top: 0; margin-left: 5px;">è·ç¦»ä¼˜å…ˆ</button>
                            </div>
                        </div>
                        <div id="poi-list-container"></div>
                    `;
                    resultsDiv.appendChild(poiListSection);
                    
                    renderPoiList(initialPois);
                }

            } else { // é”™è¯¯æƒ…å†µ
                const errorMsg = data.info || 'æœªçŸ¥é”™è¯¯';
                const infoCode = data.infocode || '';
                
                console.error('âŒ APIè¿”å›é”™è¯¯:', data);
                
                // æ›´æ–°çŠ¶æ€åŒºåŸŸä¸º"å¤±è´¥"
                statusSection.innerHTML = `
                    <h3>âŒ æœç´¢å¤±è´¥</h3>
                    <div class="error">
                        é”™è¯¯ä¿¡æ¯: ${errorMsg}<br>
                        é”™è¯¯ä»£ç : ${infoCode}
                    </div>
                `;
                
                // åˆ›å»ºå¹¶è¿½åŠ åŸå§‹æ•°æ®åŒºåŸŸ
                const rawDataSection = document.createElement('div');
                rawDataSection.className = 'result-section raw-data-section';
                rawDataSection.innerHTML = `
                    <h3>ğŸ“‹ åŸå§‹è¿”å›æ•°æ®</h3>
                    <div class="raw-data">${JSON.stringify(data, null, 2)}</div>
                `;
                resultsDiv.appendChild(rawDataSection);
            }

            const resultsContainer = document.getElementById('results');
            
            // åœ¨æ‰€æœ‰UIæ›´æ–°å®Œæˆåï¼Œå°†çŠ¶æ€åŒºåŸŸæ»šåŠ¨åˆ°è§†å›¾é¡¶éƒ¨
            const statusSectionToScroll = document.getElementById('search-status-section');
            if (statusSectionToScroll) {
                statusSectionToScroll.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }

            // Reset the container's height so it can shrink if needed
            resultsContainer.style.minHeight = '';
        }
        
        /**
         * å¦‚æœéœ€è¦ï¼Œåˆ™å¹³æ»‘æ»šåŠ¨åˆ°ç»“æœåŒºåŸŸ
         */
        function scrollToResultsIfNeeded() {
            setTimeout(() => {
                document.getElementById('results').scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
        }
        
        // ===== é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ– =====
        document.addEventListener('DOMContentLoaded', function() {
            const locationKeywordInput = document.getElementById('locationKeyword');
            const totalCountInput = document.getElementById('totalCount');
            const increaseBtn = document.getElementById('increaseBtn');
            const decreaseBtn = document.getElementById('decreaseBtn');
            const radiusInput = document.getElementById('radius');

            // å½“ç”¨æˆ·ä¿®æ”¹ä¸­å¿ƒç‚¹å…³é”®å­—æ—¶ï¼Œç«‹å³éšè—ä¸‹æ–¹çš„å‘¨è¾¹æœç´¢åŒºåŸŸå’ŒçŠ¶æ€ä¿¡æ¯
            locationKeywordInput.addEventListener('input', function() {
                document.getElementById('nearby-search-section').style.display = 'none';
                document.getElementById('locationStatus').innerHTML = ''; // åŒæ—¶æ¸…é™¤æ—§çš„çŠ¶æ€ä¿¡æ¯
            });
            
            // ä¸º"ç”Ÿæˆæ•°é‡"è¾“å…¥æ¡†æ·»åŠ äº‹ä»¶ç›‘å¬ï¼Œè‡ªåŠ¨æ ¡å‡†ä¸ºéè´Ÿæ•°
            totalCountInput.addEventListener('change', function() {
                let value = parseInt(this.value, 10);
                if (isNaN(value) || value < 0) {
                    this.value = 0;
                }
            });

            // "ç”Ÿæˆæ•°é‡" å¢åŠ æŒ‰é’®
            increaseBtn.addEventListener('click', function() {
                let currentValue = parseInt(totalCountInput.value, 10) || 0;
                const max = parseInt(totalCountInput.max, 10);
                let newValue = currentValue + 25;
                if (newValue > max) {
                    newValue = max;
                }
                totalCountInput.value = newValue;
            });

            // "ç”Ÿæˆæ•°é‡" å‡å°‘æŒ‰é’®
            decreaseBtn.addEventListener('click', function() {
                let currentValue = parseInt(totalCountInput.value, 10) || 0;
                const min = parseInt(totalCountInput.min, 10);
                let newValue = currentValue - 25;
                if (newValue < min) {
                    newValue = min;
                }
                totalCountInput.value = newValue;
            });

            // æœç´¢åŠå¾„è¾“å…¥æ¡†è‡ªåŠ¨æ ¡å‡†
            radiusInput.addEventListener('change', function() {
                let value = parseInt(this.value, 10);
                const min = parseInt(this.min, 10);
                const max = parseInt(this.max, 10);

                if (isNaN(value)) {
                    this.value = min; // å¦‚æœè¾“å…¥ä¸æ˜¯æ•°å­—ï¼Œåˆ™é‡ç½®ä¸ºæœ€å°å€¼
                    return;
                }
                
                value = Math.floor(value);

                if (value < min) {
                    this.value = min;
                } else if (value > max) {
                    this.value = max;
                } else {
                    this.value = value;
                }
            });

            // ç»‘å®šå›è½¦é”®ä¸ºå‘¨è¾¹æœç´¢
            document.getElementById('keywords').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchNearby();
                }
            });

            // ç»‘å®šä¸­å¿ƒç‚¹å…³é”®å­—æœç´¢çš„å›è½¦é”®
            document.getElementById('locationKeyword').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchLocationByKeyword();
                }
            });

            // "å›åˆ°é¡¶éƒ¨" æŒ‰é’®åŠŸèƒ½
            const scrollTopBtn = document.getElementById('scrollTopBtn');

            // å½“ç”¨æˆ·æ»šåŠ¨é¡µé¢æ—¶ï¼Œå†³å®šæ˜¯å¦æ˜¾ç¤ºæŒ‰é’®
            window.onscroll = function() {
                // ç»“åˆå¤šç§æ–¹å¼è·å–æ»šåŠ¨è·ç¦»ï¼Œä»¥å®ç°æœ€ä½³å…¼å®¹æ€§
                const scrollTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop;
                if (scrollTop > 200) {
                    scrollTopBtn.style.display = "block";
                } else {
                    scrollTopBtn.style.display = "none";
                }
            };

            // å½“ç”¨æˆ·ç‚¹å‡»æŒ‰é’®æ—¶ï¼Œå¹³æ»‘æ»šåŠ¨åˆ°é¡¶éƒ¨
            scrollTopBtn.addEventListener('click', function() {
                window.scrollTo({top: 0, behavior: 'smooth'});
            });
        });
    </script>
</body>
</html>
